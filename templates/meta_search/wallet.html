{% extends "base_user.html" %}
{% load static %}

{% block title %}My Wallet{% endblock %}
{% block page_title %}Wallet{% endblock %}
{% block breadcrumb %}Home / my wallet{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'meta_search/wallet.css' %}" media="(min-width: 768px)">

<style>
  /* ===== Wallet V2 (scoped, mobile-first; no bleed) ===== */
  .walletv2{ --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; }
  .walletv2 *{ box-sizing:border-box; }

  .walletv2 .stack{ display:grid; gap:14px; max-width:760px; margin-inline:auto; }
  .walletv2 .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    box-shadow:0 6px 24px rgba(0,0,0,.08);
  }

  /* Summary card */
  .walletv2 .summary{ padding:16px; }
  .walletv2 .k{ color:var(--muted); font-size:12px; }
  .walletv2 .val{ font-size:28px; font-weight:800; letter-spacing:.2px; }
  .walletv2 .money{ display:flex; align-items:center; gap:10px; margin-top:2px; }
  .walletv2 .eye{ margin-left:auto; border:0; background:transparent; font-size:16px; cursor:pointer; }

  .walletv2 .actions{ display:flex; gap:12px; margin-top:14px; }
  .walletv2 .btn{
    appearance:none; -webkit-appearance:none;
    flex:1 1 0; height:44px; border-radius:16px; font-weight:700; cursor:pointer;
    border:1px solid var(--border); background:#fff; color:#0f172a;
    display:flex; align-items:center; justify-content:center; gap:8px; font-size:14px;
    text-decoration:none;
  }
  .walletv2 .btn.primary{ background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  .walletv2 .btn:active{ transform:translateY(1px); }

  /* Tabs */
  .walletv2 .tabs{ display:flex; gap:22px; padding:12px 6px 0; }
  .walletv2 .tab{ position:relative; color:#9aa3b2; font-weight:600; font-size:14px; background:none; border:0; padding:6px 0; cursor:pointer; }
  .walletv2 .tab.active{ color:#1860ff; }
  .walletv2 .tab.active::after{ content:""; position:absolute; left:0; bottom:-8px; height:2px; width:100%; background:#1860ff; border-radius:999px; }

  /* Transactions */
  .walletv2 .tx-card{ padding:6px; }
  .walletv2 .tx-section[hidden]{ display:none; }
  .walletv2 .tx-head{ font-weight:800; font-size:14px; color:#0f172a; padding:10px 12px 6px; opacity:.9; }

  .walletv2 .tx{ display:flex; align-items:center; gap:10px; padding:12px; cursor:pointer; }
  .walletv2 .tx + .tx{ border-top:1px solid #f1f5f9; }
  .walletv2 .tx .ic{
    height:40px; width:40px; border-radius:999px; display:grid; place-items:center; font-size:18px;
  }
  .walletv2 .tx .meta{ flex:1 1 auto; min-width:0; }
  .walletv2 .tx .title{ font-size:15px; font-weight:700; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .walletv2 .tx .sub{ font-size:12px; color:#9aa3b2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .walletv2 .tx .amt{ font-size:15px; font-weight:700; white-space:nowrap; text-align:right; }
  .walletv2 .amt.plus{ color:#16a34a; }
  .walletv2 .amt.minus{ color:#dc2626; }
  .walletv2 .amt.neutral{ color:#2563eb; }

  @media (min-width: 401px){
    .walletv2 .val{ font-size:32px; }
    .walletv2 .btn{ height:46px; font-size:15px; }
    .walletv2 .tab{ font-size:15px; }
  }
  @media (min-width: 900px){
    .walletv2 .summary{ padding:18px 20px; }
    .walletv2 .tx-card{ padding:8px; }
    .walletv2 .stack{ gap:16px; }
  }

  /* --- Wallet right-edge fix & long-number handling --- */
  .walletv2 .stack{ padding-inline:14px; }
  @media (min-width:480px){ .walletv2 .stack{ padding-inline:18px; } }
  @media (min-width:760px){ .walletv2 .stack{ padding-inline:0; } }

  .walletv2 .summary{ padding-inline:16px 28px; }
  .walletv2 .tx{ min-width:0; }
  .walletv2 .tx .meta{ min-width:0; }

  .walletv2 .tx .amt{
    flex:0 1 45%;
    max-width:45%;
    font-size:clamp(14px,3.6vw,18px);
    line-height:1.15;
    font-variant-numeric:tabular-nums;
    text-align:right;
    white-space:normal;
    overflow-wrap:anywhere;
    align-self:flex-start;
  }

  /* --- Transaction Details Modal (matches your screenshot) --- */
  .tx-modal{ position:fixed; inset:0; display:none; z-index:70; }
  .tx-modal[aria-hidden="false"]{ display:block; }
  .tx-overlay{ position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter:blur(2px); }
  .tx-panel{
    position:relative; margin:24px auto; max-width:520px; background:#fff; border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,.20); padding:18px; border:1px solid #e5e7eb;
  }
  .tx-close{ position:absolute; right:10px; top:10px; background:transparent; border:0; font-size:22px; cursor:pointer; }
  .tx-title{ font-size:22px; font-weight:800; margin:6px 0 14px; color:#0f172a; }

  .tx-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .tx-kind{ display:flex; align-items:center; gap:10px; font-weight:700; color:#0f172a; }
  .tx-kind-ic{ display:grid; place-items:center; width:36px; height:36px; border-radius:999px; background:#e8f7ee; font-size:18px; }
  .tx-date{ color:#64748b; font-weight:600; }

  .tx-amount{ font-size:28px; font-weight:800; margin:10px 0; }
  .tx-amount.plus{ color:#16a34a; } .tx-amount.minus{ color:#dc2626; } .tx-amount.neutral{ color:#2563eb; }

  .tx-status{ display:flex; align-items:center; gap:8px; font-weight:700; color:#0f172a; }
  .tx-status .dot{ width:8px; height:8px; border-radius:999px; background:#16a34a; }
  .tx-status.failed .dot{ background:#ef4444; } .tx-status.pending .dot{ background:#f59e0b; }

  .tx-sep{ height:1px; background:#f1f5f9; margin:14px 0; }
  .tx-field{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
  .tx-k{ color:#64748b; font-weight:600; }
  .tx-v{ color:#0f172a; font-weight:700; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .tx-copy{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; height:30px; padding:0 10px; cursor:pointer; }

  @media (max-width:480px){ .tx-panel{ margin:14px 8px; } }


/* Bring the eye close to the balance */
.walletv2 .summary .money{
  display:flex;
  align-items:center;
  gap:6px;              /* was ~10px; tighter now */
}

.walletv2 .eye{
  margin-left:0 !important;   /* remove the push-to-right */
  border:0;
  background:transparent;
  cursor:pointer;
  line-height:0;
  transform:translateY(1px);  /* subtle optical align with digits */
}

.walletv2 .eye svg{
  width:18px; height:18px;    /* a touch smaller so it hugs nicely */
  display:block;
}



</style>

{% endblock %}

{% block content %}
<section class="walletv2">
  <div class="stack">
    <!-- Summary -->
    <div class="card summary" aria-labelledby="wallet-summary-title">
      <h2 id="wallet-summary-title" class="sr-only">Wallet Summary</h2>

      <div class="stat stat-balance">
        <div class="k">Current Balance</div>
        <div class="money">
          <div class="val currency" id="balance_val">{{ request.user.wallet.cash_eur }}</div>
          <button class="eye" id="toggle_balance" type="button" aria-pressed="false" aria-label="Hide balance" title="Hide balance">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M2 12s3.6-7 10-7 10 7 10 7-3.6 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="1.6" fill="none"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" fill="none"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="stat stat-bonus">
        <div class="k">Trial Bonus</div>
        <div class="money"><div class="val currency">{{ request.user.wallet.bonus_eur }}</div></div>
      </div>

      <div class="actions">
        <a class="btn primary" href="{% url 'deposit' %}">Deposit <span aria-hidden="true">↟</span></a>
        <a class="btn" href="{% url 'withdrawal' %}">Withdraw <span aria-hidden="true">↡</span></a>
      </div>
    </div>

    <!-- Mobile Tabs -->
    <nav class="tabs" role="tablist" aria-label="Filter transactions (mobile)">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">All</button>
      <button class="tab" data-tab="deposit" role="tab" aria-selected="false">Deposit</button>
      <button class="tab" data-tab="withdrawal" role="tab" aria-selected="false">Withdrawal</button>
      <button class="tab" data-tab="commission" role="tab" aria-selected="false">Commission</button>
    </nav>

    <!-- Transactions -->
    <div class="card tx-card" aria-labelledby="tx-title">
      <h2 id="tx-title" class="sr-only">Transactions</h2>

      <!-- desktop pill (hidden by default; shown via JS on >=768px) -->
      <div class="tx-tabs-desktop desktop-only" hidden role="region" aria-label="Filter transactions (desktop)">
        <select id="txd-filter" class="txd-select" aria-controls="txd-panels">
          <option value="all" selected>All</option>
          <option value="deposit">Deposit</option>
          <option value="withdrawal">Withdrawal</option>
          <option value="commission">Commission</option>
        </select>
      </div>

      {% with txns=request.user.wallet.txns.all %}
      <!-- ALL -->
      <section id="txd-panels" class="tx-section" data-tab-panel="all">
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% if all_rows %}
            {% for r in all_rows %}
              {% with kind_lc=r.kind_lc %}
              <li class="tx"
                  data-source="{{ r.source }}"
                  data-id="{{ r.obj_id }}"
                  data-kind="{{ kind_lc }}"
                  data-status="{{ r.status|default:'confirmed' }}"
                  data-created="{{ r.created_at|date:'c' }}"
                  data-amount="{{ r.amount_cents }}"
                  data-bucket="{{ r.bucket }}">
                <div class="ic" style="background:
                     {% if kind_lc == 'deposit' %}#e8f7ee
                     {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}#fee8ea
                     {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}#eef2ff
                     {% else %}#f1f5f9{% endif %};">
                  <span>
                    {% if kind_lc == 'deposit' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% else %}🔁{% endif %}
                  </span>
                </div>
                <div class="meta">
                  <div class="title">{% if kind_lc == 'adjust' %}Commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdrawal{% else %}{{ kind_lc|title }}{% endif %}</div>
                  <div class="sub">
                    {% if kind_lc == 'deposit' %}Added funds{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdraw{% elif kind_lc == 'commission' or kind_lc == 'adjust' %}Commission{% else %}Adjustment{% endif %}
                    • {{ r.created_at|date:"Y-m-d" }}
                  </div>
                </div>
                <div class="amt js-amt" data-cents="{{ r.amount_cents }}" data-kind="{% if kind_lc == 'adjust' %}commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}withdrawal{% else %}{{ kind_lc }}{% endif %}"></div>
              </li>
              {% endwith %}
            {% endfor %}
          {% elif txns %}
            {% for t in txns %}
              {% with kind_lc=t.kind|lower %}
              <li class="tx" data-source="txn" data-id="{{ t.id }}" data-kind="{{ kind_lc }}" data-status="confirmed"
                  data-created="{{ t.created_at|date:'c' }}" data-amount="{{ t.amount_cents }}" data-bucket="{{ t.bucket|lower }}">
                <div class="ic" style="background:
                     {% if kind_lc == 'deposit' %}#e8f7ee
                     {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}#fee8ea
                     {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}#eef2ff
                     {% else %}#f1f5f9{% endif %};">
                  <span>
                    {% if kind_lc == 'deposit' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    {% else %}🔁{% endif %}
                  </span>
                </div>
                <div class="meta">
                  <div class="title">{% if kind_lc == 'adjust' %}Commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdrawal{% else %}{{ t.kind|title }}{% endif %}</div>
                  <div class="sub">
                    {% if kind_lc == 'deposit' %}Added funds{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdraw{% elif kind_lc == 'commission' or kind_lc == 'adjust' %}Commission{% else %}Adjustment{% endif %}
                    • {{ t.created_at|date:"Y-m-d" }}
                  </div>
                </div>
                <div class="amt js-amt" data-cents="{{ t.amount_cents }}" data-kind="{% if kind_lc == 'adjust' %}commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}withdrawal{% else %}{{ kind_lc }}{% endif %}"></div>
              </li>
              {% endwith %}
            {% endfor %}
          {% else %}
            <li class="tx">
              <div class="ic" style="background:#f1f5f9;">💤</div>
              <div class="meta"><div class="title">No Transaction History</div><div class="sub">When you start using your wallet, entries will show here.</div></div>
              <div class="amt neutral">€ 0.00</div>
            </li>
          {% endif %}
        </ul>
      </section>

      <!-- DEPOSIT -->
      <section class="tx-section" data-tab-panel="deposit" hidden>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for t in txns %}
            {% if t.kind|lower == 'deposit' %}
            <li class="tx" data-source="txn" data-id="{{ t.id }}" data-kind="deposit" data-status="confirmed"
                data-created="{{ t.created_at|date:'c' }}" data-amount="{{ t.amount_cents }}" data-bucket="{{ t.bucket|lower }}">
              <div class="ic" style="background:#e8f7ee;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
              <div class="meta"><div class="title">Deposit</div><div class="sub">Added funds • {{ t.created_at|date:"Y-m-d" }}</div></div>
              <div class="amt js-amt" data-cents="{{ t.amount_cents }}" data-kind="deposit"></div>
            </li>
            {% endif %}
          {% empty %}<li class="tx"><div class="meta"><div class="title">No deposits yet</div></div></li>{% endfor %}
        </ul>
      </section>

      <!-- WITHDRAWAL -->
      <section class="tx-section" data-tab-panel="withdrawal" hidden>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for row in withdrawals_combined %}
          <li class="tx" data-source="{{ row.source }}" data-id="{{ row.id }}" data-kind="withdraw" data-status="{{ row.status }}"
              data-created="{{ row.created_at|date:'c' }}" data-amount="{{ row.amount_cents }}" data-bucket="{{ row.bucket|lower }}">
            <div class="ic" style="background:{% if row.status == 'pending' %}#fff7ed{% elif row.status == 'failed' %}#fee2e2{% else %}#fee8ea{% endif %};">
              {% if row.status == 'pending' %}⏳{% elif row.status == 'failed' %}⚠️{% else %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>{% endif %}
            </div>
            <div class="meta">
              <div class="title">{% if row.status == 'pending' %}Withdrawal (Pending){% elif row.status == 'failed' %}Withdrawal (Failed){% else %}Withdrawal{% endif %}</div>
              <div class="sub">{% if row.source == 'request' and row.status == 'pending' %}Requested{% elif row.source == 'request' and row.status == 'failed' %}Request{% else %}Posted{% endif %} • {{ row.created_at|date:"Y-m-d" }}</div>
            </div>
            <div class="amt js-amt" data-cents="{{ row.amount_cents }}" data-kind="withdrawal"></div>
          </li>
          {% empty %}<li class="tx"><div class="meta"><div class="title">No withdrawals yet</div></div></li>{% endfor %}
        </ul>
      </section>

      <!-- COMMISSION -->
      <section class="tx-section" data-tab-panel="commission" hidden>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for t in txns %}
            {% with kind_lc=t.kind|lower %}
            {% if kind_lc == 'commission' or kind_lc == 'adjust' %}
              <li class="tx" data-source="txn" data-id="{{ t.id }}" data-kind="commission" data-status="confirmed"
                  data-created="{{ t.created_at|date:'c' }}" data-amount="{{ t.amount_cents }}" data-bucket="{{ t.bucket|lower }}">
                <div class="ic" style="background:#eef2ff;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div class="meta"><div class="title">Commission</div><div class="sub">Payment • {{ t.created_at|date:"Y-m-d" }}</div></div>
                <div class="amt js-amt" data-cents="{{ t.amount_cents }}" data-kind="commission"></div>
              </li>
            {% endif %}{% endwith %}
          {% empty %}<li class="tx"><div class="meta"><div class="title">No commissions yet</div></div></li>{% endfor %}
        </ul>
      </section>
      {% endwith %}
    </div>
  </div>

  <!-- Modal -->
  <div id="tx-modal" class="tx-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="tx-overlay" data-close></div>
    <div class="tx-panel" role="document">
      <button class="tx-close" type="button" aria-label="Close" data-close>×</button>
      <h3 class="tx-title">Transaction Details</h3>
      <div class="tx-row tx-top">
        <div class="tx-kind"><span class="tx-kind-ic" id="m_ic"></span><span id="m_kind">—</span></div>
        <div class="tx-date" id="m_date">—</div>
      </div>
      <div class="tx-amount" id="m_amount">€0.00</div>
      <div class="tx-status" id="m_status"><span class="dot"></span><span id="m_status_txt">Confirmed</span></div>
      <div class="tx-sep"></div>
      <div class="tx-field"><div class="tx-k">Transaction ID</div><div class="tx-v"><span id="m_id">#—</span><button class="tx-copy" type="button" id="m_copy" title="Copy ID">📋</button></div></div>
      <div class="tx-sep"></div>
      <div class="tx-field"><div class="tx-k">Description</div><div class="tx-v" id="m_desc">—</div></div>
      <div class="tx-sep"></div>
      <div class="tx-field"><div class="tx-k">State</div><div class="tx-v" id="m_state">—</div></div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}

<script>
/* Amount formatting + mobile tabs */
(function(){
  function fmtEUR(cents){
    const neg = cents < 0; const n = Math.abs(cents)/100;
    const s = n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    return (neg?'-':'+')+'€'+s;
  }
  document.querySelectorAll('.walletv2 .js-amt').forEach(el=>{
    const cents = parseInt(el.getAttribute('data-cents')||'0',10);
    const kind  = (el.getAttribute('data-kind')||'').toLowerCase();
    el.textContent = fmtEUR(cents);
    el.classList.remove('plus','minus','neutral');
    if (cents < 0 || kind === 'withdrawal') el.classList.add('minus');
    else if (kind === 'deposit') el.classList.add('plus');
    else el.classList.add('neutral');
  });

  const tabs = document.querySelectorAll('.walletv2 .tabs .tab');
  const panels = document.querySelectorAll('.walletv2 .tx-section');
  function show(key){ panels.forEach(p=>p.hidden = p.getAttribute('data-tab-panel') !== key); }
  tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>{x.classList.remove('active');x.setAttribute('aria-selected','false');});
    t.classList.add('active'); t.setAttribute('aria-selected','true'); show(t.dataset.tab); }));
  show('all');
})();
</script>

<script>
/* Desktop/Tablet: grid table + DROPDOWN filter — View button lives in Status cell */
(function(){
  if (!window.matchMedia('(min-width:768px)').matches) return;

  const root = document.querySelector('.walletv2'); if (!root) return;
  const select = root.querySelector('#txd-filter');

  const allSections = [...root.querySelectorAll('.tx-section')];
  function show(key){ allSections.forEach(s=>s.hidden = s.getAttribute('data-tab-panel') !== key); }
  if (select){
    select.addEventListener('change', ()=> show(select.value));
    show(select.value || 'all');
  }

  /* 5-column header (Name, Date, Amount, State, Status) */
  function ensureHeader(list){
    if (!list.classList.contains('desk-table')){
      list.classList.add('desk-table');
      const hdr = document.createElement('div');
      hdr.className = 'desk-header';
      hdr.innerHTML = '<div>Name</div><div>Date</div><div>Amount</div><div>State</div><div>Status</div>';
      list.prepend(hdr);
    }
  }

  function enhance(list){
    list.querySelectorAll(':scope > .tx').forEach(li=>{
      if (li.classList.contains('desk-row')) return;
      li.classList.add('desk-row');

      const ds = li.dataset;
      const nameCell=document.createElement('div');
      const dateCell=document.createElement('div');
      const amountCell=document.createElement('div');
      const stateCell=document.createElement('div');
      const statusCell=document.createElement('div'); // will hold status + view

      function fmtDate(iso){ if(!iso)return ''; const d=new Date(iso); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(); }
      function stateChip(k){
        k=(k||'').toLowerCase();
        if(k==='deposit') return ['state-chip state-dep','Deposit'];
        if(/withdraw|withdrawal|payout|cash_out/.test(k)) return ['state-chip state-with','Withdraw'];
        if(/commission|adjust/.test(k)) return ['state-chip state-pay','Payment'];
        return ['state-chip','—'];
      }

      // Name cell (icon + title + sub)
      const ic = li.querySelector('.ic'); const title=li.querySelector('.title')?.textContent||'—';
      const sub  = li.querySelector('.sub')?.textContent||'';
      nameCell.className='name-wrap';
      nameCell.innerHTML = `<div class="ic">${ic?ic.innerHTML:''}</div><div><div class="title">${title}</div><div class="sub">${sub}</div></div>`;

      // Date
      dateCell.textContent = fmtDate(ds.created);

      // Amount (move existing .amt node in here)
      const amt = li.querySelector('.amt'); if (amt) amountCell.appendChild(amt);

      // State chip
      const [cls,txt] = stateChip(ds.kind);
      const chip=document.createElement('span'); chip.className=cls; chip.textContent=txt;
      stateCell.appendChild(chip);

      // Status + View together
      const st=(ds.status||'confirmed').toLowerCase();
      const statusWrap=document.createElement('span');
      statusWrap.className='status';
      statusWrap.innerHTML = `<span class="dot ${st==='failed'?'bad':'ok'}"></span>${st==='failed'?'Failed':(st==='pending'?'Pending':'Confirmed')}`;

      const btn=document.createElement('button');
      btn.type='button'; btn.className='view'; btn.textContent='View';
      btn.addEventListener('click',()=>li.dispatchEvent(new MouseEvent('click',{bubbles:true})));

      statusCell.appendChild(statusWrap);
      statusCell.appendChild(btn);  // <-- lives in the same column

      // Rebuild row (5 cells)
      li.innerHTML='';
      li.appendChild(nameCell);
      li.appendChild(dateCell);
      li.appendChild(amountCell);
      li.appendChild(stateCell);
      li.appendChild(statusCell);
    });
  }

  root.querySelectorAll('.tx-list').forEach(list=>{ ensureHeader(list); enhance(list); });
})();
</script>

<script>
/* Modal (shared) */
(function(){
  const modal=document.getElementById('tx-modal'); if(!modal) return;
  const mIc=document.getElementById('m_ic'), mKind=document.getElementById('m_kind'), mDate=document.getElementById('m_date'),
        mAmt=document.getElementById('m_amount'), mStatus=document.getElementById('m_status'),
        mId=document.getElementById('m_id'), mCopy=document.getElementById('m_copy'), mDesc=document.getElementById('m_desc'), mState=document.getElementById('m_state');

  function fmtEUR(c){ const n=Math.abs(c)/100; const s=n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); return (c<0?'-':'+')+'€'+s; }
  function fmtDate(iso){ if(!iso)return ''; const d=new Date(iso); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(); }

  function svgFor(k){
    k=(k||'').toLowerCase();
    if(k==='deposit') return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    if(/withdraw|payout|cash_out|withdrawal/.test(k)) return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    if(/commission|adjust/.test(k)) return '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    return '🔁';
  }
  function bgFor(k,st){
    k=(k||'').toLowerCase(); st=(st||'confirmed').toLowerCase();
    if(k==='deposit') return '#e8f7ee';
    if(/commission|adjust/.test(k)) return '#eef2ff';
    if(/withdraw|payout|cash_out|withdrawal/.test(k)){ if(st==='pending') return '#fff7ed'; if(st==='failed') return '#fee2e2'; return '#fee8ea'; }
    return '#f1f5f9';
  }
  function openM(){ modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
  function closeM(){ modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
  modal.addEventListener('click',e=>{ if(e.target.hasAttribute('data-close')) closeM(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeM(); });
  mCopy.addEventListener('click',()=>{ const id=(document.getElementById('m_id').textContent||'').replace(/^#/,''); navigator.clipboard?.writeText(id); });

  document.querySelector('.walletv2')?.addEventListener('click',e=>{
    const li=e.target.closest('.tx'); if(!li) return;
    const ds=li.dataset;
    mIc.style.background = bgFor(ds.kind, ds.status);
    mIc.innerHTML = svgFor(ds.kind);
    mKind.textContent = (/adjust/.test(ds.kind||''))?'Commission':(/withdraw|payout|cash_out|withdrawal/.test(ds.kind||'')?'Withdrawal':(ds.kind||'').replace(/^./,c=>c.toUpperCase()));
    mDate.textContent = fmtDate(ds.created);
    mAmt.textContent = fmtEUR(parseInt(ds.amount||'0',10));
    const s=(ds.status||'confirmed').toLowerCase();
    mStatus.classList.remove('failed','pending');
    document.getElementById('m_status_txt').textContent = s==='failed'?'Failed':(s==='pending'?'Pending':'Confirmed');
    if(s==='failed') mStatus.classList.add('failed'); else if(s==='pending') mStatus.classList.add('pending');
    document.getElementById('m_id').textContent = ds.id ? ('#'+ds.id) : '#—';
    mDesc.textContent = (/deposit/i.test(ds.kind||''))?'Added fund to wallet':(/withdraw|payout|cash_out|withdrawal/i.test(ds.kind||''))?'Withdraw':(/commission|adjust/i.test(ds.kind||''))?'Commission':'Adjustment';
    mState.textContent = mKind.textContent;
    openM();
  });
})();
</script>

<script>
/* Balance privacy toggle (persisted) */
(function(){
  const val = document.getElementById('balance_val');
  const btn = document.getElementById('toggle_balance');
  if (!val || !btn) return;
  const LS_KEY = 'walletv2_hide_balance';
  const eyeOpen = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M2 12s3.6-7 10-7 10 7 10 7-3.6 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="1.6" fill="none"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" fill="none"/></svg>`;
  const eyeClosed = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M2 12s3.6-7 10-7 10 7 10 7-3.6 7-10 7S2 12 2 12Z" stroke="currentColor" stroke-width="1.6" fill="none"/><path d="M4 20 20 4" stroke="currentColor" stroke-width="1.6"/></svg>`;
  const real = val.textContent.trim();
  let hidden = localStorage.getItem(LS_KEY) === '1';
  function render(){
    if (hidden){ val.textContent='••••••'; btn.setAttribute('aria-pressed','true'); btn.setAttribute('aria-label','Show balance'); btn.title='Show balance'; btn.innerHTML=eyeClosed; }
    else{ val.textContent=real; btn.setAttribute('aria-pressed','false'); btn.setAttribute('aria-label','Hide balance'); btn.title='Hide balance'; btn.innerHTML=eyeOpen; }
  }
  btn.addEventListener('click', ()=>{ hidden=!hidden; localStorage.setItem(LS_KEY, hidden?'1':'0'); render(); });
  render();
})();
</script>
{% endblock %}
