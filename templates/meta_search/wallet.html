{% extends "base_user.html" %}
{% load static %}

{% block title %}My Wallet{% endblock %}
{% block page_title %}üíº Wallet{% endblock %}
{% block breadcrumb %}Home / my wallet{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'meta_search/wallet.css' %}">
<style>
  /* ===== Wallet V2 (scoped, mobile-first; no bleed) ===== */
  .walletv2{ --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; }
  .walletv2 *{ box-sizing:border-box; }

  .walletv2 .stack{ display:grid; gap:14px; max-width:760px; margin-inline:auto; }
  .walletv2 .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    box-shadow:0 6px 24px rgba(0,0,0,.08);
  }

  /* Summary card */
  .walletv2 .summary{ padding:16px; }
  .walletv2 .k{ color:var(--muted); font-size:12px; }
  .walletv2 .val{ font-size:28px; font-weight:800; letter-spacing:.2px; }
  .walletv2 .money{ display:flex; align-items:center; gap:10px; margin-top:2px; }
  .walletv2 .eye{ margin-left:auto; border:0; background:transparent; font-size:16px; cursor:pointer; }

  .walletv2 .actions{ display:flex; gap:12px; margin-top:14px; }
  .walletv2 .btn{
    appearance:none; -webkit-appearance:none;
    flex:1 1 0; height:44px; border-radius:16px; font-weight:700; cursor:pointer;
    border:1px solid var(--border); background:#fff; color:#0f172a;
    display:flex; align-items:center; justify-content:center; gap:8px; font-size:14px;
    text-decoration:none;
  }
  .walletv2 .btn.primary{ background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  .walletv2 .btn:active{ transform:translateY(1px); }

  /* Tabs */
  .walletv2 .tabs{ display:flex; gap:22px; padding:12px 6px 0; }
  .walletv2 .tab{ position:relative; color:#9aa3b2; font-weight:600; font-size:14px; background:none; border:0; padding:6px 0; cursor:pointer; }
  .walletv2 .tab.active{ color:#1860ff; }
  .walletv2 .tab.active::after{ content:""; position:absolute; left:0; bottom:-8px; height:2px; width:100%; background:#1860ff; border-radius:999px; }

  /* Transactions */
  .walletv2 .tx-card{ padding:6px; }
  .walletv2 .tx-section[hidden]{ display:none; }
  .walletv2 .tx-head{ font-weight:800; font-size:14px; color:#0f172a; padding:10px 12px 6px; opacity:.9; }

  .walletv2 .tx{ display:flex; align-items:center; gap:10px; padding:12px; cursor:pointer; }
  .walletv2 .tx + .tx{ border-top:1px solid #f1f5f9; }
  .walletv2 .tx .ic{
    height:40px; width:40px; border-radius:999px; display:grid; place-items:center; font-size:18px;
  }
  .walletv2 .tx .meta{ flex:1 1 auto; min-width:0; }
  .walletv2 .tx .title{ font-size:15px; font-weight:700; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .walletv2 .tx .sub{ font-size:12px; color:#9aa3b2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .walletv2 .tx .amt{ font-size:15px; font-weight:700; white-space:nowrap; text-align:right; }
  .walletv2 .amt.plus{ color:#16a34a; }
  .walletv2 .amt.minus{ color:#dc2626; }
  .walletv2 .amt.neutral{ color:#2563eb; }

  @media (min-width: 401px){
    .walletv2 .val{ font-size:32px; }
    .walletv2 .btn{ height:46px; font-size:15px; }
    .walletv2 .tab{ font-size:15px; }
  }
  @media (min-width: 900px){
    .walletv2 .summary{ padding:18px 20px; }
    .walletv2 .tx-card{ padding:8px; }
    .walletv2 .stack{ gap:16px; }
  }

  /* --- Wallet right-edge fix & long-number handling --- */
  .walletv2 .stack{ padding-inline:14px; }
  @media (min-width:480px){ .walletv2 .stack{ padding-inline:18px; } }
  @media (min-width:760px){ .walletv2 .stack{ padding-inline:0; } }

  .walletv2 .summary{ padding-inline:16px 28px; }
  .walletv2 .tx{ min-width:0; }
  .walletv2 .tx .meta{ min-width:0; }

  .walletv2 .tx .amt{
    flex:0 1 45%;
    max-width:45%;
    font-size:clamp(14px,3.6vw,18px);
    line-height:1.15;
    font-variant-numeric:tabular-nums;
    text-align:right;
    white-space:normal;
    overflow-wrap:anywhere;
    align-self:flex-start;
  }

  /* --- Transaction Details Modal (matches your screenshot) --- */
  .tx-modal{ position:fixed; inset:0; display:none; z-index:70; }
  .tx-modal[aria-hidden="false"]{ display:block; }
  .tx-overlay{ position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter:blur(2px); }
  .tx-panel{
    position:relative; margin:24px auto; max-width:520px; background:#fff; border-radius:18px;
    box-shadow:0 18px 50px rgba(0,0,0,.20); padding:18px; border:1px solid #e5e7eb;
  }
  .tx-close{ position:absolute; right:10px; top:10px; background:transparent; border:0; font-size:22px; cursor:pointer; }
  .tx-title{ font-size:22px; font-weight:800; margin:6px 0 14px; color:#0f172a; }

  .tx-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .tx-kind{ display:flex; align-items:center; gap:10px; font-weight:700; color:#0f172a; }
  .tx-kind-ic{ display:grid; place-items:center; width:36px; height:36px; border-radius:999px; background:#e8f7ee; font-size:18px; }
  .tx-date{ color:#64748b; font-weight:600; }

  .tx-amount{ font-size:28px; font-weight:800; margin:10px 0; }
  .tx-amount.plus{ color:#16a34a; } .tx-amount.minus{ color:#dc2626; } .tx-amount.neutral{ color:#2563eb; }

  .tx-status{ display:flex; align-items:center; gap:8px; font-weight:700; color:#0f172a; }
  .tx-status .dot{ width:8px; height:8px; border-radius:999px; background:#16a34a; }
  .tx-status.failed .dot{ background:#ef4444; } .tx-status.pending .dot{ background:#f59e0b; }

  .tx-sep{ height:1px; background:#f1f5f9; margin:14px 0; }
  .tx-field{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
  .tx-k{ color:#64748b; font-weight:600; }
  .tx-v{ color:#0f172a; font-weight:700; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .tx-copy{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; height:30px; padding:0 10px; cursor:pointer; }

  @media (max-width:480px){ .tx-panel{ margin:14px 8px; } }

</style>
{% endblock %}

{% block content %}
<section class="walletv2">
  <div class="stack">
    <!-- Summary -->
    <div class="card summary" aria-labelledby="wallet-summary-title">
      <h2 id="wallet-summary-title" class="sr-only">Wallet Summary</h2>

      <div>
        <div class="k">Current Balance</div>
        <div class="money">
          <div class="val currency js-money" data-value="{{ request.user.wallet.cash_eur }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <button class="eye" type="button" title="Show/Hide" aria-label="Show or hide balance"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.42012 12.7132C2.28394 12.4975 2.21584 12.3897 2.17772 12.2234C2.14909 12.0985 2.14909 11.9015 2.17772 11.7766C2.21584 11.6103 2.28394 11.5025 2.42012 11.2868C3.54553 9.50484 6.8954 5 12.0004 5C17.1054 5 20.4553 9.50484 21.5807 11.2868C21.7169 11.5025 21.785 11.6103 21.8231 11.7766C21.8517 11.9015 21.8517 12.0985 21.8231 12.2234C21.785 12.3897 21.7169 12.4975 21.5807 12.7132C20.4553 14.4952 17.1054 19 12.0004 19C6.8954 19 3.54553 14.4952 2.42012 12.7132Z" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12.0004 15C13.6573 15 15.0004 13.6569 15.0004 12C15.0004 10.3431 13.6573 9 12.0004 9C10.3435 9 9.0004 10.3431 9.0004 12C9.0004 13.6569 10.3435 15 12.0004 15Z" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>

         Ô∏è</button>
        </div>
      </div>

      <div class="section" style="margin-top:14px;">
        <div class="k">Trial Bonus</div>
        <div class="money">
          <div class="val currency js-money" data-value="{{ request.user.wallet.bonus_eur }}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
          <button class="eye" type="button" title="Show/Hide" aria-label="Show or hide bonus"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.42012 12.7132C2.28394 12.4975 2.21584 12.3897 2.17772 12.2234C2.14909 12.0985 2.14909 11.9015 2.17772 11.7766C2.21584 11.6103 2.28394 11.5025 2.42012 11.2868C3.54553 9.50484 6.8954 5 12.0004 5C17.1054 5 20.4553 9.50484 21.5807 11.2868C21.7169 11.5025 21.785 11.6103 21.8231 11.7766C21.8517 11.9015 21.8517 12.0985 21.8231 12.2234C21.785 12.3897 21.7169 12.4975 21.5807 12.7132C20.4553 14.4952 17.1054 19 12.0004 19C6.8954 19 3.54553 14.4952 2.42012 12.7132Z" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12.0004 15C13.6573 15 15.0004 13.6569 15.0004 12C15.0004 10.3431 13.6573 9 12.0004 9C10.3435 9 9.0004 10.3431 9.0004 12C9.0004 13.6569 10.3435 15 12.0004 15Z" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        Ô∏è</button>
        </div>
      </div>

      <div class="actions">
        <a class="btn primary" href="{% url 'deposit' %}">Deposit <span aria-hidden="true">‚Üü</span></a>
        <a class="btn" href="{% url 'withdrawal' %}">Withdraw <span aria-hidden="true">‚Ü°</span></a>
      </div>
    </div>

    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Filter transactions">
      <button class="tab active" data-tab="all" role="tab" aria-selected="true">All</button>
      <button class="tab" data-tab="deposit" role="tab" aria-selected="false">Deposit</button>
      <button class="tab" data-tab="withdrawal" role="tab" aria-selected="false">Withdrawal</button>
      <button class="tab" data-tab="commission" role="tab" aria-selected="false">Commission</button>
    </nav>

    <!-- Transactions -->
    <div class="card tx-card" aria-labelledby="tx-title">
      <h2 id="tx-title" class="sr-only">Transactions</h2>

      {% with txns=request.user.wallet.txns.all %}
      <!-- ALL (uses merged newest-first stream via all_rows) -->
      <section class="tx-section" data-tab-panel="all">
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% if all_rows %}
            {% for r in all_rows %}
              {% with kind_lc=r.kind_lc %}
              <li class="tx"
                  data-source="{{ r.source }}"
                  data-id="{{ r.obj_id }}"
                  data-kind="{{ kind_lc }}"
                  data-status="{{ r.status|default:'confirmed' }}"
                  data-created="{{ r.created_at|date:'c' }}"
                  data-amount="{{ r.amount_cents }}"
                  data-bucket="{{ r.bucket }}">
                <div class="ic" style="background:
                     {% if kind_lc == 'deposit' %}#e8f7ee
                     {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}#fee8ea
                     {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}#eef2ff
                     {% else %}#f1f5f9{% endif %};">
                  <span>
                    {% if kind_lc == 'deposit' %}‚¨ÜÔ∏è
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}‚ÜôÔ∏è
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    {% else %}üîÅ{% endif %}
                  </span>
                </div>
                <div class="meta">
                  <div class="title">
                    {% if kind_lc == 'adjust' %}Commission
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdrawal
                    {% else %}{{ kind_lc|title }}{% endif %}
                  </div>
                  <div class="sub">
                    {% if kind_lc == 'deposit' %}Added funds
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdraw
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}Commission
                    {% else %}Adjustment{% endif %}
                    ‚Ä¢ {{ r.created_at|date:"Y-m-d" }}
                  </div>
                </div>
                <div class="amt js-amt"
                     data-cents="{{ r.amount_cents }}"
                     data-kind="{% if kind_lc == 'adjust' %}commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}withdrawal{% else %}{{ kind_lc }}{% endif %}"></div>
              </li>
              {% endwith %}
            {% endfor %}

          {% elif txns %}
            {# Fallback: DB txns on-ly #}
            {% for t in txns %}
              {% with kind_lc=t.kind|lower %}
              <li class="tx"
                  data-source="txn"
                  data-id="{{ t.id }}"
                  data-kind="{{ kind_lc }}"
                  data-status="confirmed"
                  data-created="{{ t.created_at|date:'c' }}"
                  data-amount="{{ t.amount_cents }}"
                  data-bucket="{{ t.bucket|lower }}">
                <div class="ic" style="background:
                     {% if kind_lc == 'deposit' %}#e8f7ee
                     {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}#fee8ea
                     {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}#eef2ff
                     {% else %}#f1f5f9{% endif %};">
                  <span>
                    {% if kind_lc == 'deposit' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %} <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
                    {% else %}üîÅ{% endif %}
                  </span>
                </div>
                <div class="meta">
                  <div class="title">
                    {% if kind_lc == 'adjust' %}Commission
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdrawal
                    {% else %}{{ t.kind|title }}{% endif %}
                  </div>
                  <div class="sub">
                    {% if kind_lc == 'deposit' %}Added funds
                    {% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}Withdraw
                    {% elif kind_lc == 'commission' or kind_lc == 'adjust' %}Commission
                    {% else %}Adjustment{% endif %}
                    ‚Ä¢ {{ t.created_at|date:"Y-m-d" }}
                  </div>
                </div>
                <div class="amt js-amt"
                     data-cents="{{ t.amount_cents }}"
                     data-kind="{% if kind_lc == 'adjust' %}commission{% elif kind_lc == 'withdraw' or kind_lc == 'payout' or kind_lc == 'cash_out' %}withdrawal{% else %}{{ kind_lc }}{% endif %}"></div>
              </li>
              {% endwith %}
            {% endfor %}

          {% else %}
            <li class="tx">
              <div class="ic" style="background:#f1f5f9;">üí§</div>
              <div class="meta">
                <div class="title">No Transaction History</div>
                <div class="sub">When you start using your wallet, entries will show here.</div>
              </div>
              <div class="amt neutral">‚Ç¨ 0.00</div>
            </li>
          {% endif %}
        </ul>
      </section>

      <!-- DEPOSIT -->
      <section class="tx-section" data-tab-panel="deposit" hidden>
        <div class="tx-head">Deposits</div>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for t in txns %}
            {% if t.kind|lower == 'deposit' %}
              <li class="tx"
                  data-source="txn"
                  data-id="{{ t.id }}"
                  data-kind="deposit"
                  data-status="confirmed"
                  data-created="{{ t.created_at|date:'c' }}"
                  data-amount="{{ t.amount_cents }}"
                  data-bucket="{{ t.bucket|lower }}">
                <div class="ic" style="background:#e8f7ee;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>Ô∏è</div>
                <div class="meta">
                  <div class="title">Deposit</div>
                  <div class="sub">Added funds ‚Ä¢ {{ t.created_at|date:"Y-m-d" }}</div>
                </div>
                <div class="amt js-amt" data-cents="{{ t.amount_cents }}" data-kind="deposit"></div>
              </li>
            {% endif %}
          {% empty %}
            <li class="tx"><div class="meta"><div class="title">No deposits yet</div></div></li>
          {% endfor %}
        </ul>
      </section>

      <!-- WITHDRAWAL -->
      <section class="tx-section" data-tab-panel="withdrawal" hidden>
        <div class="tx-head">Withdrawals</div>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for row in withdrawals_combined %}
            <li class="tx"
                data-source="{{ row.source }}"
                data-id="{{ row.id }}"
                data-kind="withdraw"
                data-status="{{ row.status }}"
                data-created="{{ row.created_at|date:'c' }}"
                data-amount="{{ row.amount_cents }}"
                data-bucket="{{ row.bucket|lower }}">
              <div class="ic"
                   style="background:
                     {% if row.status == 'pending' %}#fff7ed
                     {% elif row.status == 'failed' %}#fee2e2
                     {% else %}#fee8ea
                     {% endif %};">
                <span>
                  {% if row.status == 'pending' %}‚è≥
                  {% elif row.status == 'failed' %}‚ö†Ô∏è
                  {% else %} <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 18H14M6 18V10" stroke="#D32F2F" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                  {% endif %}
                </span>
              </div>

              <div class="meta">
                <div class="title">
                  {% if row.status == 'pending' %}Withdrawal (Pending)
                  {% elif row.status == 'failed' %}Withdrawal (Failed)
                  {% else %}Withdrawal
                  {% endif %}
                </div>
                <div class="sub">
                  {% if row.source == 'request' and row.status == 'pending' %}Requested
                  {% elif row.source == 'request' and row.status == 'failed' %}Request
                  {% else %}Posted
                  {% endif %}
                  ‚Ä¢ {{ row.created_at|date:"Y-m-d" }}
                </div>
              </div>

              <div class="amt js-amt"
                   data-cents="{{ row.amount_cents }}"
                   data-kind="withdrawal"></div>
            </li>
          {% empty %}
            <li class="tx">
              <div class="ic" style="background:#f1f5f9;">üí§</div>
              <div class="meta">
                <div class="title">No withdrawals yet</div>
                <div class="sub">When you make a withdrawal, it will appear here.</div>
              </div>
              <div class="amt neutral">‚Ç¨ 0.00</div>
            </li>
          {% endfor %}
        </ul>
      </section>

      <!-- COMMISSION -->
      <section class="tx-section" data-tab-panel="commission" hidden>
        <div class="tx-head">Commissions</div>
        <ul class="tx-list" style="list-style:none; padding:0; margin:0;">
          {% for t in txns %}
            {% with kind_lc=t.kind|lower %}
            {% if kind_lc == 'commission' or kind_lc == 'adjust' %}
              <li class="tx"
                  data-source="txn"
                  data-id="{{ t.id }}"
                  data-kind="commission"
                  data-status="confirmed"
                  data-created="{{ t.created_at|date:'c' }}"
                  data-amount="{{ t.amount_cents }}"
                  data-bucket="{{ t.bucket|lower }}">
                <div class="ic" style="background:#eef2ff;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#007BFF" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                     </svg>
                   </div>

                 <div class="meta">
                  <div class="title">Commission</div>
                  <div class="sub">Payment ‚Ä¢ {{ t.created_at|date:"Y-m-d" }}</div>
                </div>
                <div class="amt js-amt" data-cents="{{ t.amount_cents }}" data-kind="commission"></div>
              </li>
            {% endif %}
            {% endwith %}
          {% empty %}
            <li class="tx"><div class="meta"><div class="title">No commissions yet</div></div></li>
          {% endfor %}
        </ul>
      </section>
      {% endwith %}
    </div>
  </div>

  <!-- Transaction Detail Modal -->
  <div id="tx-modal" class="tx-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="tx-overlay" data-close></div>
    <div class="tx-panel" role="document">
      <button class="tx-close" type="button" aria-label="Close" data-close>√ó</button>
      <h3 class="tx-title">Transaction Details</h3>

      <div class="tx-row tx-top">
        <div class="tx-kind">
          <span class="tx-kind-ic" id="m_ic"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>Ô∏è</span>
          <span id="m_kind">Deposit</span>
        </div>
        <div class="tx-date" id="m_date">19/08/2025</div>
      </div>

      <div class="tx-amount" id="m_amount">+‚Ç¨126.00</div>
      <div class="tx-status" id="m_status"><span class="dot"></span><span id="m_status_txt">Confirmed</span></div>

      <div class="tx-sep"></div>

      <div class="tx-field">
        <div class="tx-k">Transaction ID</div>
        <div class="tx-v">
          <span id="m_id">#22353</span>
          <button class="tx-copy" type="button" id="m_copy" title="Copy ID"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 3H3M12 21V7M12 7L5 14M12 7L19 14" stroke="#28A745" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg></button>
        </div>
      </div>

      <div class="tx-sep"></div>

      <div class="tx-field">
        <div class="tx-k">Description</div>
        <div class="tx-v" id="m_desc">Added fund to wallet</div>
      </div>

      <div class="tx-sep"></div>

      <div class="tx-field">
        <div class="tx-k">State</div>
        <div class="tx-v" id="m_state">Deposit</div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  // Money mask/unmask on summary values
  (function(){
    document.querySelectorAll('.walletv2 .js-money').forEach(el=>{
      el.setAttribute('data-hidden','1');
      el.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    });
    document.querySelectorAll('.walletv2 .money .eye').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const cur = btn.parentElement.querySelector('.js-money');
        const hidden = cur.getAttribute('data-hidden') === '1';
        cur.textContent = hidden ? (cur.getAttribute('data-value') || '‚Ç¨ 0.00') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        cur.setAttribute('data-hidden', hidden ? '0' : '1');
      });
    });
  })();

  // Format amounts from integer cents and color by sign/kind
  (function(){
    function fmtEUR(cents){
      const neg = cents < 0;
      const n = Math.abs(cents) / 100;
      const s = n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      return (neg ? "-" : "+") + "‚Ç¨" + s;
    }
    document.querySelectorAll('.walletv2 .js-amt').forEach(el=>{
      const cents = parseInt(el.getAttribute('data-cents') || '0', 10);
      const kind  = (el.getAttribute('data-kind') || '').toLowerCase();
      el.textContent = fmtEUR(cents);

      el.classList.remove('plus','minus','neutral');
      if (cents < 0 || kind === 'withdrawal'){
        el.classList.add('minus');
      } else if (kind === 'deposit'){
        el.classList.add('plus');
      } else {
        el.classList.add('neutral');
      }
    });
  })();

  // Tabs: switch visible section
  (function(){
    const tabs = document.querySelectorAll('.walletv2 .tab');
    const panels = document.querySelectorAll('.walletv2 .tx-section');
    if(!tabs.length) return;

    function show(panelKey){
      panels.forEach(p => { p.hidden = p.getAttribute('data-tab-panel') !== panelKey; });
    }
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>{ x.classList.remove('active'); x.setAttribute('aria-selected','false'); });
        t.classList.add('active'); t.setAttribute('aria-selected','true');
        show(t.getAttribute('data-tab'));
      });
    });

    show('all');
  })();

  // Transaction Details Modal: open/fill/close
  (function(){
    const modal   = document.getElementById('tx-modal');
    if(!modal) return;

    const mIc     = document.getElementById('m_ic');
    const mKind   = document.getElementById('m_kind');
    const mDate   = document.getElementById('m_date');
    const mAmt    = document.getElementById('m_amount');
    const mStatus = document.getElementById('m_status');
    const mStatusTxt = document.getElementById('m_status_txt');
    const mId     = document.getElementById('m_id');
    const mCopy   = document.getElementById('m_copy');
    const mDesc   = document.getElementById('m_desc');
    const mState  = document.getElementById('m_state');

    function fmtEUR2(cents){
      const neg = cents < 0;
      const n = Math.abs(cents) / 100;
      const s = n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      return (neg ? "-" : "+") + "‚Ç¨" + s;
    }
    function fmtDateDDMMYYYY(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }
    function kindIcon(kind){
      if(kind === 'deposit') return '‚¨ÜÔ∏è';
      if(kind === 'withdraw' || kind === 'payout' || kind === 'cash_out') return '‚ÜôÔ∏è';
      if(kind === 'commission' || kind === 'adjust') return 'üìÑ';
      return 'üîÅ';
    }
    function kindTitle(kind){
      if(kind === 'adjust') return 'Commission';
      if(kind === 'withdraw' || kind === 'payout' || kind === 'cash_out') return 'Withdrawal';
      return kind.charAt(0).toUpperCase() + kind.slice(1);
    }
    function kindDesc(kind){
      if(kind === 'deposit') return 'Added fund to wallet';
      if(kind === 'withdraw' || kind === 'payout' || kind === 'cash_out') return 'Withdraw';
      if(kind === 'commission' || kind === 'adjust') return 'Commission';
      return 'Adjustment';
    }
    function setAmtColor(el, cents, kind){
      el.classList.remove('plus','minus','neutral');
      if (cents < 0 || kind === 'withdraw' || kind === 'payout' || kind === 'cash_out'){
        el.classList.add('minus');
      } else if (kind === 'deposit'){
        el.classList.add('plus');
      } else {
        el.classList.add('neutral');
      }
    }
    function setStatus(el, status){
      const v = (status || 'confirmed').toLowerCase();
      el.classList.remove('failed','pending');
      if(v === 'failed'){ el.classList.add('failed'); mStatusTxt.textContent = 'Failed'; }
      else if(v === 'pending'){ el.classList.add('pending'); mStatusTxt.textContent = 'Pending'; }
      else { mStatusTxt.textContent = 'Confirmed'; }
    }
    function openModal(){ modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(){ modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

    modal.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closeModal(); });
    document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeModal(); });

    // Copy ID
    mCopy.addEventListener('click', ()=>{
      const id = mId.textContent.replace(/^#/, '');
      navigator.clipboard?.writeText(id);
    });

    // Delegate clicks from any .tx
    document.querySelector('.walletv2')?.addEventListener('click', (e)=>{
      const li = e.target.closest('.tx');
      if(!li) return;

      const ds = li.dataset;
      const kind = (ds.kind || '').toLowerCase();
      const status = ds.status || 'confirmed';
      const amount = parseInt(ds.amount || '0', 10);
      const createdISO = ds.created || '';
      const id = ds.id || '';
      const dateStr = fmtDateDDMMYYYY(createdISO);

      // Fill UI
      mIc.textContent = kindIcon(kind);
      mKind.textContent = kindTitle(kind);
      mDate.textContent = dateStr || '';
      mAmt.textContent = fmtEUR2(amount);
      setAmtColor(mAmt, amount, kind);
      setStatus(mStatus, status);
      mId.textContent = id ? ('#' + id) : '#‚Äî';
      mDesc.textContent = kindDesc(kind);
      mState.textContent = kindTitle(kind);

      openModal();
    });
  })();
</script>
{% endblock %}
