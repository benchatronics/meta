{% extends "base_user.html" %}
{% load static %}
{% load greetings %}

{% block title %}Dashboard ‚Äî Tasks & Rewards{% endblock %}
{% block breadcrumb %}Home / dashboard{% endblock %}

{% block extra_head %}
  <!-- Icons + page CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'meta_search/user_dashboard.css' %}">
  <style>
    /* Small page-only helpers */
    .save-btn { position: relative; display: inline-flex; align-items: center; justify-content: center; }

    .pill-select { position: relative; cursor: pointer; }
    .pill-select select {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      padding-right: 32px; cursor: pointer;
    }
    .pill-select .caret {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      pointer-events: auto; cursor: pointer; z-index: 1;
    }

    /* Desktop-only inline styling for the filters row */
    @media (min-width: 901px){
      #ratingForm.filters{
        display: flex !important;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
        --f-height: 46px;
        --f-radius: 12px;
      }
      #ratingForm .pill,
      #ratingForm .pill-select{
        flex: 1 1 0; min-width: 0;
        height: var(--f-height); border-radius: var(--f-radius);
        padding: 0 12px; display: flex; align-items: center; gap: 10px;
        background: #f3f6fb; border: 1px solid #e7edf6;
      }
      #ratingForm .pill i{ color:#8aa0c6; flex:0 0 auto; }

      #ratingForm .pill input[type="text"],
      #ratingForm .pill input[type="date"]{
        flex: 1 1 auto; min-width: 0;
        height: calc(var(--f-height) - 12px);
        border: 0; background: transparent; font: inherit; color: #2d3a58;
        padding: 0 2px; outline: none; appearance: none; -webkit-appearance: none;
      }

      #ratingForm .pill-select{ position: relative; padding-right: 36px; }
      #ratingForm .pill-select select{
        flex: 1 1 auto; min-width: 0;
        height: calc(var(--f-height) - 12px);
        border: 0; background: transparent; font: inherit; color: #2d3a58;
        outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none;
      }
      #ratingForm .pill-select .caret{
        position: absolute; right: 12px; top: 50%;
        transform: translateY(-50%); pointer-events: none; color: #8aa0c6;
      }

      #ratingForm .search-btn{
        flex: 0 0 auto; height: var(--f-height); border-radius: var(--f-radius);
        padding: 0 22px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;
      }
    }

    /* If an aggressive rule hides this form on mobile, keep it hidden */
    @media (max-width: 900px){
      #ratingForm.filters{ display: none !important; }
    }
  </style>
{% endblock %}

{% block content %}
  {% static 'meta_search/images/avatar-placeholder.png' as avatar_placeholder %}

  <!-- CONTENT ONLY (inherits sidebar/topbar from base) -->
  <div class="ud">
    <!-- Desktop greeting -->
    <div class="greet">
      <h1>
         {% time_greeting %},
        {% firstof request.user.nickname request.user.phone "User" %}
        <span>üëã</span>
      </h1>
      <p>Let‚Äôs do some task and earn reward</p>
      <a href="{% url 'profile_settings' %}" class="mxp-profile-link">
        {{ profile_cta|default:"View Profile" }}
      </a>
    </div>

    <!-- ===== FILTER STRIP (Desktop only) ===== -->
    <form method="get" class="filters" id="ratingForm">
      <div class="pill">
        <i class="fa-solid fa-location-dot"></i>
        <input type="text" name="location" placeholder="Location" value="{{ request.GET.location }}">
      </div>

      <div class="pill">
        <i class="fa-regular fa-calendar"></i>
        <input type="date" name="date" value="{{ request.GET.date }}">
      </div>

      <div class="pill pill-select">
        <i class="fa-regular fa-star"></i>
        <select id="ratingFilter" name="rating" onchange="document.getElementById('ratingForm').submit()">
          <option value="">Rating</option>
          <option value="3"   {% if request.GET.rating == '3' %}selected{% endif %}>3+</option>
          <option value="3.5" {% if request.GET.rating == '3.5' %}selected{% endif %}>3.5+</option>
          <option value="4"   {% if request.GET.rating == '4' %}selected{% endif %}>4+</option>
          <option value="4.5" {% if request.GET.rating == '4.5' %}selected{% endif %}>4.5+</option>
        </select>
        <i class="fa-solid fa-chevron-down caret"></i>
      </div>

      <button type="submit" class="search-btn">Search</button>
    </form>

    {# ==== MOBILE-ONLY greeting + avatar + filters ==== #}
    <div class="mxp-mobile-only" aria-label="Mobile header & filters">
      <section class="mxp-greeting">
        <a href="{% url 'profile_settings' %}" class="mxp-avatar-link" aria-label="View profile">
          <img
            class="mxp-avatar"
            src="{% if user_avatar %}{{ user_avatar }}
                 {% elif request.user.avatar %}{{ request.user.avatar.url }}
                 {% elif request.user.avatar_url %}{{ request.user.avatar_url }}
                 {% else %}{{ avatar_placeholder }}{% endif %}"
            alt="Your avatar"
            onerror="this.src='{{ avatar_placeholder }}'">
        </a>
        <div class="mxp-greet-text">
          <h1 class="mxp-hello">
            {% time_greeting %},
            {% firstof request.user.nickname request.user.phone "User" %}
            <span class="mxp-wave" role="img" aria-label="wave">üëã</span>
          </h1>
          <p class="mxp-sub">Let‚Äôs do some task and earn reward</p>
          <a href="{% url 'profile_settings' %}" class="mxp-profile-link">
            {{ profile_cta|default:"View Profile" }}
          </a>
        </div>
      </section>

      <section class="mxp-filters-bar">
        <button id="mxpFilterToggle" type="button" class="mxp-filters-pill" aria-expanded="false" aria-controls="mxpTaskFilterForm">
          <span class="left">
            <span class="emoji-icon" aria-hidden="true">‚öôÔ∏è</span>
            Filters
          </span>
          <span class="emoji-caret" aria-hidden="true">‚ñæ</span>
        </button>
        <button class="mxp-search-btn" type="submit" form="mxpTaskFilterForm" aria-label="Search">
          <span class="emoji-icon" aria-hidden="true">üîç</span>
        </button>
      </section>

      <form id="mxpTaskFilterForm" class="mxp-filter-panel" method="get" action="">
        <div class="pill">
          <i class="fa-solid fa-location-dot"></i>
          <input type="text" name="location" placeholder="Location" value="{{ request.GET.location|default:'' }}">
        </div>
        <div class="pill">
          <i class="fa-regular fa-calendar"></i>
          <input type="date" name="date" value="{{ request.GET.date|default:'' }}">
        </div>
        <div class="pill pill-select">
          <i class="fa-regular fa-star"></i>
          <select name="rating" id="mxp_rating" onchange="this.form.submit()">
            <option value="">Rating</option>
            <option value="3"   {% if request.GET.rating == '3' %}selected{% endif %}>3+</option>
            <option value="3.5" {% if request.GET.rating == '3.5' %}selected{% endif %}>3.5+</option>
            <option value="4"   {% if request.GET.rating == '4' %}selected{% endif %}>4+</option>
            <option value="4.5" {% if request.GET.rating == '4.5' %}selected{% endif %}>4.5+</option>
          </select>
          <i class="fa-solid fa-chevron-down caret"></i>
        </div>
      </form>
    </div>
    {# ==== /MOBILE-ONLY block ==== #}

    <!-- TABS -->
    <div class="tabs" id="tabs">
      <div class="tab {% if active_tab == 'recommended' %}active{% endif %}" data-tab="recommended">Recommended</div>
      <div class="tab {% if active_tab == 'popular' %}active{% endif %}" data-tab="popular">Popular</div>
      <div class="tab {% if active_tab == 'rating' %}active{% endif %}" data-tab="rating">Rating</div>
    </div>

    <!-- GRID SECTIONS -->
    {% for tab, hotels in hotel_tabs %}
    <section class="grid" id="{% if tab == 'rating' %}ratingTab{% else %}{{ tab }}{% endif %}" {% if tab != active_tab %}style="display:none;"{% endif %}>
      {% for hotel in hotels %}
      <article class="card">
        <div class="cover">
          <img src="{{ hotel.cover_src }}"
               alt="{{ hotel.name }}"
               loading="lazy"
               onerror="this.src='{% static 'images/placeholder.jpg' %}'">
          <div class="save">
            <button class="save-btn"
                    type="button"
                    aria-label="Save {{ hotel.name }}"
                    data-slug="{{ hotel.slug }}"
                    aria-pressed="{{ hotel.is_favorited|yesno:'true,false' }}">
              <i class="{% if hotel.is_favorited %}fa-solid{% else %}fa-regular{% endif %} fa-bookmark"></i>
            </button>
          </div>
        </div>
        <div class="content">
          <div class="title">{{ hotel.name }}</div>
          <p class="desc">{{ hotel.description_short }}</p>
          <div class="metas">
            <div class="country">
              <i class="fa-solid fa-location-dot"></i> {{ hotel.country.flag }} {{ hotel.country.name }}
            </div>
            <div class="right">
              <div class="score">{{ hotel.score }}</div>
              <div class="chip {% if hotel.label == 'perfect' %}green{% elif hotel.label == 'good' %}blue{% else %}amber{% endif %}">
                {{ hotel.get_label_display }}
              </div>
            </div>
          </div>
        </div>
      </article>
      {% empty %}
      <p>No {{ tab }} hotels available.</p>
      {% endfor %}
    </section>
    {% endfor %}
  </div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  // Tabs (client-side switching; server sets initial active_tab)
  const tabs = document.querySelectorAll('.tab');
  const sections = {
    recommended: document.getElementById('recommended'),
    popular: document.getElementById('popular'),
    rating: document.getElementById('ratingTab')
  };
  function showTab(tabName) {
    tabs.forEach(t => t.classList.remove('active'));
    const activeEl = document.querySelector(`.tab[data-tab="${tabName}"]`);
    if (activeEl) activeEl.classList.add('active');
    Object.values(sections).forEach(sec => sec && (sec.style.display = 'none'));
    if (sections[tabName]) sections[tabName].style.display = 'grid';
  }
  tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));
  showTab('{{ active_tab|default:"recommended" }}');

  // Favorites (AJAX) ‚Äî minimal, no counts
  const isAuth = {{ request.user.is_authenticated|yesno:"true,false" }};
  const signinUrl = "{% url 'signin' %}?next={{ request.path|urlencode }}";

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function attachSaveHandlers(scope=document) {
    scope.querySelectorAll('.save-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isAuth) {
          window.location.href = signinUrl;
          return;
        }
        const slug = btn.dataset.slug;
        const icon = btn.querySelector('i');
        const wasOn = icon.classList.contains('fa-solid');

        // Optimistic UI
        icon.classList.toggle('fa-solid', !wasOn);
        icon.classList.toggle('fa-regular', wasOn);
        btn.setAttribute('aria-pressed', !wasOn ? 'true' : 'false');

        try {
          const res = await fetch(`{% url 'toggle_favorite' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await res.json();
          if (data.ok) {
            icon.classList.toggle('fa-solid', !!data.favorited);
            icon.classList.toggle('fa-regular', !data.favorited);
            btn.setAttribute('aria-pressed', data.favorited ? 'true' : 'false');
          } else {
            // Rollback if server says not ok
            icon.classList.toggle('fa-solid', wasOn);
            icon.classList.toggle('fa-regular', !wasOn);
            btn.setAttribute('aria-pressed', wasOn ? 'true' : 'false');
          }
        } catch (e) {
          // Rollback on error
          icon.classList.toggle('fa-solid', wasOn);
          icon.classList.toggle('fa-regular', !wasOn);
          btn.setAttribute('aria-pressed', wasOn ? 'true' : 'false');
          console.error(e);
        }
      });
    });
  }
  attachSaveHandlers(document);

  // Caret & pill click opens rating dropdown
  (function () {
    const pill = document.querySelector('.pill-select');
    if (!pill) return;
    const select = document.getElementById('ratingFilter');
    const caret  = pill.querySelector('.caret');

    function openSelect(evt){
      evt.preventDefault();
      evt.stopPropagation();
      if (!select) return;
      select.focus();
      select.click();
    }
    if (caret) caret.addEventListener('click', openSelect);
    pill.addEventListener('click', function(e){
      if (e.target === select) return; // let native click work
      openSelect(e);
    });
  })();

  // Mobile filter collapsible
  (function(){
    const toggle = document.getElementById('mxpFilterToggle');
    const panel  = document.getElementById('mxpTaskFilterForm');
    if (!toggle || !panel) return;

    toggle.addEventListener('click', function(){
      const open = panel.classList.toggle('open');
      this.setAttribute('aria-expanded', open ? 'true' : 'false');
    }, {passive:true});
  })();
</script>
{% endblock %}
