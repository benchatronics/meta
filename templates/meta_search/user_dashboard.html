{% extends "base_user.html" %}
{% load static %}
{% load greetings %}

{% block title %}Dashboard â€” Tasks & Rewards{% endblock %}
{% block page_title %}My Dashboard{% endblock %}

{% block breadcrumb %}Home / dashboard{% endblock %}

{% block extra_head %}
  {# FA left in place globally in case other templates still use it; not used here #}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'meta_search/user_dashboard.css' %}">
  <style>
    /* Small page-only helpers */
    .save-btn { position: relative; display: inline-flex; align-items: center; justify-content: center; }

    .pill-select { position: relative; cursor: pointer; }
    .pill-select select {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      padding-right: 32px; cursor: pointer;
    }
    .pill-select .caret {
      position: absolute; right: 12px; top: 50%;
      transform: translateY(-50%); pointer-events: none; color: #8aa0c6;
    }

    /* Desktop-only inline styling for the filters row */
    @media (min-width: 901px){
      #ratingForm.filters{
        display: flex !important;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
        --f-height: 46px;
        --f-radius: 12px;
      }
      #ratingForm .pill,
      #ratingForm .pill-select{
        flex: 1 1 0; min-width: 0;
        height: var(--f-height); border-radius: var(--f-radius);
        padding: 0 12px; display: flex; align-items: center; gap: 10px;
        background: #f3f6fb; border: 1px solid #e7edf6;
      }
      /* switched to .icon since we removed <i> */
      #ratingForm .pill .icon{ color:#8aa0c6; flex:0 0 auto; }

      #ratingForm .pill input[type="text"],
      #ratingForm .pill input[type="date"]{
        flex: 1 1 auto; min-width: 0;
        height: calc(var(--f-height) - 12px);
        border: 0; background: transparent; font: inherit; color: #2d3a58;
        padding: 0 2px; outline: none; appearance: none; -webkit-appearance: none;
      }

      #ratingForm .pill-select{ position: relative; padding-right: 36px; }
      #ratingForm .pill-select select{
        flex: 1 1 auto; min-width: 0;
        height: calc(var(--f-height) - 12px);
        border: 0; background: transparent; font: inherit; color: #2d3a58;
        outline: none; appearance: none; -webkit-appearance: none; -moz-appearance: none;
      }

      #ratingForm .search-btn{
        flex: 0 0 auto; height: var(--f-height); border-radius: var(--f-radius);
        padding: 0 22px; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap;
        gap: 8px;
      }
    }

    /* If an aggressive rule hides this form on mobile, keep it hidden */
    @media (max-width: 900px){
      #ratingForm.filters{ display: none !important; }
    }

    /* ==== SVG icon helpers ==== */
    .icon{ width:1.25rem; height:1.25rem; display:inline-block; vertical-align:-2px }
    .icon.sm{ width:1rem; height:1rem }
    .icon.lg{ width:1.5rem; height:1.5rem }
    .text-ink{ color:#1b1b1b }

    /* Button/icon spacing */
    .search-btn .icon{ margin-right:0 } /* spacing handled by gap */
    .mxp-filters-bar .mxp-search-btn .icon{ margin:0 }

    /* Favourite (save) state coloring */
    :root{ --fav-on:#e11d48; }
    .save-btn .fav-icon{ color:#1b1b1b; transition: transform .15s ease, color .15s ease; }
    .save-btn[aria-pressed="true"] .fav-icon,
    .save-btn .fav-icon.active{ color:var(--fav-on); }
    .save-btn:active .fav-icon{ transform: scale(.96); }
  </style>
{% endblock %}

{% block content %}
  {% static 'meta_search/images/avatar-placeholder.png' as avatar_placeholder %}

  <!-- ===== Inline SVG sprite: all icons used on this page ===== -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <!-- FILTER -->
    <symbol id="i-filter" viewBox="0 0 24 24">
      <path d="M15.0505 9H5.5C4.11929 9 3 7.88071 3 6.5C3 5.11929 4.11929 4 5.5 4H15.0505M8.94949 20H18.5C19.8807 20 21 18.8807 21 17.5C21 16.1193 19.8807 15 18.5 15H8.94949M3 17.5C3 19.433 4.567 21 6.5 21C8.433 21 10 19.433 10 17.5C10 15.567 8.433 14 6.5 14C4.567 14 3 15.567 3 17.5ZM21 6.5C21 8.433 19.433 10 17.5 10C15.567 10 14 8.433 14 6.5C14 4.567 15.567 3 17.5 3C19.433 3 21 4.567 21 6.5Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- SEARCH -->
    <symbol id="i-search" viewBox="0 0 24 24">
      <path d="M21 21L15.0001 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- LOCATION -->
    <symbol id="i-location" viewBox="0 0 24 24">
      <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 22C16 18 20 14.4183 20 10C20 5.58172 16.4183 2 12 2C7.58172 2 4 5.58172 4 10C4 14.4183 8 18 12 22Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- CALENDAR -->
    <symbol id="i-calendar" viewBox="0 0 24 24">
      <path d="M21 8H3M16 2V5M8 2V5M7.8 22H16.2C17.8802 22 18.7202 22 19.362 21.673C19.9265 21.3854 20.3854 20.9265 20.673 20.362C21 19.7202 21 18.8802 21 17.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V17.2C3 18.8802 3 19.7202 3.32698 20.362C3.6146 20.9265 4.07354 21.3854 4.63803 21.673C5.27976 22 6.11984 22 7.8 22Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- STAR (rating) -->
    <symbol id="i-star" viewBox="0 0 24 24">
      <path d="M11.2827 3.45332C11.5131 2.98638 11.6284 2.75291 11.7848 2.67831C11.9209 2.61341 12.0791 2.61341 12.2152 2.67831C12.3717 2.75291 12.4869 2.98638 12.7174 3.45332L14.9041 7.88328C14.9721 8.02113 15.0061 8.09006 15.0558 8.14358C15.0999 8.19096 15.1527 8.22935 15.2113 8.25662C15.2776 8.28742 15.3536 8.29854 15.5057 8.32077L20.397 9.03571C20.9121 9.11099 21.1696 9.14863 21.2888 9.27444C21.3925 9.38389 21.4412 9.5343 21.4215 9.68377C21.3988 9.85558 21.2124 10.0372 20.8395 10.4004L17.3014 13.8464C17.1912 13.9538 17.136 14.0076 17.1004 14.0715C17.0689 14.128 17.0487 14.1902 17.0409 14.2545C17.0321 14.3271 17.0451 14.403 17.0711 14.5547L17.906 19.4221C17.994 19.9355 18.038 20.1922 17.9553 20.3445C17.8833 20.477 17.7554 20.57 17.6071 20.5975C17.4366 20.6291 17.2061 20.5078 16.7451 20.2654L12.3724 17.9658C12.2361 17.8942 12.168 17.8584 12.0962 17.8443C12.0327 17.8318 11.9673 17.8318 11.9038 17.8443C11.832 17.8584 11.7639 17.8942 11.6277 17.9658L7.25492 20.2654C6.79392 20.5078 6.56341 20.6291 6.39297 20.5975C6.24468 20.57 6.11672 20.477 6.04474 20.3445C5.962 20.1922 6.00603 19.9355 6.09407 19.4221L6.92889 14.5547C6.95491 14.403 6.96793 14.3271 6.95912 14.2545C6.95132 14.1902 6.93111 14.128 6.89961 14.0715C6.86402 14.0076 6.80888 13.9538 6.69859 13.8464L3.16056 10.4004C2.78766 10.0372 2.60121 9.85558 2.57853 9.68377C2.55879 9.5343 2.60755 9.38389 2.71125 9.27444C2.83044 9.14863 3.08797 9.11099 3.60304 9.03571L8.49431 8.32077C8.64642 8.29854 8.72248 8.28742 8.78872 8.25662C8.84736 8.22935 8.90016 8.19096 8.94419 8.14358C8.99391 8.09006 9.02793 8.02113 9.09597 7.88328L11.2827 3.45332Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <!-- FAVOURITE (heart in circle) -->
    <symbol id="i-favorite" viewBox="0 0 24 24">
      <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path fill-rule="evenodd" clip-rule="evenodd"
            d="M11.9966 9.06791C10.9969 7.8992 9.32987 7.58482 8.07735 8.65501C6.82482 9.72519 6.64848 11.5145 7.6321 12.7802C8.26211 13.5909 9.87558 15.0942 10.9542 16.0704C11.3127 16.3947 11.4919 16.5569 11.7066 16.622C11.8911 16.6779 12.102 16.6779 12.2866 16.622C12.5012 16.5569 12.6805 16.3947 13.0389 16.0704C14.1176 15.0942 15.731 13.5909 16.3611 12.7802C17.3447 11.5145 17.1899 9.71393 15.9158 8.65501C14.6417 7.59608 12.9963 7.8992 11.9966 9.06791Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>
  <!-- ===== /sprite ===== -->

  <!-- CONTENT ONLY (inherits sidebar/topbar from base) -->
  <div class="ud">
    <!-- Desktop greeting -->
    <div class="greet">
      <h1>
         {% time_greeting %},
        {% firstof request.user.nickname request.user.phone "User" %}
        <span>ðŸ‘‹</span>
      </h1>
      <p>Letâ€™s do some task and earn reward</p>
      <a href="{% url 'profile_settings' %}" class="mxp-profile-link">
        {{ profile_cta|default:"View Profile" }}
      </a>
    </div>

    <!-- ===== FILTER STRIP (Desktop only) ===== -->
    <form method="get" class="filters" id="ratingForm">
      <div class="pill">
        <svg class="icon text-ink" aria-hidden="true"><use href="#i-location"/></svg>
        <input type="text" name="location" placeholder="Location" value="{{ request.GET.location }}">
      </div>

      <div class="pill">
        <svg class="icon text-ink" aria-hidden="true"><use href="#i-calendar"/></svg>
        <input type="date" name="date" value="{{ request.GET.date }}">
      </div>

      <div class="pill pill-select">
        <svg class="icon text-ink" aria-hidden="true"><use href="#i-star"/></svg>
        <select id="ratingFilter" name="rating" onchange="document.getElementById('ratingForm').submit()">
          <option value="">Rating</option>
          <option value="3"   {% if request.GET.rating == '3' %}selected{% endif %}>3+</option>
          <option value="3.5" {% if request.GET.rating == '3.5' %}selected{% endif %}>3.5+</option>
          <option value="4"   {% if request.GET.rating == '4' %}selected{% endif %}>4+</option>
          <option value="4.5" {% if request.GET.rating == '4.5' %}selected{% endif %}>4.5+</option>
        </select>
        <!-- Replace FA chevron with a plain caret glyph to avoid FA -->
        <span class="caret" aria-hidden="true">â–¾</span>
      </div>

      <!-- Desktop search button with SVG -->
      <button type="submit" class="search-btn">
        <svg class="icon text-ink" aria-hidden="true"><use href="#i-search"/></svg>
        <span>Search</span>
      </button>
    </form>

    {# ==== MOBILE-ONLY greeting + avatar + filters ==== #}
    <div class="mxp-mobile-only" aria-label="Mobile header & filters">
      <section class="mxp-greeting">
        <a href="{% url 'profile_settings' %}" class="mxp-avatar-link" aria-label="View profile">
          <img
            class="mxp-avatar"
            src="{% if user_avatar %}{{ user_avatar }}
                 {% elif request.user.avatar %}{{ request.user.avatar.url }}
                 {% elif request.user.avatar_url %}{{ request.user.avatar_url }}
                 {% else %}{{ avatar_placeholder }}{% endif %}"
            alt="Your avatar"
            onerror="this.src='{{ avatar_placeholder }}'">
        </a>
        <div class="mxp-greet-text">
          <h1 class="mxp-hello">
            {% time_greeting %},
            {% firstof request.user.nickname request.user.phone "User" %}
            <span class="mxp-wave" role="img" aria-label="wave">ðŸ‘‹</span>
          </h1>
          <p class="mxp-sub">Letâ€™s do some task and earn reward</p>
          <a href="{% url 'profile_settings' %}" class="mxp-profile-link">
            {{ profile_cta|default:"View Profile" }}
          </a>
        </div>
      </section>

      <section class="mxp-filters-bar">
        <!-- Filter SVG -->
        <button id="mxpFilterToggle" type="button" class="mxp-filters-pill" aria-expanded="false" aria-controls="mxpTaskFilterForm">
          <span class="left">
            <svg class="icon text-ink" aria-hidden="true"><use href="#i-filter"/></svg>
            Filters
          </span>
          <span class="emoji-caret" aria-hidden="true">â–¾</span>
        </button>
        <!-- Search SVG -->
        <button class="mxp-search-btn" type="submit" form="mxpTaskFilterForm" aria-label="Search">
          <svg class="icon text-ink" aria-hidden="true"><use href="#i-search"/></svg>
        </button>
      </section>

      <form id="mxpTaskFilterForm" class="mxp-filter-panel" method="get" action="">
        <div class="pill">
          <svg class="icon text-ink" aria-hidden="true"><use href="#i-location"/></svg>
          <input type="text" name="location" placeholder="Location" value="{{ request.GET.location|default:'' }}">
        </div>
        <div class="pill">
          <svg class="icon text-ink" aria-hidden="true"><use href="#i-calendar"/></svg>
          <input type="date" name="date" value="{{ request.GET.date|default:'' }}">
        </div>
        <div class="pill pill-select">
          <svg class="icon text-ink" aria-hidden="true"><use href="#i-star"/></svg>
          <select name="rating" id="mxp_rating" onchange="this.form.submit()">
            <option value="">Rating</option>
            <option value="3"   {% if request.GET.rating == '3' %}selected{% endif %}>3+</option>
            <option value="3.5" {% if request.GET.rating == '3.5' %}selected{% endif %}>3.5+</option>
            <option value="4"   {% if request.GET.rating == '4' %}selected{% endif %}>4+</option>
            <option value="4.5" {% if request.GET.rating == '4.5' %}selected{% endif %}>4.5+</option>
          </select>
          <span class="caret" aria-hidden="true">â–¾</span>
        </div>
      </form>
    </div>
    {# ==== /MOBILE-ONLY block ==== #}

    <!-- TABS -->
    <div class="tabs" id="tabs">
      <div class="tab {% if active_tab == 'recommended' %}active{% endif %}" data-tab="recommended">Recommended</div>
      <div class="tab {% if active_tab == 'popular' %}active{% endif %}" data-tab="popular">Popular</div>
      <div class="tab {% if active_tab == 'rating' %}active{% endif %}" data-tab="rating">Rating</div>
    </div>

    <!-- GRID SECTIONS -->
    {% for tab, hotels in hotel_tabs %}
    <section class="grid" id="{% if tab == 'rating' %}ratingTab{% else %}{{ tab }}{% endif %}" {% if tab != active_tab %}style="display:none;"{% endif %}>
      {% for hotel in hotels %}
      <article class="card">
        <div class="cover">
          <img src="{{ hotel.cover_src }}"
               alt="{{ hotel.name }}"
               loading="lazy"
               onerror="this.src='{% static 'images/placeholder.jpg' %}'">
          <div class="save">
            <!-- SVG favourite with toggle state -->
            <button class="save-btn"
                    type="button"
                    aria-label="Save {{ hotel.name }}"
                    data-slug="{{ hotel.slug }}"
                    aria-pressed="{{ hotel.is_favorited|yesno:'true,false' }}">
              <svg class="icon fav-icon" aria-hidden="true">
                <use href="#i-favorite"></use>
              </svg>
            </button>
          </div>
        </div>
        <div class="content">
          <div class="title">{{ hotel.name }}</div>
          <p class="desc">{{ hotel.description_short }}</p>
          <div class="metas">
            <div class="country">
              <svg class="icon text-ink" aria-hidden="true"><use href="#i-location"/></svg>
              {{ hotel.country.flag }} {{ hotel.country.name }}
            </div>
            <div class="right">
              <div class="score">{{ hotel.score }}</div>
              <div class="chip {% if hotel.label == 'perfect' %}green{% elif hotel.label == 'good' %}blue{% else %}amber{% endif %}">
                {{ hotel.get_label_display }}
              </div>
            </div>
          </div>
        </div>
      </article>
      {% empty %}
      <p>No {{ tab }} hotels available.</p>
      {% endfor %}
    </section>
    {% endfor %}
  </div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  // Tabs (client-side switching; server sets initial active_tab)
  const tabs = document.querySelectorAll('.tab');
  const sections = {
    recommended: document.getElementById('recommended'),
    popular: document.getElementById('popular'),
    rating: document.getElementById('ratingTab')
  };
  function showTab(tabName) {
    tabs.forEach(t => t.classList.remove('active'));
    const activeEl = document.querySelector(`.tab[data-tab="${tabName}"]`);
    if (activeEl) activeEl.classList.add('active');
    Object.values(sections).forEach(sec => sec && (sec.style.display = 'none'));
    if (sections[tabName]) sections[tabName].style.display = 'grid';
  }
  tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));
  showTab('{{ active_tab|default:"recommended" }}');

  // Favorites (AJAX)
  const isAuth = {{ request.user.is_authenticated|yesno:"true,false" }};
  const signinUrl = "{% url 'signin' %}?next={{ request.path|urlencode }}";

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function setFavUI(btn, on){
    btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    const svg = btn.querySelector('.fav-icon');
    const i   = btn.querySelector('i'); // fallback if any remain
    if (svg) svg.classList.toggle('active', !!on);
    if (i) { i.classList.toggle('fa-solid', !!on); i.classList.toggle('fa-regular', !on); }
  }

  function attachSaveHandlers(scope=document) {
    scope.querySelectorAll('.save-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!isAuth) {
          window.location.href = signinUrl;
          return;
        }
        const slug = btn.dataset.slug;
        const wasOn = btn.getAttribute('aria-pressed') === 'true';

        // Optimistic UI
        setFavUI(btn, !wasOn);

        try {
          const res = await fetch(`{% url 'toggle_favorite' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
          });
          const data = await res.json();
          if (data.ok) {
            setFavUI(btn, !!data.favorited);
          } else {
            setFavUI(btn, wasOn); // rollback
          }
        } catch (e) {
          setFavUI(btn, wasOn); // rollback on error
          console.error(e);
        }
      });
    });
  }
  attachSaveHandlers(document);

  // Caret & pill click opens rating dropdown
  (function () {
    const pill = document.querySelector('.pill-select');
    if (!pill) return;
    const select = document.getElementById('ratingFilter');
    const caret  = pill.querySelector('.caret');

    function openSelect(evt){
      evt.preventDefault();
      evt.stopPropagation();
      if (!select) return;
      select.focus();
      select.click();
    }
    if (caret) caret.addEventListener('click', openSelect);
    pill.addEventListener('click', function(e){
      if (e.target === select) return; // let native click work
      openSelect(e);
    });
  })();

  // Mobile filter collapsible
  (function(){
    const toggle = document.getElementById('mxpFilterToggle');
    const panel  = document.getElementById('mxpTaskFilterForm');
    if (!toggle || !panel) return;

    toggle.addEventListener('click', function(){
      const open = panel.classList.toggle('open');
      this.setAttribute('aria-expanded', open ? 'true' : 'false');
    }, {passive:true});
  })();
</script>
{% endblock %}
