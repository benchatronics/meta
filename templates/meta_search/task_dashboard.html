{% extends "base_user.html" %}
{% load static currency i18n %}

{% block title %}{% trans "Task" %}{% endblock %}
{% block breadcrumb %}{% trans "Home" %} / {% trans "setting" %} / {% trans "Task" %}{% endblock %}
{% block app_classes %}page-task{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'meta_search/task_dashboard.css' %}">
{% endblock %}

{% block content %}
  <h1 class="page-title">{% trans "Task" %}</h1>

  {% if messages %}
    <ul class="flash-list">
      {% for m in messages %}
        <li class="flash flash-{{ m.tags|default:'info' }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# ===== Stats / KPIs ===== #}
  <section class="stats-grid" role="region" aria-label="{% trans 'Balances' %}">
    {% for c in kpis %}
      <article class="stat-card">
        <div class="stat-row">
          <span class="stat-ico" aria-hidden>{{ c.icon }}</span>
          <span class="stat-label">{{ c.label }}</span>
        </div>
        <div class="stat-val">{{ c.value }}</div>
      </article>
    {% endfor %}
  </section>

  {# ===== Banner ===== #}
  <section class="reward-banner" role="region" aria-label="{% trans 'Tasks Promo' %}">
    <div class="rb-orn orb-a"></div>
    <div class="rb-orn orb-b"></div>

    <div class="reward-grid">
      <div class="reward-copy">
        <h2 class="reward-title">
          <span>{% trans "Complete Tasks" %}</span>
          <span>{% trans "and get rewarded" %}</span>
        </h2>
      </div>
      <div class="reward-art">
        <img
          src="{% static 'meta_search/logos/task_reward.png' %}"
          alt="{% trans 'Reward' %}"
          decoding="async"
          fetchpriority="high">
      </div>
    </div>

    <p class="reward-today">
      {% if snapshot.is_blocked %}
        <strong>{% trans "Locked:" %}</strong>
        {{ block_reason|default:_("You have completed your trial. Please contact customer care.") }}
      {% else %}
        {% if badge and badge|add:0 > 0 %}
          {% blocktrans with n=badge %}Tasks available: <strong>{{ n }}</strong>{% endblocktrans %}
        {% else %}
          {% trans "You’re up to date. Click below to get your next task." %}
        {% endif %}
      {% endif %}
    </p>

    {# CTA: POST to do_next_task, disabled if blocked #}
    <form method="post" action="{% url 'do_next_task' %}" class="task-cta-wrap">
      {% csrf_token %}
      <button class="task-cta"
              type="submit"
              {% if cta_disabled %}disabled title="{{ block_reason }}"{% endif %}>
        {% if cta_disabled %}
          {% trans "Locked — contact support" %}
        {% else %}
          {% trans "Click to get your task" %}
        {% endif %}
        {% if badge and not cta_disabled %}
          <span class="cta-badge">{{ badge }}</span>
        {% endif %}
      </button>
    </form>
  </section>

  {# ===== MOBILE FILTER TABS ===== #}
  <div class="tabs" role="tablist" aria-label="{% trans 'Filter tasks' %}">
    <button class="tab is-active" data-filter="all">{% trans "All" %}</button>
    <button class="tab" data-filter="Completed">{% trans "Completed" %}</button>
    <button class="tab" data-filter="Processing">{% trans "Processing" %}</button>
  </div>
  <div class="tabs-line"><div class="bar"></div></div>

  {# ===== Task History ===== #}
  <section class="history-block" role="region" aria-label="{% trans 'Task History' %}">
    {# Desktop header with dropdown (no refresh) #}
    <div class="desk-head">
      <div class="table-title">{% trans "Task History" %}</div>
      <div class="desk-filter">
        <span>{% trans "Status" %}</span>
        <select id="deskStatus" aria-label="{% trans 'Status' %}">
          <option value="all">{% trans "All" %}</option>
          <option value="Completed">{% trans "Completed" %}</option>
          <option value="Processing">{% trans "Processing" %}</option>
        </select>
      </div>
    </div>

    <h3 class="mobile-title">{% trans "Task History" %}</h3>

    {# ----- Mobile card list ----- #}
    <div class="tx-list" id="mobileList">
      {% if tasks %}
        {% for t in tasks %}
          {% if t.get_status_display == 'Approved' %}
            {% with mapped_status='Completed' tone='ok' %}
              <article class="tx-card" data-status="{{ mapped_status }}">
                <div class="tx-top">
                  <div class="tx-id">{{ t.template.order_code|default:t.id }}</div>
                  <div class="tx-date">{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</div>
                  <a class="tx-view" href="{#% url 'task_detail' t.id %#}">{% trans "View" %}</a>
                </div>

                <div class="tx-row">
                  <span class="tx-label">{% trans "Product" %}</span>
                  <span class="tx-value">
                    {% if t.template and t.template.name %}{{ t.template.name }}{% else %}—{% endif %}
                  </span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Price" %}</span>
                  <span class="tx-value tx-strong">{{ t.worth_cents|eur }}</span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Status" %}</span>
                  <span class="tx-value tx-status {{ tone }}"><i class="dot"></i>{{ mapped_status }}</span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Comm" %}</span>
                  <span class="tx-value tx-green">+{{ t.commission_cents|eur }}</span>
                </div>
              </article>
            {% endwith %}

          {% elif t.get_status_display == 'Submitted' or t.get_status_display == 'In Progress' or t.get_status_display == 'Pending' %}
            {% with mapped_status='Processing' tone='warn' %}
              <article class="tx-card" data-status="{{ mapped_status }}">
                <div class="tx-top">
                  <div class="tx-id">{{ t.template.order_code|default:t.id }}</div>
                  <div class="tx-date">{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</div>
                  <a class="tx-view" href="{#% url 'task_detail' t.id %#}">{% trans "View" %}</a>
                </div>

                <div class="tx-row">
                  <span class="tx-label">{% trans "Product" %}</span>
                  <span class="tx-value">
                    {% if t.template and t.template.name %}{{ t.template.name }}{% else %}—{% endif %}
                  </span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Price" %}</span>
                  <span class="tx-value tx-strong">{{ t.worth_cents|eur }}</span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Status" %}</span>
                  <span class="tx-value tx-status {{ tone }}"><i class="dot"></i>{{ mapped_status }}</span>
                </div>
                <div class="tx-row">
                  <span class="tx-label">{% trans "Comm" %}</span>
                  <span class="tx-value tx-amber">+{{ t.commission_cents|eur }}</span>
                </div>
              </article>
            {% endwith %}

          {% else %}
            {# Any other statuses render as-is and will be visible under All #}
            <article class="tx-card" data-status="{{ t.get_status_display }}">
              <div class="tx-top">
                <div class="tx-id">{{ t.template.order_code|default:t.id }}</div>
                <div class="tx-date">{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</div>
                <a class="tx-view" href="{#% url 'task_detail' t.id %#}">{% trans "View" %}</a>
              </div>

              <div class="tx-row">
                <span class="tx-label">{% trans "Product" %}</span>
                <span class="tx-value">
                  {% if t.template and t.template.name %}{{ t.template.name }}{% else %}—{% endif %}
                </span>
              </div>
              <div class="tx-row">
                <span class="tx-label">{% trans "Price" %}</span>
                <span class="tx-value tx-strong">{{ t.worth_cents|eur }}</span>
              </div>
              <div class="tx-row">
                <span class="tx-label">{% trans "Status" %}</span>
                <span class="tx-value tx-status dim"><i class="dot"></i>{{ t.get_status_display }}</span>
              </div>
              <div class="tx-row">
                <span class="tx-label">{% trans "Comm" %}</span>
                <span class="tx-value">+{{ t.commission_cents|eur }}</span>
              </div>
            </article>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="empty">{% trans "No Task History" %}</div>
      {% endif %}
    </div>

    {# ----- Desktop table with dropdown filter ----- #}
    <div class="table-wrap">
      <table class="table" id="deskTable">
        <thead>
          <tr>
            <th>{% trans "Product Name" %}</th>
            <th>{% trans "Order ID" %}</th>
            <th>{% trans "Date" %}</th>
            <th>{% trans "Price" %}</th>
            <th>{% trans "Comm" %}</th>
            <th>{% trans "Status" %}</th>
            <th class="text-right">{% trans "Action" %}</th>
          </tr>
        </thead>
        <tbody>
        {% if tasks %}
          {% for t in tasks %}
            {% if t.get_status_display == 'Approved' %}
              {% with mapped_status='Completed' pill='is-ok' %}
                <tr data-status="{{ mapped_status }}">
                  <td>{% if t.template and t.template.name %}{{ t.template.name }}{% else %}{% blocktrans with id=t.id %}Task #{{ id }}{% endblocktrans %}{% endif %}</td>
                  <td>{{ t.template.order_code|default:t.id }}</td>
                  <td>{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</td>
                  <td>{{ t.worth_cents|eur }}</td>
                  <td class="comm">+{{ t.commission_cents|eur }}</td>
                  <td><span class="status-pill {{ pill }}"><i class="dot"></i>{{ mapped_status }}</span></td>
                  <td class="text-right"><a href="{#% url 'task_detail' t.id %#}" class="btn-view">{% trans "View" %}</a></td>
                </tr>
              {% endwith %}

            {% elif t.get_status_display == 'Submitted' or t.get_status_display == 'In Progress' or t.get_status_display == 'Pending' %}
              {% with mapped_status='Processing' pill='is-warn' %}
                <tr data-status="{{ mapped_status }}">
                  <td>{% if t.template and t.template.name %}{{ t.template.name }}{% else %}{% blocktrans with id=t.id %}Task #{{ id }}{% endblocktrans %}{% endif %}</td>
                  <td>{{ t.template.order_code|default:t.id }}</td>
                  <td>{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</td>
                  <td>{{ t.worth_cents|eur }}</td>
                  <td class="comm">+{{ t.commission_cents|eur }}</td>
                  <td><span class="status-pill {{ pill }}"><i class="dot"></i>{{ mapped_status }}</span></td>
                  <td class="text-right"><a href="{#% url 'task_detail' t.id %#}" class="btn-view">{% trans "View" %}</a></td>
                </tr>
              {% endwith %}

            {% else %}
              <tr data-status="{{ t.get_status_display }}">
                <td>{% if t.template and t.template.name %}{{ t.template.name }}{% else %}{% blocktrans with id=t.id %}Task #{{ id }}{% endblocktrans %}{% endif %}</td>
                <td>{{ t.template.order_code|default:t.id }}</td>
                <td>{{ t.approved_at|default_if_none:t.created_at|date:"M j, Y H:i" }}</td>
                <td>{{ t.worth_cents|eur }}</td>
                <td class="comm">+{{ t.commission_cents|eur }}</td>
                <td><span class="status-pill is-dim"><i class="dot"></i>{{ t.get_status_display }}</span></td>
                <td class="text-right"><a href="{#% url 'task_detail' t.id %#}" class="btn-view">{% trans "View" %}</a></td>
              </tr>
            {% endif %}
          {% endfor %}
        {% else %}
          <tr class="empty"><td colspan="7">{% trans "No Task History" %}</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  {# ===== Trial-limit modal (only when blocked after finishing trial) ===== #}
  {% if show_congrats %}
    <div id="trial-overlay" class="modal-overlay"></div>
    <section id="trial-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="trial-modal-title">
      <button class="modal-close" type="button" aria-label="{% trans 'Close' %}" onclick="closeTrialModal()">×</button>
      <div class="modal-top"></div>
      <div class="modal-icon">
        <span class="icon-ring">
          <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M8 8l8 8M16 8l-8 8" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </span>
      </div>
      <h3 id="trial-modal-title" class="modal-title">{% trans "Trial Complete" %}</h3>
      <p class="modal-text">{% trans "You’ve completed all trial tasks. Please contact customer care to continue." %}</p>
      <a class="modal-btn" href="/customer-care/">{% trans "Customer care" %}</a>
    </section>
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}

  <script>
    // Desktop dropdown filtering (uses normalized data-status)
    (function(){
      const sel = document.getElementById('deskStatus');
      const rows = document.querySelectorAll('#deskTable tbody tr');
      function applyFilter(){
        const v = sel?.value || 'all';
        rows.forEach(r=>{
          const status = r.getAttribute('data-status');
          r.style.display = (v === 'all' || v === status) ? '' : 'none';
        });
      }
      sel?.addEventListener('change', applyFilter);
      applyFilter();
    })();

    // Mobile tabs: underline + filter cards (uses normalized data-status)
    (function(){
      const tabs = document.querySelectorAll('.tabs .tab');
      const bar  = document.querySelector('.tabs-line .bar');
      const cards = document.querySelectorAll('#mobileList .tx-card');

      function setBar(){
        const idx = [...tabs].findIndex(t=>t.classList.contains('is-active')) || 0;
        if (bar) bar.style.left = (idx * 33.333) + '%';
      }
      function filterMobile(){
        const active = document.querySelector('.tabs .tab.is-active')?.dataset.filter || 'all';
        cards.forEach(c=>{
          const st = c.getAttribute('data-status');
          c.style.display = (active === 'all' || active === st) ? '' : 'none';
        });
      }
      tabs.forEach(t=>{
        t.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.remove('is-active'));
          t.classList.add('is-active');
          setBar();
          filterMobile();
        });
      });
      setBar(); filterMobile();
    })();

    // Trial modal visibility (only when show_congrats true)
    {% if show_congrats %}
    (function () {
      const key = "trialDoneShown-{{ request.user.id|default:'anon' }}";
      if (!localStorage.getItem(key)) {
        document.getElementById('trial-overlay')?.classList.add('show');
        document.getElementById('trial-modal')?.classList.add('show');
      }
      window.closeTrialModal = function () {
        try { localStorage.setItem(key, "1"); } catch (e) {}
        document.getElementById('trial-overlay')?.classList.remove('show');
        document.getElementById('trial-modal')?.classList.remove('show');
      };
    })();
    {% endif %}
  </script>
{% endblock %}
