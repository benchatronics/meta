{% extends "base_user.html" %}
{% load static %}

{% block title %}Deposit{% endblock %}
{% block breadcrumb %}Home / my Wallet / Deposit{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'meta_search/deposit.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}

  <!-- Page header (mobile-only back arrow + title) -->
  <div class="page-with-mobile-back">
    <div class="page-header">
      <a
        class="back-link"
        href="{% url 'wallet' %}"
        aria-label="Go back"
        onclick="if (history.length > 1) { history.back(); return false; }">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             aria-hidden="true">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>
      <h1 class="page-title">Deposit</h1>
    </div>
  </div>

  <!-- Scoped, page-only CSS -->
  <style>
    /* header */
    .page-with-mobile-back .page-header{ display:flex; align-items:center; gap:10px; margin:0 0 14px; }
    .page-with-mobile-back .page-title{ margin:0; font-weight:700; font-size:22px; color:var(--text, #0f172a); }
    .page-with-mobile-back .back-link{
      display:none; align-items:center; justify-content:center; width:36px; height:36px;
      border-radius:10px; border:1px solid var(--border, #e5e7eb);
      background:#fff; color:var(--primary, #2451FF); text-decoration:none; box-shadow:0 1px 0 rgba(16,24,40,.02);
    }
    .page-with-mobile-back .back-link:hover{ box-shadow:0 8px 20px rgba(16,24,40,.08); }
    @media (max-width: 900px){
      .page-with-mobile-back .back-link{ display:inline-flex; }
      .page-with-mobile-back .page-title{ font-size:20px; }
      .page-with-mobile-back .back-link svg{ width:18px; height:18px; }
    }

    /* form layout tweaks (scoped to .dep) */
    .dep .inner.grid{ display:grid; gap:18px; }
    .dep .group{ display:grid; gap:10px; }
    .dep .section-title{ font-weight:800; color:#0f172a; }

    /* amount row (only prefix + input) */
    .dep .ctrl{
      display:flex; align-items:center; gap:10px;
      border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff;
    }
    .dep .ctrl .prefix{ font-weight:800; color:#0f172a; }
    .dep .ctrl input[type="number"],
    .dep .ctrl input{name:amount}{
      flex:1 1 auto; min-width:0; border:0; outline:0; font-size:16px; padding:6px 0;
    }

    /* currency selector now BELOW, full-width */
    .dep .select-row{ margin-top:8px; }
    .dep .select-row .label{ color:#6b7280; font-size:12px; margin-bottom:4px; }
    .dep .select-row .select select{
      width:100%; height:44px; border:1px solid #e5e7eb; border-radius:12px; padding:0 12px; background:#fff;
    }
    .dep .ctrl.error, .dep .select.error select{ border-color:#ef4444; }
    .dep .field-error{ color:#b91c1c; font-size:12px; }

    /* presets */
    .dep .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .dep .chip{ border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer; }

    /* method pills */
    .dep .method{ display:flex; flex-wrap:wrap; gap:12px; }
    .dep .opt{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; }
    .dep .opt.active{ outline:3px solid rgba(36,81,255,.12); border-color:#2451FF22; }
    .dep .bullet{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center; background:#eef2ff; }
    .dep .bullet.usdt{ background:#26a17b; color:#fff; font-weight:900; }

    .dep .submit{ width:100%; height:48px; border-radius:12px; }
  </style>

<section class="dep">
  <div class="shell">
    <h1></h1>

    {% if messages %}
      <div class="alerts" role="status" aria-live="polite">
        {% for message in messages %}
          <div class="alert {{ message.tags|default:'info' }}">
            {% if 'success' in message.tags %}<i class="fa-regular fa-circle-check"></i>{% endif %}
            {% if 'info' in message.tags or not message.tags %}<i class="fa-regular fa-circle-info"></i>{% endif %}
            {% if 'warning' in message.tags %}<i class="fa-regular fa-triangle-exclamation"></i>{% endif %}
            {% if 'error' in message.tags %}<i class="fa-regular fa-circle-xmark"></i>{% endif %}
            <div>{{ message }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card">
      <div class="inner grid">
        <form method="post" action="{% url 'deposit' %}" id="depositForm" novalidate>
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="group">
              <div class="field-error">{{ form.non_field_errors|join:", " }}</div>
            </div>
          {% endif %}

          <!-- Amount (currency selector moved below) -->
          <div class="group">
            <div class="section-title">Amount</div>

            <div class="ctrl {% if form.amount.errors %}error{% endif %}">
              <span class="prefix" id="currSymbol">{{ symbol }}</span>
              {{ form.amount }}
            </div>
            {% if form.amount.errors %}
              <div class="field-error">{{ form.amount.errors.0 }}</div>
            {% endif %}

            <!-- Currency BELOW the amount -->
            <div class="select-row">
              <div class="label">Currency</div>
              <div class="select {% if form.currency.errors %}error{% endif %}">
                {{ form.currency }}
              </div>
            </div>
            {% if form.currency.errors %}
              <div class="field-error">{{ form.currency.errors.0 }}</div>
            {% endif %}

            <!-- Preset chips -->
            <div class="chips">
              {% for v in presets %}
                <button class="chip" type="button" data-amt="{{ v }}">{{ v }}</button>
              {% endfor %}
            </div>

            <div class="muted">Minimum 10. Choose a preset or enter an amount.</div>
          </div>

          <!-- Network / Payment method -->
          <div class="group">
            <div class="section-title" style="margin-top:10px">Payment Method</div>
            <div class="method">
              <label class="opt {% if form.network.value == 'ETH' %}active{% endif %}" data-net="ETH">
                <input type="radio" name="network" value="ETH" class="sr-only" {% if form.network.value == 'ETH' or not form.network.value %}checked{% endif %}>
                <span class="bullet"><i class="fa-brands fa-ethereum"></i></span>
                <span>Ethereum (ERC20)</span>
              </label>

              <label class="opt {% if form.network.value == 'TRC20' %}active{% endif %}" data-net="TRC20">
                <input type="radio" name="network" value="TRC20" class="sr-only" {% if form.network.value == 'TRC20' %}checked{% endif %}>
                <span class="bullet usdt">T</span>
                <span>USDT (TRC20)</span>
              </label>
            </div>

            {% if form.network.errors %}
              <div class="field-error">{{ form.network.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Submit -->
          <div class="group">
            <button class="submit" type="submit">Proceed to Pay →</button>
          </div>
        </form>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  // Auto-dismiss non-error alerts after 6s
  setTimeout(() => {
    document.querySelectorAll('.dep .alert:not(.error)').forEach(el => {
      el.style.transition = 'opacity .3s ease';
      el.style.opacity = '0';
      setTimeout(() => el.remove(), 300);
    });
  }, 6000);

  // Currency symbol swap (now reading selector below the input)
  (function(){
    const symbolMap = { EUR:"€", USD:"$", GBP:"£", NGN:"₦" };
    const currSel = document.querySelector('.dep select[name="currency"]');
    const sym = document.getElementById('currSymbol');
    if (currSel && sym){
      sym.textContent = symbolMap[currSel.value] || sym.textContent || "€";
      currSel.addEventListener('change', ()=>{ sym.textContent = symbolMap[currSel.value] || sym.textContent || "€"; });
    }
  })();

  // Preset chips -> fill amount
  document.querySelectorAll('.dep .chip').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const i = document.querySelector('.dep input[name="amount"], .dep input#id_amount');
      if (i) i.value = Number(ch.dataset.amt).toFixed(2);
    });
  });

  // Toggle network highlight
  document.querySelectorAll('.dep .opt').forEach(label=>{
    const input = label.querySelector('input[type="radio"]');
    label.addEventListener('click', ()=>{
      document.querySelectorAll('.dep .opt').forEach(l=>l.classList.remove('active'));
      label.classList.add('active');
      if (input) input.checked = true;
    });
  });
</script>
{% endblock %}
