{% extends "base_user.html" %}
{% load static %}

{% block title %}Add Payout Address{% endblock %}
{% block breadcrumb %}Home / my Wallet / Add Address{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'meta_search/add_address.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}

  <!-- Page header (mobile-only back arrow + title) -->
  <div class="page-with-mobile-back">
    <div class="page-header">
      <a
        class="back-link"
        href="{% url 'withdrawal' %}"                 {# fallback route; change if needed #}
        aria-label="Go back"
        onclick="if (history.length > 1) { history.back(); return false; }">
        <!-- Blue back arrow (uses currentColor) -->
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             aria-hidden="true">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </a>
      <h1 class="page-title">Add Payout Address</h1>        {# change title per page #}
    </div>

    <!-- rest of your page content here... -->
  </div>

  <!-- Scoped, page-only CSS -->
  <style>
    /* scope all rules to this page only */
    .page-with-mobile-back .page-header{
      display:flex; align-items:center; gap:10px;
      margin:0 0 14px;
    }
    .page-with-mobile-back .page-title{
      margin:0; font-weight:700; font-size:22px;
      color:var(--text, #0f172a);
    }

    /* Back arrow (mobile-only) */
    .page-with-mobile-back .back-link{
      display:none;                               /* hidden by default (desktop) */
      align-items:center; justify-content:center;
      width:36px; height:36px;
      border-radius:10px;
      border:1px solid var(--border, #e5e7eb);
      background:#fff;
      color:var(--primary, #2451FF);              /* BLUE arrow via currentColor */
      text-decoration:none;
      box-shadow:0 1px 0 rgba(16,24,40,.02);
    }
    .page-with-mobile-back .back-link:hover{
      box-shadow:0 8px 20px rgba(16,24,40,.08);
    }

    /* Show the back arrow only on mobile/tablet */
    @media (max-width: 900px){
      .page-with-mobile-back .back-link{ display:inline-flex; }
      .page-with-mobile-back .page-title{ font-size:20px; }
      .page-with-mobile-back .back-link svg{ width:18px; height:18px; }
    }
  </style>


<section class="wdw">
  <div class="shell">
    <h1>{# Add Payout Address #}</h1>

    {% if messages %}
      <div class="flash" aria-live="polite">
        {% for message in messages %}
          <div class="alert {{ message.tags|default:'info' }}" role="alert">
            {% if 'success' in message.tags %}
              <i class="fa-solid fa-circle-check"></i>
            {% elif 'error' in message.tags or 'danger' in message.tags %}
              <i class="fa-solid fa-circle-xmark"></i>
            {% elif 'warning' in message.tags %}
              <i class="fa-solid fa-triangle-exclamation"></i>
            {% else %}
              <i class="fa-solid fa-circle-info"></i>
            {% endif %}
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card">
      <div class="inner">
        <form method="post" action="">
          {% csrf_token %}

          <!-- Address Type -->
          <div class="group">
            <div class="section-title">Address Type</div>
            <div class="method" id="methodPills">
              {% for val, label in form.address_type.field.choices %}
                {% if val == 'ETH' or val == 'TRC20' %}
                  {% with is_checked=form.address_type.value|default:form.address_type.initial %}
                    <label class="opt {% if is_checked == val %}active{% endif %}">
                      <input
                        type="radio"
                        name="{{ form.address_type.name }}"
                        value="{{ val }}"
                        class="sr-only"
                        {% if is_checked == val %}checked{% endif %}>
                      {% if val == 'ETH' %}
                        <span class="bullet eth">
                          <i class="fa-brands fa-ethereum" aria-hidden="true"></i>
                        </span>
                        <span>Ethereum (ERC20)</span>
                      {% else %}
                        <span class="bullet tether" aria-hidden="true">
                          <svg viewBox="0 0 32 32" role="img" focusable="false" aria-hidden="true">
                            <circle cx="16" cy="16" r="16" fill="#26a17b"></circle>
                            <path fill="#FFFFFF" d="M26 9.9c0-1-4.5-1.9-10-1.9S6 8.9 6 9.9c0 .8 2.7 1.5 6.5 1.8v2.7c-3.7.3-6.2 1-6.2 1.8 0 .8 2.5 1.5 6.2 1.8V24h4.9v-5.9c3.8-.3 6.6-1 6.6-1.9 0-.8-2.8-1.6-6.6-1.9V11.7C23.3 11.4 26 10.7 26 9.9z"/>
                          </svg>
                        </span>
                        <span>USDT (TRC20)</span>
                      {% endif %}
                    </label>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            </div>
            {% if form.address_type.errors %}
              <div class="err-row" style="margin-top:8px">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.address_type.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Address -->
          <div class="group addr-wrap">
            <div class="section-title">Address</div>

            <div class="addr {% if form.address.errors %}error{% endif %}" id="addrRow">
              {{ form.address }}
            </div>

            <div id="addrHint" class="muted">Select a network to see the required format.</div>

            <div id="addrClientError" class="err-row" aria-live="polite" hidden>
              <i class="fa-solid fa-circle-exclamation"></i>
              <span></span>
            </div>

            {% if form.address.errors %}
              <div class="err-row" style="margin-top:6px">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.address.errors.0 }}
              </div>
            {% endif %}
          </div>
          

          <!-- Label -->
          <div class="group">
            <div class="section-title">Label (optional)</div>
            {{ form.label }}
            {% if form.label.errors %}
              <div class="err-row" style="margin-top:8px">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.label.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="group" style="display:flex;gap:10px;justify-content:center">
            <button class="submit" type="submit">Save Address</button>
            <a href="{% url 'withdrawal' %}" class="submit" style="background:#6b7280;border-color:#6b7280;">Back</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
  const scope = document.querySelector('.wdw');
  if (!scope) return;

  // Elements
  const form = scope.querySelector('form');
  const addrRow = scope.querySelector('#addrRow');
  const addrInput = scope.querySelector('input[name="{{ form.address.name }}"]') || scope.querySelector('#walletAddress');
  const hintEl = scope.querySelector('#addrHint');
  const clientErrRow = scope.querySelector('#addrClientError');
  const clientErrText = clientErrRow ? clientErrRow.querySelector('span') : null;

  // Make the radio pills clickable + keep radios in sync
  scope.querySelectorAll('.method .opt').forEach(label=>{
    const input = label.querySelector('input[type="radio"]');
    label.addEventListener('click', ()=>{
      label.closest('.method').querySelectorAll('.opt').forEach(l=>l.classList.remove('active'));
      label.classList.add('active');
      if (input) {
        input.checked = true;
        input.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  });

  // Regex patterns & hints
  const patterns = {
    ETH: /^0x[a-fA-F0-9]{40}$/,
    TRC20: /^T[1-9A-HJ-NP-Za-km-z]{33}$/
  };
  const hints = {
    ETH: 'Ethereum address must start with 0x and be 42 characters total (0x + 40 hex).',
    TRC20: 'TRC20 address must start with T and be 34 characters (Base58).'
  };

  function getSelectedNetwork() {
    const checked = scope.querySelector('input[type="radio"][name="{{ form.address_type.name }}"]:checked');
    if (checked && checked.value) return checked.value;
    const activePill = scope.querySelector('.method .opt.active input[type="radio"]');
    return activePill ? activePill.value : null;
  }

  function updateHint() {
    const net = getSelectedNetwork();
    if (!hintEl) return;
    hintEl.textContent = net ? hints[net] : 'Select a network to see the required format.';
  }

  function showClientError(msg) {
    if (clientErrRow && clientErrText) {
      clientErrText.textContent = msg;
      clientErrRow.hidden = false;
    }
    addrRow.classList.add('error');
    if (addrInput) addrInput.setAttribute('aria-invalid','true');
  }

  function clearClientError() {
    if (clientErrRow && clientErrText) {
      clientErrText.textContent = '';
      clientErrRow.hidden = true;
    }
    addrRow.classList.remove('error');
    if (addrInput) addrInput.removeAttribute('aria-invalid');
  }

  function validateInline() {
    clearClientError();
    const net = getSelectedNetwork();
    const val = (addrInput && addrInput.value || '').trim();
    if (!net || !val) return true; // don't nag yet
    if (!patterns[net].test(val)) {
      showClientError(`This address is not a valid ${net === 'ETH' ? 'Ethereum (ERC-20)' : 'USDT (TRC-20)'} address for the selected network.`);
      return false;
    }
    return true;
  }

  // Events
  scope.querySelectorAll('input[type="radio"][name="{{ form.address_type.name }}"]').forEach(r=>{
    r.addEventListener('change', () => { updateHint(); validateInline(); });
  });
  if (addrInput) {
    addrInput.addEventListener('input', clearClientError);
    addrInput.addEventListener('blur', validateInline);
  }

  if (form) {
    form.addEventListener('submit', (e) => {
      const net = getSelectedNetwork();
      const val = (addrInput && addrInput.value || '').trim();

      if (!net) {
        e.preventDefault();
        showClientError('Please select a network (Ethereum or USDT TRC20).');
        return;
      }
      if (!val) {
        e.preventDefault();
        showClientError('Please paste your wallet address.');
        if (addrInput) addrInput.focus();
        return;
      }
      if (!patterns[net].test(val)) {
        e.preventDefault();
        showClientError(`The address you entered is not valid for ${net === 'ETH' ? 'Ethereum (ERC-20)' : 'USDT (TRC-20)'}.\nTip: ${hints[net]}`);
        if (addrInput) addrInput.focus();
      }
    });
  }

  // Init on load
  updateHint();
  const checked = scope.querySelector('input[type="radio"][name="{{ form.address_type.name }}"]:checked');
  if (checked) {
    const pill = checked.closest('.opt');
    if (pill) pill.classList.add('active');
  }
})();
</script>

<script>
  (function(){
    const form = document.querySelector('.wdw form');
    const btn  = form ? form.querySelector('button[type="submit"]') : null;
    if (!form || !btn) return;
  
    form.addEventListener('submit', function(){
      // Disable to stop double posts that can trigger constraint races
      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      const orig = btn.textContent;
      btn.dataset.orig = orig;
      btn.textContent = 'Saving...';
    });
  })();
  </script>
  
{% endblock %}
