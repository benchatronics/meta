{% extends "base_user.html" %}
{% load static %}

{% block title %}Add Payout Address{% endblock %}
{% block breadcrumb %}Home / my Wallet / Add Address{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'meta_search/withdrawal.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<section class="wdw">
  <div class="shell">
    <h1>Add Payout Address</h1>

    {% if messages %}
      <div class="flash" aria-live="polite">
        {% for message in messages %}
          <div class="alert {{ message.tags|default:'info' }}" role="alert">
            {% if 'success' in message.tags %}
              <i class="fa-solid fa-circle-check"></i>
            {% elif 'error' in message.tags or 'danger' in message.tags %}
              <i class="fa-solid fa-circle-xmark"></i>
            {% elif 'warning' in message.tags %}
              <i class="fa-solid fa-triangle-exclamation"></i>
            {% else %}
              <i class="fa-solid fa-circle-info"></i>
            {% endif %}
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="card">
      <div class="inner">
        <form method="post" action="">
          {% csrf_token %}

          <!-- Address Type (ETH / TRC20) -->
          <div class="group">
            <div class="section-title">Address Type</div>
            <div class="method">
              {% for val, label in form.address_type.field.choices %}
                {% if val in 'ETH,TRC20' %}
                  {% with is_checked=form.address_type.value|default:form.address_type.initial %}
                    <label class="opt {% if is_checked == val %}active{% endif %}">
                      <input
                        type="radio"
                        name="{{ form.address_type.name }}"
                        value="{{ val }}"
                        class="sr-only"
                        {% if is_checked == val %}checked{% endif %}>
                      {% if val == 'ETH' %}
                        <span class="bullet eth">
                          <i class="fa-brands fa-ethereum" aria-hidden="true"></i>
                        </span>
                        <span>Ethereum (ERC20)</span>
                      {% else %}
                        <span class="bullet tether" aria-hidden="true">
                          <svg viewBox="0 0 32 32" role="img" focusable="false" aria-hidden="true">
                            <circle cx="16" cy="16" r="16" fill="#26a17b"></circle>
                            <path fill="#FFFFFF" d="M26 9.9c0-1-4.5-1.9-10-1.9S6 8.9 6 9.9c0 .8 2.7 1.5 6.5 1.8v2.7c-3.7.3-6.2 1-6.2 1.8 0 .8 2.5 1.5 6.2 1.8V24h4.9v-5.9c3.8-.3 6.6-1 6.6-1.9 0-.8-2.8-1.6-6.6-1.9V11.7C23.3 11.4 26 10.7 26 9.9z"/>
                          </svg>
                        </span>
                        <span>USDT (TRC20)</span>
                      {% endif %}
                    </label>
                  {% endwith %}
                {% endif %}
              {% endfor %}
            </div>
            {% if form.address_type.errors %}
              <div class="err-row" style="margin-top:8px">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.address_type.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Address + scan -->
          <div class="group addr-wrap">
            <div class="section-title">Address</div>
            <div class="addr {% if form.address.errors %}error{% endif %}">
              {{ form.address }}
              <button class="qr" type="button" title="Scan QR" id="openScan">
                <i class="fa-solid fa-qrcode"></i>
              </button>
            </div>

            {% if form.address.errors %}
              <div class="err-row">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.address.errors.0 }}
              </div>
            {% endif %}

            <div class="addr-actions">
              <span class="bind-help tooltip" tabindex="0"
                    data-tip="Scan a wallet QR or paste the address. TRC20 usually starts with ‘T’; Ethereum starts with ‘0x’.">
                <i class="fa-regular fa-circle-question" aria-hidden="true"></i>
                How to add the right address?
              </span>
            </div>
          </div>

          <!-- Label (optional) -->
          <div class="group">
            <div class="section-title">Label (optional)</div>
            {{ form.label }}
            {% if form.label.errors %}
              <div class="err-row" style="margin-top:8px">
                <i class="fa-solid fa-circle-exclamation"></i>
                {{ form.label.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="group" style="display:flex;gap:10px;justify-content:center">
            <button class="submit" type="submit">Save Address</button>
            <a href="{% url 'withdrawal' %}" class="submit" style="background:#6b7280;border-color:#6b7280;">Back</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- ============== QR Scan Modal ============== -->
<div id="qrModal" class="qr-modal" hidden>
  <div class="qr-dialog">
    <div class="qr-header">
      <strong>Scan Wallet QR</strong>
      <button type="button" class="qr-close" aria-label="Close">&times;</button>
    </div>

    <div class="qr-body">
      <div id="qrReader" style="width:100%;min-height:220px;display:flex;align-items:center;justify-content:center">
        <div id="qrFallback" class="muted" style="text-align:center;display:none">
          <p>Camera not available. You can still scan from an image.</p>
        </div>
      </div>

      <div class="qr-or">OR</div>

      <!-- File upload fallback (scan from image) -->
      <label class="qr-filebtn">
        <input id="qrFile" type="file" accept="image/*" capture="environment" hidden>
        Choose a QR image (PNG/JPG)
      </label>

      <div id="qrPreviewWrap" style="display:none;margin-top:10px">
        <div class="muted" style="margin-bottom:6px">Preview of selected image</div>
        <img id="qrPreview" alt="QR preview" style="max-width:100%;border-radius:10px;border:1px solid var(--line)">
      </div>

      <div class="qr-tip">
        Tip: TRC20 addresses start with <code>T</code>. Ethereum/ERC20 start with <code>0x</code>.
      </div>
    </div>

    <div class="qr-footer">
      <button type="button" class="qr-cam-switch" id="toggleFacing" data-facing="environment">Use Front Camera</button>
      <button type="button" class="qr-cancel">Cancel</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
<script>
/* Make the radio pills clickable */
document.querySelectorAll('.wdw .method .opt').forEach(label=>{
  const input = label.querySelector('input[type="radio"]');
  label.addEventListener('click', ()=>{
    label.closest('.method').querySelectorAll('.opt').forEach(l=>l.classList.remove('active'));
    label.classList.add('active');
    if (input) input.checked = true;
  });
});

(function(){
  const addrInput = document.getElementById('id_address') || document.querySelector('input[name="address"]');
  const modal     = document.getElementById('qrModal');
  const openBtn   = document.getElementById('openScan');
  const closeBtn  = modal.querySelector('.qr-close');
  const cancelBtn = modal.querySelector('.qr-cancel');
  const toggleBtn = document.getElementById('toggleFacing');
  const fileInput = document.getElementById('qrFile');
  const preview   = document.getElementById('qrPreview');
  const previewWrap = document.getElementById('qrPreviewWrap');
  const readerDiv = document.getElementById('qrReader');
  const fallbackDiv = document.getElementById('qrFallback');

  let html5QrCode = null;
  let cameraId = null;
  let facing = 'environment';

  const isSecure =
    location.protocol === 'https:' ||
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1';

  function showFlash(kind, text){
    let wrap = document.querySelector('.wdw .flash');
    if (!wrap){
      wrap = document.createElement('div');
      wrap.className = 'flash';
      const shell = document.querySelector('.wdw .shell');
      const card = document.querySelector('.wdw .card');
      shell.insertBefore(wrap, card);
    }
    const item = document.createElement('div');
    item.className = 'alert ' + kind;
    item.innerHTML = '<i class="fa-solid '+ (kind==='error'?'fa-circle-xmark':kind==='warning'?'fa-triangle-exclamation':'fa-circle-info') +'"></i><span>'+ text +'</span>';
    wrap.appendChild(item);
    setTimeout(()=>item.remove(), 5000);
  }

  openBtn.addEventListener('click', async ()=>{
    previewWrap.style.display = 'none';
    modal.hidden = false;

    if (!isSecure){
      // No camera on insecure origins
      fallbackDiv.style.display = 'block';
      readerDiv.style.minHeight = '0';
      showFlash('warning', 'Camera requires HTTPS (or localhost). Use the image upload below.');
      return;
    }

    try{
      const cams = await Html5Qrcode.getCameras();
      if (!cams || !cams.length){
        fallbackDiv.style.display = 'block';
        showFlash('warning', 'No camera found. Use the image upload below.');
        return;
      }
      // pick back camera if available
      const back = cams.find(c => /back|rear|environment/i.test(c.label));
      cameraId = (facing === 'environment' && back) ? back.id : cams[0].id;

      if (html5QrCode){ await stopScanner(); }
      html5QrCode = new Html5Qrcode('qrReader');
      await html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 240, height: 240 } },
        onScanSuccess,
        () => {}
      );
    }catch(err){
      console.warn(err);
      fallbackDiv.style.display = 'block';
      showFlash('warning', 'Unable to access camera. Try uploading a QR image instead.');
    }
  });

  async function stopScanner(){
    if (html5QrCode){
      try { await html5QrCode.stop(); await html5QrCode.clear(); } catch(e){}
      html5QrCode = null;
    }
  }

  function closeModal(){
    stopScanner().finally(()=> modal.hidden = true);
  }
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e)=>{ if(!modal.hidden && e.key==='Escape') closeModal(); });

  toggleBtn.addEventListener('click', async ()=>{
    facing = facing === 'environment' ? 'user' : 'environment';
    toggleBtn.textContent = facing === 'environment' ? 'Use Front Camera' : 'Use Back Camera';
    if (!modal.hidden) openBtn.click(); // restart with new facing
  });

  function onScanSuccess(text){
    const value = (text || '').trim();
    if (addrInput) addrInput.value = value;
    // quick hint by network
    const want = (document.querySelector('input[name="{{ form.address_type.name }}"]:checked')||{}).value;
    const isTRX = /^T[1-9A-HJ-NP-Za-km-z]{25,34}$/.test(value);
    const isETH = /^0x[a-fA-F0-9]{40}$/.test(value);
    if (want === 'TRC20' && !isTRX) showFlash('warning','Scanned code may not be TRC20 (usually starts with "T").');
    if (want === 'ETH' && !isETH)  showFlash('warning','Scanned code may not be Ethereum (starts with "0x").');
    closeModal();
  }

  // Image upload scan (with preview)
  fileInput.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    // preview
    const fr = new FileReader();
    fr.onload = () => {
      preview.src = fr.result;
      previewWrap.style.display = 'block';
    };
    fr.readAsDataURL(file);

    try{
      if (!html5QrCode) html5QrCode = new Html5Qrcode('qrReader');
      const result = await html5QrCode.scanFile(file, true); // shows the image inside #qrReader
      onScanSuccess(result);
    }catch(err){
      console.warn(err);
      showFlash('error', 'Could not read a QR from that image. Make sure the code is sharp and well-lit.');
    }
  });
})();
</script>
{% endblock %}
