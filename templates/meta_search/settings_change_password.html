{% extends "base_settings.html" %}
{% load i18n %}

{% block title %}{% trans "Settings — Change password" %}{% endblock %}
{% block breadcrumb %}Home / setting / change password{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
  /* Bridge to ensure global collapse from base_user works on this page too */
  #app.collapsed > .sidebar { width: 56px !important; }
  #app.collapsed > .sidebar .label { display: none !important; }
  #app.collapsed > .main { margin-left: 56px !important; }

  /* If your base uses a different collapsed width, change 56px accordingly. */
</style>
{% endblock %}

{% block settings_content %}
<h3>{% trans "Change password" %}</h3>
<div class="sub">
  {% trans "For security, confirm your phone, pass the captcha, then set a strong password." %}
</div>

<form method="post" action="{% url 'setting_change_password' %}">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ request.get_full_path }}">

  {% if messages %}
    <ul class="errorlist" style="margin-bottom:12px;">
      {% for message in messages %}<li>{{ message }}</li>{% endfor %}
    </ul>
  {% endif %}
  {% if form.non_field_errors %}
    <ul class="errorlist" style="margin-bottom:12px;">
      {% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
    </ul>
  {% endif %}

  <div class="form-grid">
    {# PHONE (like signin/signup) #}
    <label class="label" for="{{ form.phone_number.id_for_label }}">{% trans "Phone" %}</label>
    {{ form.phone_number.errors }}
    <div class="phone_number_field">
      {{ form.country_code }}
      {{ form.phone_number }}
    </div>
    {% if form.country_code.errors %}
      <ul class="errorlist">
        {% for err in form.country_code.errors %}<li>{{ err }}</li>{% endfor %}
      </ul>
    {% endif %}

    {# CAPTCHA — real widget #}
    <label class="label" for="{{ form.captcha.id_for_label }}">{% trans "Captcha" %}</label>
    {{ form.captcha.errors }}
    <div class="captcha-field">
      <!-- padlock -->
      <svg class="left-ic" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 1a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5zm-3 8V6a3 3 0 1 1 6 0v3H9z"/>
      </svg>
      {{ form.captcha }}
    </div>

    {# OLD PASSWORD #}
    <label class="label" for="{{ form.old_password.id_for_label }}">{% trans "Old password" %}</label>
    {{ form.old_password.errors }}
    <div class="field has-left-ic">
      <svg class="left-ic" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 1a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5zm-3 8V6a3 3 0 1 1 6 0v3H9z"/>
      </svg>
      {{ form.old_password }}
      <button type="button"
              class="eye-btn"
              data-target="{{ form.old_password.id_for_label }}"
              aria-label="{% trans 'Show/Hide password' %}"></button>
    </div>
    <div class="inline-actions">
      <a href="{% url 'password_reset_start' %}" class="link">{% trans "Forgot current password?" %}</a>
    </div>

    {# NEW PASSWORD #}
    <label class="label" for="{{ form.new_password1.id_for_label }}">{% trans "New password" %}</label>
    {{ form.new_password1.errors }}
    <div class="field has-left-ic">
      <svg class="left-ic" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 1a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5zm-3 8V6a3 3 0 1 1 6 0v3H9z"/>
      </svg>
      {{ form.new_password1 }}
      <button type="button"
              class="eye-btn"
              data-target="{{ form.new_password1.id_for_label }}"
              aria-label="{% trans 'Show/Hide password' %}"></button>
    </div>
    <div class="requirements">{% trans "Use 8+ characters with a mix of letters, numbers, and symbols." %}</div>
    <div class="strength">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      <span id="strengthLabel" class="strength-label"></span>
    </div>

    {# CONFIRM #}
    <label class="label" for="{{ form.new_password2.id_for_label }}">{% trans "Confirm password" %}</label>
    {{ form.new_password2.errors }}
    <div class="field has-left-ic">
      <svg class="left-ic" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 1a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5zm-3 8V6a3 3 0 1 1 6 0v3H9z"/>
      </svg>
      {{ form.new_password2 }}
      <button type="button"
              class="eye-btn"
              data-target="{{ form.new_password2.id_for_label }}"
              aria-label="{% trans 'Show/Hide password' %}"></button>
    </div>

    <div class="actions" style="margin-top:12px;">
      <button class="btn primary" type="submit">{% trans "Save Changes" %}</button>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  // Eye toggle
  document.querySelectorAll('.eye-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      const id = btn.getAttribute('data-target');
      const input = document.getElementById(id);
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.classList.toggle('on');
    });
  });

  // Strength meter + match
  (function(){
    const np = document.getElementById('{{ form.new_password1.id_for_label }}');
    const cp = document.getElementById('{{ form.new_password2.id_for_label }}');
    const bars = document.querySelectorAll('.strength .bar');
    const label = document.getElementById('strengthLabel');

    function score(p){
      let s=0; if(!p) return 0;
      if(p.length>=8) s++;
      if(/[A-Z]/.test(p)&&/[a-z]/.test(p)) s++;
      if(/[0-9]/.test(p)||/[^A-Za-z0-9]/.test(p)) s++;
      return Math.min(s,3);
    }
    function render(){
      const s=score(np?.value||'');
      bars.forEach((b,i)=>{
        b.classList.toggle('on', i<s);
        b.classList.remove('weak','fair','good');
        if(s===1&&i===0)b.classList.add('weak');
        if(s===2&&i<2)b.classList.add('fair');
        if(s===3&&i<3)b.classList.add('good');
      });
      if(label) label.textContent = s===0?'':(s===1?'Weak':s===2?'Fair':'Good');
    }
    function match(){
      if(!np||!cp) return;
      cp.setCustomValidity(cp.value && np.value !== cp.value ? 'Passwords do not match' : '');
    }

    np && np.addEventListener('input', ()=>{ render(); match(); });
    cp && cp.addEventListener('input', match);
    render();
  })();
</script>
{% endblock %}