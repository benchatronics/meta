{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}{% trans "My Wallet" %}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
 {% if user.is_authenticated %}
  <meta name="op-user-ref" content="{{ user.pk }}">
{% else %}
  <meta name="op-user-ref" content="">
{% endif %}

  <!-- Fonts (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Main layout styles -->
  <link rel="stylesheet" href="{% static 'meta_search/base_user_layout.css' %}">
  {% block extra_head %}{% endblock %}



  <style>
    /* tiny helpers for inline SVG icons */
    .icon{width:18px;height:18px;display:inline-block;vertical-align:-2px}
    .icon.sm{width:16px;height:16px}
    .icon.lg{width:20px;height:20px}
    .text-ink{color:#1b1b1b}
  </style>
</head>
<body>

  <!-- ===== Inline SVG SPRITE (your icons) â€” available site-wide ===== -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
    <!-- home -->
    <symbol id="i-home" viewBox="0 0 24 24">
      <path d="M8 17H16M11.0177 2.764L4.23539 8.03912C3.78202 8.39175 3.55534 8.56806 3.39203 8.78886C3.24737 8.98444 3.1396 9.20478 3.07403 9.43905C3 9.70352 3 9.9907 3 10.5651V17.8C3 18.9201 3 19.4801 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4801 21 18.9201 21 17.8V10.5651C21 9.9907 21 9.70352 20.926 9.43905C20.8604 9.20478 20.7526 8.98444 20.608 8.78886C20.4447 8.56806 20.218 8.39175 19.7646 8.03913L12.9823 2.764C12.631 2.49075 12.4553 2.35412 12.2613 2.3016C12.0902 2.25526 11.9098 2.25526 11.7387 2.3016C11.5447 2.35412 11.369 2.49075 11.0177 2.764Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- task -->
    <symbol id="i-task" viewBox="0 0 24 24">
      <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- rewards -->
    <symbol id="i-reward" viewBox="0 0 24 24">
      <path d="M12 6V22M12 6H8.46429C7.94332 6 7.4437 5.78929 7.07533 5.41421C6.70695 5.03914 6.5 4.53043 6.5 4C6.5 3.46957 6.70695 2.96086 7.07533 2.58579C7.4437 2.21071 7.94332 2 8.46429 2C11.2143 2 12 6 12 6ZM12 6H15.5357C16.0567 6 16.5563 5.78929 16.9247 5.41421C17.293 5.03914 17.5 4.53043 17.5 4C17.5 3.46957 17.293 2.96086 16.9247 2.58579C16.5563 2.21071 16.0567 2 15.5357 2C12.7857 2 12 6 12 6ZM20 11V18.8C20 19.9201 20 20.4802 19.782 20.908C19.5903 21.2843 19.2843 21.5903 18.908 21.782C18.4802 22 17.9201 22 16.8 22L7.2 22C6.07989 22 5.51984 22 5.09202 21.782C4.71569 21.5903 4.40973 21.2843 4.21799 20.908C4 20.4802 4 19.9201 4 18.8V11M2 7.6L2 9.4C2 9.96005 2 10.2401 2.10899 10.454C2.20487 10.6422 2.35785 10.7951 2.54601 10.891C2.75992 11 3.03995 11 3.6 11H20.4C20.9601 11 21.2401 11 21.454 10.891C21.6422 10.7951 21.7951 10.6422 21.891 10.454C22 10.2401 22 9.96005 22 9.4V7.6C22 7.03995 22 6.75992 21.891 6.54601C21.7951 6.35785 21.6422 6.20487 21.454 6.10899C21.2401 6 20.9601 6 20.4 6H3.6C3.03995 6 2.75992 6 2.54601 6.10899C2.35785 6.20487 2.20487 6.35785 2.10899 6.54601C2 6.75992 2 7.03995 2 7.6Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- wallet -->
    <symbol id="i-wallet" viewBox="0 0 24 24">
      <path d="M20 9.5V7.2C20 6.0799 20 5.51984 19.782 5.09202C19.5903 4.7157 19.2843 4.40974 18.908 4.21799C18.4802 4 17.9201 4 16.8 4H5.2C4.0799 4 3.51984 4 3.09202 4.21799C2.7157 4.40973 2.40973 4.71569 2.21799 5.09202C2 5.51984 2 6.0799 2 7.2V16.8C2 17.9201 2 18.4802 2.21799 18.908C2.40973 19.2843 2.71569 19.5903 3.09202 19.782C3.51984 20 4.07989 20 5.2 20L16.8 20C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V14.5M15 12C15 11.5353 15 11.303 15.0384 11.1098C15.1962 10.3164 15.8164 9.69624 16.6098 9.53843C16.803 9.5 17.0353 9.5 17.5 9.5H19.5C19.9647 9.5 20.197 9.5 20.3902 9.53843C21.1836 9.69624 21.8038 10.3164 21.9616 11.1098C22 11.303 22 11.5353 22 12C22 12.4647 22 12.697 21.9616 12.8902C21.8038 13.6836 21.1836 14.3038 20.3902 14.4616C20.197 14.5 19.9647 14.5 19.5 14.5H17.5C17.0353 14.5 16.803 14.5 16.6098 14.4616C15.8164 14.3038 15.1962 13.6836 15.0384 12.8902C15 12.697 15 12.4647 15 12Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- info -->
    <symbol id="i-info" viewBox="0 0 24 24">
      <path d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- settings -->
    <symbol id="i-settings" viewBox="0 0 24 24">
      <path d="M9.39504 19.3711L9.97949 20.6856C10.1532 21.0768 10.4368 21.4093 10.7957 21.6426C11.1547 21.8759 11.5736 22.0001 12.0017 22C12.4298 22.0001 12.8488 21.8759 13.2077 21.6426C13.5667 21.4093 13.8502 21.0768 14.0239 20.6856L14.6084 19.3711C14.8164 18.9047 15.1664 18.5159 15.6084 18.26C16.0532 18.0034 16.5677 17.8941 17.0784 17.9478L18.5084 18.1C18.934 18.145 19.3636 18.0656 19.7451 17.8713C20.1265 17.6771 20.4434 17.3763 20.6573 17.0056C20.8714 16.635 20.9735 16.2103 20.951 15.7829C20.9285 15.3555 20.7825 14.9438 20.5306 14.5978L19.6839 13.4344C19.3825 13.0171 19.2214 12.5148 19.2239 12C19.2238 11.4866 19.3864 10.9864 19.6884 10.5711L20.535 9.40778C20.7869 9.06175 20.933 8.65007 20.9554 8.22267C20.9779 7.79528 20.8759 7.37054 20.6617 7C20.4478 6.62923 20.1309 6.32849 19.7495 6.13423C19.3681 5.93997 18.9385 5.86053 18.5128 5.90556L17.0828 6.05778C16.5722 6.11141 16.0576 6.00212 15.6128 5.74556C15.1699 5.48825 14.8199 5.09736 14.6128 4.62889L14.0239 3.31444C13.8502 2.92317 13.5667 2.59072 13.2077 2.3574C12.8488 2.12408 12.4298 1.99993 12.0017 2C11.5736 1.99993 11.1547 2.12408 10.7957 2.3574C10.4368 2.59072 10.1532 2.92317 9.97949 3.31444L9.39504 4.62889C9.18797 5.09736 8.83792 5.48825 8.39504 5.74556C7.95026 6.00212 7.43571 6.11141 6.92504 6.05778L5.4906 5.90556C5.06493 5.86053 4.63534 5.93997 4.25391 6.13423C3.87249 6.32849 3.55561 6.62923 3.34171 7C3.12753 7.37054 3.02549 7.79528 3.04798 8.22267C3.07046 8.65007 3.2165 9.06175 3.46838 9.40778L4.31504 10.5711C4.61698 10.9864 4.77958 11.4866 4.77949 12C4.77958 12.5134 4.61698 13.0137 4.31504 13.4289L3.46838 14.5922C3.2165 14.9382 3.07046 15.3499 3.04798 15.7773C3.02549 16.2047 3.12753 16.6295 3.34171 17C3.55582 17.3706 3.87274 17.6712 4.25411 17.8654C4.63548 18.0596 5.06496 18.1392 5.4906 18.0944L6.9206 17.9422C7.43127 17.8886 7.94581 17.9979 8.3906 18.2544C8.83513 18.511 9.18681 18.902 9.39504 19.3711Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M11.9999 15C13.6568 15 14.9999 13.6569 14.9999 12C14.9999 10.3431 13.6568 9 11.9999 9C10.3431 9 8.99992 10.3431 8.99992 12C8.99992 13.6569 10.3431 15 11.9999 15Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!--signinreward-->
    <svg width="0" height="0" style="position:absolute">
      <symbol id="i-signinreward" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <!-- bow loops -->
        <path d="M12 7C10.2 4 7 4.5 7.2 6.3c.2 1.7 2.3 2.2 4.8.7"/>
        <path d="M12 7c1.8-3 5-2.5 4.8-.7-.2 1.7-2.3 2.2-4.8.7"/>
        <!-- lid -->
        <rect x="3" y="9.5" width="18" height="3" rx=".6"/>
        <!-- box -->
        <rect x="4" y="12.5" width="16" height="8.5" rx="1.2"/>
        <!-- vertical ribbon -->
        <path d="M12 9.5v11.5"/>
      </symbol>
    </svg>

    <!-- logout -->
    <symbol id="i-logout" viewBox="0 0 24 24">
      <path d="M16 17L21 12M21 12L16 7M21 12H9M12 17C12 17.2956 12 17.4434 11.989 17.5714C11.8748 18.902 10.8949 19.9968 9.58503 20.2573C9.45903 20.2823 9.31202 20.2987 9.01835 20.3313L7.99694 20.4448C6.46248 20.6153 5.69521 20.7005 5.08566 20.5055C4.27293 20.2454 3.60942 19.6515 3.26118 18.8725C3 18.2882 3 17.5162 3 15.9723V8.0277C3 6.48377 3 5.7118 3.26118 5.12752C3.60942 4.34848 4.27293 3.7546 5.08566 3.49453C5.69521 3.29947 6.46246 3.38472 7.99694 3.55522L9.01835 3.66871C9.31212 3.70135 9.45901 3.71767 9.58503 3.74273C10.8949 4.00316 11.8748 5.09804 11.989 6.42861C12 6.55663 12 6.70442 12 7"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- notifications -->
    <symbol id="i-bell" viewBox="0 0 24 24">
      <path d="M14.9997 19C14.9997 20.6569 13.6566 22 11.9997 22C10.3429 22 8.99972 20.6569 8.99972 19M13.7962 6.23856C14.2317 5.78864 14.4997 5.17562 14.4997 4.5C14.4997 3.11929 13.3804 2 11.9997 2C10.619 2 9.49972 3.11929 9.49972 4.5C9.49972 5.17562 9.76772 5.78864 10.2032 6.23856M17.9997 11.2C17.9997 9.82087 17.3676 8.49823 16.2424 7.52304C15.1171 6.54786 13.591 6 11.9997 6C10.4084 6 8.8823 6.54786 7.75708 7.52304C6.63186 8.49823 5.99972 9.82087 5.99972 11.2C5.99972 13.4818 5.43385 15.1506 4.72778 16.3447C3.92306 17.7056 3.5207 18.3861 3.53659 18.5486C3.55476 18.7346 3.58824 18.7933 3.73906 18.9036C3.87089 19 4.53323 19 5.85791 19H18.1415C19.4662 19 20.1286 19 20.2604 18.9036C20.4112 18.7933 20.4447 18.7346 20.4629 18.5486C20.4787 18.3861 20.0764 17.7056 19.2717 16.3447C18.5656 15.1506 17.9997 13.4818 17.9997 11.2Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>

    <!-- Impersonation icon -->
     <symbol id="i-impe" viewBox="0 0 24 24">
      <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.8"/>
      <path d="M3 21v-1a7 7 0 0 1 7-7h4a7 7 0 0 1 7 7v1"
            stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M16 9h5m0 0-2-2m2 2-2 2"
            stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M8 15H3m0 0 2-2m-2 2 2 2"
            stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
     </symbol>

     <!-- support -->
    <symbol id="i-support" viewBox="0 0 24 24">
      <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z"
            fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>


    <!-- side menu (hamburger) -->
    <symbol id="i-menu" viewBox="0 0 24 24">
      <path d="M3 12H21M3 6H21M9 18H21" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>
  <!-- ===== /sprite ===== -->

  <div class="app {% block app_classes %}{% endblock %}" id="app">
    <!-- Sidebar (fixed menu) -->

    <aside class="sidebar" id="sidebar" style="overflow-y:auto; -webkit-overflow-scrolling:touch;">

      <div class="brand">
        <a class="brand-button" href="{% url 'user_dashboard' %}" title="{% trans 'Dashboard' %}">
          <img src="{% static 'meta_search/logos/logo 2.png' %}" alt="{% trans 'Dashboard' %}" style="width:120px; height:50px; vertical-align:middle;">
        </a>
        <div class="brand-name"></div>
        <!-- Desktop-only toggle lives in the sidebar -->
        <button class="sb-toggle sb-toggle-desktop" id="sbToggleDesktop" aria-label="{% trans 'Collapse menu' %}" title="{% trans 'Collapse' %}">Â«</button>
      </div>

      {% static 'meta_search/images/avatar-placeholder.png' as avatar_placeholder %}
      <div class="profile"
           title="{{ request.user.nickname|default:request.user.get_full_name|default:request.user.username }}">
        <div class="avatar">
          {% if request.user.avatar %}
            <img src="{{ request.user.avatar.url }}" alt="{% trans 'User avatar' %}" width="48" height="48" loading="lazy" onerror="this.src='{{ avatar_placeholder }}'">
          {% elif request.user.avatar_url %}
            <img src="{{ request.user.avatar_url }}" alt="{% trans 'User avatar' %}" width="48" height="48" loading="lazy" onerror="this.src='{{ avatar_placeholder }}'">
          {% else %}
            <img src="{{ avatar_placeholder }}" alt="{% trans 'User avatar' %}" width="48" height="48" loading="lazy">
          {% endif %}
          <span class="status-dot"></span>
        </div>
        <div class="meta">
          <div class="id">{% trans "User ID" %}: {{ request.user.id }}</div>
          <div class="phone">{% trans "Phone" %}: {{ request.user.phone|default:'-' }}</div>
        </div>
      </div>

      <nav class="nav" aria-label="{% trans 'Sidebar' %}">
        <a class="link {% if active_page == 'home' %}active{% endif %}" href="{% url 'user_dashboard' %}" title="{% trans 'Home' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-home"/></svg>
          <span class="label">{% trans "Home" %}</span>
        </a>
         {% if request.user.is_authenticated and request.user.is_superuser %}

         <a class="link" href="{% url 'impersonate_release' %}" title="{% trans 'Home' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-impe"/></svg>
          <span class="label">{% trans "impersonation" %}</span>
        </a>
        {% endif %}
        <a class="link {% if active_page == 'task' %}active{% endif %}" href="{% url 'task_dashboard' %}" title="{% trans 'Task' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-task"/></svg>
          <span class="label">{% trans "Tasks" %}</span>
        </a>

         <a class="link {% if active_page == 'signinreward' %}active{% endif %}" href="{% url 'signinreward' %}" title="{% trans  signin_reward %}">
          <svg class="icon" aria-hidden="true"><use href="#i-signinreward"/></svg>
          <span class="label">{% trans "Sign-in Reward" %}</span>
        </a>

        <a class="link {% if active_page == 'rewards' %}active{% endif %}" href="{% url 'rewards' %}" title="{% trans 'Rewards' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-reward"/></svg>
          <span class="label">{% trans "Reward" %}</span>
        </a>

        <h6>{% trans "Account" %}</h6>

        <a class="link {% if active_page == 'wallet' %}active{% endif %}" href="{% url 'wallet' %}" title="{% trans 'My Wallet' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-wallet"/></svg>
          <span class="label">{% trans "Wallet" %}</span>
        </a>
        <a class="link {% if active_page == 'settings' %}active{% endif %}" href="{% url 'profile_settings' %}" title="{% trans 'Settings' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-settings"/></svg>
          <span class="label">{% trans "Settings" %}</span>
        </a>
        <a class="link {% if active_page == 'info' %}active{% endif %}" href="{% url 'info_index' %}" title="{% trans 'Info' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-info"/></svg>
          <span class="label">{% trans "Info" %}</span>
        </a>

        <div class="bottom">
          {% if request.user.is_authenticated and request.user.is_superuser %}
            <a class="link {% if active_page == 'admin' %}active{% endif %}" href="{% url 'admin_dashboard' %}" title="{% trans 'Admin Panel' %}">
              <!-- Using lock as Admin Panel icon -->
              <svg class="icon" aria-hidden="true">
                <use href="#i-settings"></use>
              </svg>
              <span class="label">{% trans "Admin Panel" %}</span>
            </a>
          {% endif %}

          {# Built-in Django Admin (staff access) #}
          {% if request.user.is_authenticated and request.user.is_staff %}
            <a class="link" href="{% url 'admin:index' %}" title="{% trans 'Admin settings' %}">
              <svg class="icon" aria-hidden="true"><use href="#i-settings"/></svg>
              <span class="label">{% trans "Admin settings" %}</span>
            </a>
          {% endif %}

          {% if request.user.is_authenticated and request.user.is_staff %}

         <a class="link" href="{% url 'support_dashboard' %}" title="{% trans 'Support' %}">
          <svg class="icon" aria-hidden="true"><use href="#i-support"/></svg>
          <span class="label">{% trans "Support" %}</span>
        </a>
        {% endif %}

          <a class="link" href="{% url 'signout' %}" title="{% trans 'Logout' %}">
            <svg class="icon" aria-hidden="true"><use href="#i-logout"/></svg>
            <span class="label">{% trans "Logout" %}</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main panel -->
    <main class="main">
      <!-- Topbar -->
      <div class="topbar">
        <!-- Left: breadcrumb / menu -->
        <div class="breadcrumb">
          <!-- MOBILE-ONLY TOGGLE (drawer) -->
          <button class="sb-toggle sb-toggle-mobile" id="sbToggleMobile" aria-label="{% trans 'Menu' %}" title="{% trans 'Menu' %}">â˜°</button>
          <!-- (Optional) text trail on large screens -->
          <span class="crumb-home" aria-hidden="true">
            <svg class="icon sm" aria-hidden="true"><use href="#i-home"/></svg>
          </span>
        </div>

        <!-- Center: page title (new overridable block) -->
        <div class="title-center" role="heading" aria-level="1">
          {% block page_title %}{{ block.super|default:"" }}{% endblock %}
        </div>

        <!-- Right: bell -->
        <div class="bell" title="{% trans 'Announcements' %}">
          <a href="{% url 'announcements' %}" aria-label="{% trans 'Announcements' %}">
            <svg class="icon" aria-hidden="true"><use href="#i-bell"/></svg>
          </a>
          {# Optional badge: <span class="badge">3</span> #}
        </div>
      </div>

      <!-- Page content -->
      {% block content %}{% endblock %}
    </main>
  </div>

  {% block extra_scripts %}
  <script>
    // ===== Collapse & Mobile Off-canvas (two toggles) =====
    const appEl = document.getElementById('app');
    const sbToggleDesktop = document.getElementById('sbToggleDesktop'); // desktop: collapse
    const sbToggleMobile  = document.getElementById('sbToggleMobile');  // mobile: drawer

    function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }

    function setCollapsed(collapsed){
      appEl.classList.toggle('collapsed', !!collapsed);
      if (sbToggleDesktop){
        sbToggleDesktop.textContent = 'â˜°';
        sbToggleDesktop.setAttribute('title', collapsed ? '{% filter escapejs %}{% trans "Expand" %}{% endfilter %}' : '{% filter escapejs %}{% trans "Collapse" %}{% endfilter %}');
      }
      try { localStorage.setItem('sb_collapsed', collapsed ? '1' : '0'); } catch(e){}
    }

    try {
      const saved = localStorage.getItem('sb_collapsed');
      if (saved === '1' && !isMobile()) setCollapsed(true);
    } catch(e){}

    sbToggleDesktop?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isMobile()) return;
      setCollapsed(!appEl.classList.contains('collapsed'));
    });

    sbToggleMobile?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!isMobile()) return;
      appEl.classList.toggle('nav-open');
    });

    document.addEventListener('click', (e) => {
      if (!appEl.classList.contains('nav-open')) return;
      const sidebar = document.getElementById('sidebar');
      if ((sidebar && sidebar.contains(e.target)) || e.target.closest('#sbToggleMobile')) return;
      appEl.classList.remove('nav-open');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') appEl.classList.remove('nav-open');
    });

    document.querySelectorAll('.nav .link').forEach(a=>{
      a.addEventListener('click', ()=>{
        if (isMobile()) appEl.classList.remove('nav-open');
      });
    });

    const mq = window.matchMedia('(max-width: 900px)');
    if (mq.addEventListener) {
      mq.addEventListener('change', () => {
        if (mq.matches) {
          appEl.classList.remove('collapsed');
          if (sbToggleMobile) sbToggleMobile.textContent = 'â˜°';
        } else {
          appEl.classList.remove('nav-open');
          try { if (localStorage.getItem('sb_collapsed') === '1') setCollapsed(true); } catch(e){}
        }
      });
    }
  </script>

  <!-- ======== MOBILE BOTTOM NAV ======== -->
  <nav class="mobile-bottom-nav" role="tablist" aria-label="{% trans 'Primary' %}">
    <a class="{% if active_page == 'home' %}active{% endif %}" href="{% url 'user_dashboard' %}" title="{% trans 'Home' %}" role="tab" aria-selected="{% if active_page == 'home' %}true{% else %}false{% endif %}">
      <svg class="icon" aria-hidden="true"><use href="#i-home"/></svg>
      <span>{% trans "Home" %}</span>
      <span class="dot" aria-hidden="true"></span>
    </a>
    <a class="{% if active_page == 'task' %}active{% endif %}" href="{% url 'task_dashboard' %}" title="{% trans 'Tasks' %}" role="tab" aria-selected="{% if active_page == 'task' %}true{% else %}false{% endif %}">
      <svg class="icon" aria-hidden="true"><use href="#i-task"/></svg>
      <span>{% trans "Tasks" %}</span>
      <span class="dot" aria-hidden="true"></span>
    </a>

    <a class="{% if active_page == 'rewards' %}active{% endif %}" href="{% url 'rewards' %}" title="{% trans 'Reward' %}" role="tab" aria-selected="{% if active_page == 'rewards' %}true{% else %}false{% endif %}">
      <svg class="icon" aria-hidden="true"><use href="#i-reward"/></svg>
      <span>{% trans "Reward" %}</span>
      <span class="dot" aria-hidden="true"></span>
    </a>

    <a class="{% if active_page == 'wallet' %}active{% endif %}" href="{% url 'wallet' %}" title="{% trans 'Wallet' %}" role="tab" aria-selected="{% if active_page == 'wallet' %}true{% else %}false{% endif %}">
      <svg class="icon" aria-hidden="true"><use href="#i-wallet"/></svg>
      <span>{% trans "Wallet" %}</span>
      <span class="dot" aria-hidden="true"></span>
    </a>
  </nav>
  <!-- ======== /MOBILE BOTTOM NAV ======== -->
  {# show live chat to users only #}
  {% if user.is_authenticated and user.is_staff or user.is_authenticated and user.is_superuser %}
  {# see nothing #}
  {% else %}
<!-- Live chat support-->
<!-- ORBITPEDIA SUPPORT WIDGET â€” BLUE + MOVABLE + SCOPED + CLICK-SAFE -->
<style>

/* bubble alignment */
#op-root .op-msg{display:flex; margin:8px 0}
#op-root .op-msg > .bubble{max-width:82%; padding:8px 10px; border-radius:12px}
#op-root .op-msg.agent{justify-content:flex-start}
#op-root .op-msg.agent > .bubble{background:#f1f5f9}
#op-root .op-msg.user{justify-content:flex-end}
#op-root .op-msg.user > .bubble{background:#e6f0ff}
#op-root .op-msg.sys{justify-content:center}
#op-root .op-msg.sys > .bubble{background:#f9fafb; color:#475569}

  /* All rules scoped to #op-root to avoid site CSS clashes */
  #op-root{position:fixed;z-index:9999;font-family:system-ui,Segoe UI,Roboto,Arial}

  /* Theme vars */
  #op-root{--op-blue:#2563eb; --op-blue-dark:#1e40af; --op-border:#e5e7eb;}

  #op-root .op-launcher{
    position:fixed;
    width:56px;height:56px;border-radius:999px;border:0;cursor:pointer;
    background:var(--op-blue);color:#fff;display:flex;align-items:center;justify-content:center;
    box-shadow:0 10px 30px rgba(0,0,0,.25);user-select:none;touch-action:none;
  }
  #op-root .op-launcher:hover{background:var(--op-blue-dark)}
  #op-root .op-launcher svg{width:26px;height:26px}
  #op-root .op-badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;border-radius:999px;
    background:#ff3b30;color:#fff;font-size:11px;line-height:18px;text-align:center;padding:0 4px;display:none}

  #op-root .op-panel{
    position:fixed;
    width:360px;max-width:92vw;height:520px;max-height:78vh;
    background:#fff;border:1px solid var(--op-border);border-radius:14px;display:none;flex-direction:column;
    box-shadow:0 18px 50px rgba(0,0,0,.25);overflow:hidden;user-select:none;touch-action:none;
  }
  #op-root .op-head{background:var(--op-blue);color:#fff;padding:10px 12px;display:flex;align-items:center;gap:8px;cursor:move}
  #op-root .op-title{font-weight:700;font-size:14px;flex:1}
  #op-root .op-actions{display:flex;gap:8px}
  #op-root .op-actions button{background:transparent;border:0;color:#fff;cursor:pointer}

  #op-root .op-body{flex:1;overflow:auto;background:#fafafa;padding:10px}
  #op-root .op-msg{margin:8px 0;padding:8px 10px;border-radius:10px;background:#f1f5f9}
  #op-root .op-msg.user{background:#eef6ff}

  #op-root .op-form{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
  #op-root .op-form input{flex:1;padding:10px;border:1px solid var(--op-border);border-radius:10px}
  #op-root .op-form button{padding:10px 14px;border:0;border-radius:10px;background:var(--op-blue);color:#fff;font-weight:600;cursor:pointer}
  #op-root .op-form button:hover{background:var(--op-blue-dark)}

  #op-root .op-human{margin:8px 10px 12px;border:0;border-radius:10px;padding:8px 10px;background:#f3f4f6;cursor:pointer}

  @media (max-width:480px){
    #op-root .op-panel{width:94vw;height:70vh}
  }
</style>

<div class="op-root" id="op-root" aria-live="polite">
  <!-- Launcher (round bubble) -->
  <button class="op-launcher" id="op-launcher" type="button" aria-label="Open chat">
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2ZM6 9h12v2H6V9Zm0-4h12v2H6V5Zm0 8h8v2H6v-2Z"/>
    </svg>
    <span class="op-badge" id="op-badge">1</span>
  </button>

  <!-- Panel (minimizable window) -->
  <section class="op-panel" id="op-panel" role="dialog" aria-label="Orbitpedia Support" aria-modal="false">
    <header class="op-head" id="op-drag-handle">
      <div class="op-title">Orbitpedia Support</div>
      <div class="op-actions">
        <button id="op-min" type="button" title="Minimize" aria-label="Minimize">
          <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><rect x="5" y="11" width="14" height="2"/></svg>
        </button>
        <button id="op-close" type="button" title="Close" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4l-6.3 6.3-1.42-1.42L9.17 12 2.88 5.71 4.3 4.29l6.29 6.3 6.3-6.3Z"/></svg>
        </button>
      </div>
    </header>

    <div class="op-body" id="op-body"></div>

    <div style="padding:8px 10px;border-top:1px solid #eee;background:#fff">
      <input id="op-name" placeholder="Your name" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
    </div>

    <form class="op-form" id="op-form">
      <input id="op-text" placeholder="Type a messageâ€¦" required>
      <button type="submit">Send</button>
    </form>

    <button id="op-human" class="op-human" type="button">Talk to a human</button>
  </section>
</div>

<script>
(function(){
  const API_BASE = "";
  const API = {
    start:    API_BASE + "/api/chat/start",
    messages: API_BASE + "/api/chat/messages",
    send:     API_BASE + "/api/chat/send",
    request:  API_BASE + "/api/chat/agent-request",
    heartbeat:API_BASE + "/api/chat/heartbeat",
  };

  // ---- NEW: guard if script injected twice ----
  if (window.__OP_WIDGET_BOUND__) return;
  window.__OP_WIDGET_BOUND__ = true;

  const launcher = document.getElementById("op-launcher");
  const badge    = document.getElementById("op-badge");
  const panel    = document.getElementById("op-panel");
  const handle   = document.getElementById("op-drag-handle");
  const actions  = handle ? handle.querySelector(".op-actions") : null;
  const minBtn   = document.getElementById("op-min");
  const closeBtn = document.getElementById("op-close");
  const bodyEl   = document.getElementById("op-body");
  const formEl   = document.getElementById("op-form");
  const nameEl   = document.getElementById("op-name");
  const textEl   = document.getElementById("op-text");
  const humanBtn = document.getElementById("op-human");

  // status bar
  const statusBar = document.createElement("div");
  statusBar.style.cssText = "font:12px/1.4 system-ui;background:#f3f4f6;color:#111;padding:8px 10px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1";
  statusBar.setAttribute("role","status");
  bodyEl.parentNode.insertBefore(statusBar, bodyEl);

  // ---- UPDATED: presence-aware status ----
  function setStatus(text, tone, presence){
    // presence: "online" | "away" | "offline" | undefined
    const suffix = presence ? ` (${presence})` : "";
    statusBar.textContent = (text || "") + suffix;
    if (tone === "agent")      { statusBar.style.background = "#e8fff1"; statusBar.style.color="#065f46"; }
    else if (tone === "queue") { statusBar.style.background = "#fff7ed"; statusBar.style.color="#9a3412"; }
    else                       { statusBar.style.background = "#f3f4f6"; statusBar.style.color="#111"; }
  }

  // agent badge
  const agentBadge = document.createElement("div");
  agentBadge.style.cssText = "display:none;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid #eee;background:#fff;position:sticky;top:36px;z-index:1";
  const agentImg = document.createElement("img");
  agentImg.width = 20; agentImg.height = 20;
  agentImg.style.cssText = "width:20px;height:20px;border-radius:999px;object-fit:cover;display:inline-block";
  const agentTxt = document.createElement("span");
  agentTxt.style.cssText = "font:12px/1.4 system-ui;color:#111";
  agentBadge.appendChild(agentImg);
  agentBadge.appendChild(agentTxt);
  statusBar.parentNode.insertBefore(agentBadge, bodyEl);

  let agentPresent = false;
  function showAgentBadge(ap){
    if (!ap) { agentPresent = false; agentBadge.style.display = "none"; return; }
    agentImg.src = ap.avatar || "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
    agentImg.alt = (ap.nickname || "Agent");
    agentTxt.textContent = `Connected to ${ap.nickname || 'Agent'}`;
    agentBadge.style.display = "flex";
    agentPresent = true;
  }

  // state
  let sessionId = null, lastId = 0, open = (localStorage.getItem("op_open")==="1"), unread = 0;
  let chatMode = "bot";
  let pollTimer = null, beatTimer = null;

  // ---- NEW: idempotency + optimistic state ----
  function makeNonce(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
  }
  const optimistic = new Map(); // nonce -> DOM row
  let sendLock = false;

  function getUserRef(){
    if (window.OP_USER_REF && String(window.OP_USER_REF).trim()) return String(window.OP_USER_REF).trim();
    const m = document.querySelector('meta[name="op-user-ref"]');
    if (m && m.content && m.content.trim()) return m.content.trim();
    if (launcher?.dataset?.userRef) return launcher.dataset.userRef.trim();
    if (panel?.dataset?.userRef) return panel.dataset.userRef.trim();
    return "";
  }
  function isRegisteredUser(){ return !!getUserRef(); }

  const CURRENT_USER = (getUserRef() || "anon");
  const SESSION_KEY  = `op_session_v2:${CURRENT_USER}`;
  const LAST_USERREF = "op_last_userref_v2";
  try{
    const last = localStorage.getItem(LAST_USERREF) || "";
    if (last !== CURRENT_USER){
      localStorage.removeItem("op_session");
      localStorage.setItem(LAST_USERREF, CURRENT_USER);
    }
  }catch{}

  function saveSession(id){ try{ localStorage.setItem(SESSION_KEY, String(id)); }catch{} }
  function loadSession(){ try{ return localStorage.getItem(SESSION_KEY) || null; }catch{ return null; } }
  function forgetSession(){ try{ localStorage.removeItem(SESSION_KEY); }catch{} }

  function vid(){
    try{
      const k = "op_vid";
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto && crypto.randomUUID ? crypto.randomUUID()
             : Math.random().toString(36).slice(2) + Date.now());
        localStorage.setItem(k, v);
      }
      return v;
    }catch(e){
      return (crypto && crypto.randomUUID ? crypto.randomUUID()
              : Math.random().toString(36).slice(2) + Date.now());
    }
  }

  function niceErrorText(raw, fallback){
    try{
      const txt = String(raw || "");
      const stripped = txt.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
      if (!stripped) return fallback;
      const head = stripped.slice(0, 240);
      return head + (stripped.length > 240 ? " â€¦" : "");
    }catch(e){ return fallback; }
  }

  const vw = ()=> window.innerWidth, vh = ()=> window.innerHeight;
  const clamp = (v,min,max)=> Math.min(Math.max(v,min),max);
  const setPos = (el,x,y)=> { el.style.left=x+"px"; el.style.top=y+"px"; };
  const savePos = (k,x,y)=> localStorage.setItem(k, JSON.stringify({x,y}));
  const readPos = (k)=> { try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch{ return null; } };
  function loadPositions(){
    const lp = readPos("op_launcher_pos") || { x: vw()-72, y: vh()-72 };
    setPos(launcher, clamp(lp.x,8,vw()-64), clamp(lp.y,8,vh()-64));
    const pw = Math.min(360, Math.floor(vw()*0.92));
    const ph = Math.min(520, Math.floor(vh()*0.78));
    const pp = readPos("op_panel_pos") || { x: vw()-pw-24, y: vh()-ph-96 };
    setPos(panel, clamp(pp.x,8,vw()-pw-8), clamp(pp.y,8,vh()-ph-8));
  }
  window.addEventListener("resize", loadPositions);

  function makeDraggable(dragHandle, targetEl, storageKey, onTap){
    if (!dragHandle || !targetEl) return;
    let sx=0, sy=0, ox=0, oy=0, dragging=false, moved=false, startTime=0;
    const CLICK_MOVE_PX = 4, CLICK_TIME_MS = 300;
    const isHeaderActionClick = (ev)=>{
      if (!actions) return false;
      const t = ('touches' in ev) ? ev.touches[0].target : ev.target;
      return !!(t && t.closest && t.closest('#op-drag-handle .op-actions'));
    };
    const start = (e)=>{
      if (dragHandle === handle && isHeaderActionClick(e)) return;
      const pt=('touches' in e)? e.touches[0] : e;
      sx = pt.clientX; sy = pt.clientY;
      const rect = targetEl.getBoundingClientRect(); ox = rect.left; oy = rect.top;
      dragging=true; moved=false; startTime=Date.now();
      e.preventDefault();
    };
    const move = (e)=>{
      if(!dragging) return;
      const pt=('touches' in e)? e.touches[0] : e;
      const dx = pt.clientX - sx, dy = pt.clientY - sy;
      if (Math.abs(dx) > CLICK_MOVE_PX || Math.abs(dy) > CLICK_MOVE_PX) moved = true;
      const maxX = vw() - targetEl.offsetWidth - 8;
      const maxY = vh() - targetEl.offsetHeight - 8;
      setPos(targetEl, clamp(ox+dx,8,maxX), clamp(oy+dy,8,maxY));
      e.preventDefault();
    };
    const end = ()=>{
      if(!dragging) return;
      dragging=false;
      const rect = targetEl.getBoundingClientRect();
      savePos(storageKey, rect.left, rect.top);
      const took = Date.now() - startTime;
      if (!moved && took <= CLICK_TIME_MS && typeof onTap === 'function') onTap();
    };
    dragHandle.addEventListener("mousedown", start, {passive:false});
    window.addEventListener("mousemove", move, {passive:false});
    window.addEventListener("mouseup", end, {passive:true});
    dragHandle.addEventListener("touchstart", start, {passive:false});
    window.addEventListener("touchmove", move, {passive:false});
    window.addEventListener("touchend", end, {passive:true});
  }

  function updateBadge(){ badge.style.display = unread>0 && !open ? "inline-block" : "none"; badge.textContent = String(unread); }
  function esc(s){return (s||"").replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));}

  // Base renderer (used by both normal + reconcile paths)
  function buildBubble(sender, author, text){
    const wrap = document.createElement("div");
    let roleClass = 'sys';
    if (sender === 'user') roleClass = 'user';
    else if (sender === 'agent') roleClass = 'agent';
    wrap.className = "op-msg " + roleClass;

    let prefix = "";
    if (sender === 'system' || sender === 'bot') {
      prefix = `<b>${esc(sender === 'bot' ? 'Assistant' : 'System')}</b>: `;
    } else if (sender === 'agent') {
      prefix = "";
    } else if (sender === 'user') {
      if (!isRegisteredUser()) {
        const label = author?.trim() ? author.trim() : "Guest";
        prefix = `<b>${esc(label)}</b>: `;
      }
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `${prefix}${esc(text || "")}`;
    wrap.appendChild(bubble);
    return wrap;
  }

  // ---- NEW: optimistic add (tags data-nonce and stores ref) ----
  function addMsgOptimistic(author, text, nonce){
    const el = buildBubble('user', author, text);
    if (nonce) el.dataset.nonce = nonce;
    bodyEl.appendChild(el);
    if (open){ bodyEl.scrollTop = bodyEl.scrollHeight; } else { unread++; updateBadge(); }
    if (nonce) optimistic.set(nonce, el);
  }

  // ---- NEW: reconcile-aware render of server messages ----
  function renderMsg(m){
    const sender = (m.sender_type || 'system').toLowerCase();
    // If this server message matches an optimistic one we showed, upgrade it in-place
    if (m.client_nonce && optimistic.has(m.client_nonce)){
      const el = optimistic.get(m.client_nonce);
      optimistic.delete(m.client_nonce);
      if (el && el.isConnected){
        // Rebuild bubble content to ensure parity with server (handles prefixes)
        const patched = buildBubble(sender, m.author || 'System', m.body || '');
        el.className = patched.className;               // align role class
        el.querySelector('.bubble').innerHTML = patched.querySelector('.bubble').innerHTML;
        el.dataset.nonce = '';                          // consumed
        // Do NOT increment unread here
        bodyEl.scrollTop = bodyEl.scrollHeight;
        return;
      }
    }

    // Normal path (non-optimistic or other senders)
    const el = buildBubble(sender, m.author || 'System', m.body || '');
    bodyEl.appendChild(el);
    if (open){ bodyEl.scrollTop = bodyEl.scrollHeight; } else { unread++; updateBadge(); }
  }

  // focus trap utilities (unchanged)
  let lastFocused = null;
  function focusables(container){
    return Array.from(container.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'))
      .filter(el => !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
  }
  function enableTrap(){
    if (!lastFocused) lastFocused = document.activeElement;
    const els = focusables(panel);
    if (els.length) els[0].focus({preventScroll:true});
    panel._onKeyTrap && panel.removeEventListener('keydown', panel._onKeyTrap);
    panel._onKeyTrap = function(e){
      if (e.key !== 'Tab') return;
      const items = focusables(panel);
      if (!items.length) return;
      const first = items[0], last = items[items.length-1];
      if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    };
    panel.addEventListener('keydown', panel._onKeyTrap);
  }
  function disableTrap(){
    panel._onKeyTrap && panel.removeEventListener('keydown', panel._onKeyTrap);
    panel._onKeyTrap = null;
    if (launcher && document.contains(launcher)) launcher.focus({preventScroll:true});
    lastFocused = null;
  }

  function showPanel(){ panel.style.display="flex"; open=true; try{ localStorage.setItem("op_open","1"); }catch{}; unread=0; updateBadge(); setTimeout(()=>bodyEl.scrollTop=bodyEl.scrollHeight,0); enableTrap(); }
  function hidePanel(){ panel.style.display="none"; open=false; try{ localStorage.setItem("op_open","0"); }catch{}; disableTrap(); }
  function togglePanel(){ open ? hidePanel() : showPanel(); }

  function botAutoReply(userText){
    if (chatMode !== "bot") return;
    const t = userText.trim().toLowerCase();
    if (/^(hi|hello|hey|good (morning|afternoon|evening))\b/.test(t)){
      renderMsg({sender_type:'system', author:'Assistant', body:'Hi! ðŸ‘‹ A human can join if you tap â€œTalk to human.â€ Meanwhile, tell me your issue and Iâ€™ll log it.'});
    } else {
      renderMsg({sender_type:'system', author:'Assistant', body:'Noted âœ… â€” tap â€œTalk to humanâ€ to connect to an agent, or keep chatting here and Iâ€™ll keep recording your details.'});
    }
  }

  async function start(){
    try{
      const userRef = getUserRef();
      const res = await fetch(API.start,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ visitor_id: vid(), user_ref: userRef }) });
      if(!res.ok){
        let raw = ''; try { raw = await res.text(); } catch {}
        renderMsg({sender_type:'system', author:'System', body: niceErrorText(raw, 'Could not start chat. Please try again later.')});
        return;
      }
      const data = await res.json();
      sessionId = data.session.id;
      saveSession(sessionId);
      setStatus('You are chatting with our assistant. Tap â€œTalk to humanâ€ to connect.', 'bot');

      pull();
      pollTimer && clearInterval(pollTimer);
      beatTimer && clearInterval(beatTimer);
      pollTimer = setInterval(pull, 2000);
      beatTimer = setInterval(beat, 30000);
    }catch(e){ renderMsg({sender_type:'system', author:'System', body:'Network error starting chat.'}); }
  }

  async function resumeOrStart(){
    const sid = loadSession();
    if (sid){
      sessionId = sid;
      const ok = await probeSession();
      if (ok){
        pull();
        pollTimer && clearInterval(pollTimer);
        beatTimer && clearInterval(beatTimer);
        pollTimer = setInterval(pull, 2000);
        beatTimer = setInterval(beat, 30000);
        return;
      } else { forgetSession(); sessionId = null; }
    }
    await start();
  }

  // ---- NEW: helper to set button state and status by payload
  function applyPresenceUI(data){
    const presence = (data && data.agent_status) || null; // "online"|"away"|"offline"|null
    const joined   = !!(data && data.agent_joined);
    const st       = (data && data.status) || "";

    // Badge
    if (data && data.agent_profile) showAgentBadge(data.agent_profile); else showAgentBadge(null);

    // Status text
    if (joined){
      setStatus('Connected to an agent. You can chat live now.', 'agent', presence || undefined);
    } else if (st === 'waiting_agent'){
      setStatus('Waiting for an agentâ€¦ You can keep typing; they will see your messages.', 'queue', presence || undefined);
    } else {
      setStatus('You are chatting with our assistant. Tap â€œTalk to humanâ€ to connect.', 'bot', presence || undefined);
    }

    // Button enable/disable
    const canRequest = !!(data && Object.prototype.hasOwnProperty.call(data, 'can_request_human') ? data.can_request_human : (st !== 'waiting_agent' && st !== 'agent_joined' && st !== 'resolved' && st !== 'closed'));
    if (humanBtn){
      humanBtn.disabled = !canRequest;
      humanBtn.setAttribute('aria-disabled', String(!canRequest));
    }
  }

  async function probeSession(){
    try{
      const r = await fetch(`${API.messages}?session=${encodeURIComponent(sessionId)}&after_id=0&t=${Date.now()}`);
      if(!r.ok) return false;
      const data = await r.json();
      if (data.status === 'resolved' || data.status === 'closed') return false;

      applyPresenceUI(data);

      (data.messages||[]).forEach(m=>{ renderMsg(m); lastId = m.id || lastId; });
      return true;
    }catch(e){ return false; }
  }

  function inferAgentFromPayload(payload){
    if (payload && (payload.agent_joined === true)) return true;
    if (Array.isArray(payload?.messages)){
      return payload.messages.some(m=> (m.sender_type||'').toLowerCase() === 'agent');
    }
    return false;
  }

  async function pull(){
    if(!sessionId) return;
    try{
      const res = await fetch(`${API.messages}?session=${encodeURIComponent(sessionId)}&after_id=${lastId}&t=${Date.now()}`);
      if(!res.ok) return;
      const data = await res.json();

      const st = (data && data.status) || "";
      if (st === "resolved" || st === "closed"){ forgetSession(); }

      // Presence + button state
      applyPresenceUI(data);

      // Mode switch if/when agent joins
      const agentNow = inferAgentFromPayload(data);
      if (agentNow && chatMode !== 'agent'){
        chatMode = 'agent';
        setStatus('Connected to an agent. You can chat live now.', 'agent', data.agent_status || undefined);
      }

      (data.messages||[]).forEach(m=>{ renderMsg(m); lastId = m.id || lastId; });
    }catch(e){}
  }

  async function beat(){
    if(!sessionId) return;
    try{ await fetch(API.heartbeat,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({session:sessionId}) }); }catch(e){}
  }

  async function send(e){
    e && e.preventDefault();
    if(!textEl || !textEl.value.trim()) return;
    if(!sessionId){ renderMsg({sender_type:'system', author:'System', body:'Starting chatâ€¦ please try again.'}); return; }

    const author = (nameEl && nameEl.value.trim()) || "Guest";
    const body   = textEl.value.trim();

    // ---- NEW: optimistic send with nonce ----
    const nonce = makeNonce();
    addMsgOptimistic(author, body, nonce);
    textEl.value="";
    botAutoReply(body);

    if (sendLock) return;
    sendLock = true;
    try{
      await fetch(API.send,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({session:sessionId, author, body, client_nonce: nonce})
      });
      // Do NOT call pull() here; interval poll will reconcile
    }catch(e){
      // On hard failure, remove optimistic bubble (optional UX)
      const el = optimistic.get(nonce);
      if (el && el.isConnected) el.remove();
      optimistic.delete(nonce);
    }finally{
      sendLock = false;
    }
  }

  async function requestHuman(){
    if(!sessionId){ renderMsg({sender_type:'system', author:'System', body:'Starting chatâ€¦ please try again.'}); return; }
    chatMode = 'queue';
    setStatus('Waiting for an agentâ€¦ You can keep typing; they will see your messages.', 'queue');
    renderMsg({sender_type:'system', author:'System', body:'An agent has been notified. Please hold on.'});
    try{
      const res = await fetch(API.request,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({session:sessionId}) });
      if(res.ok){ pull(); }
      else {
        let raw = ''; try { raw = await res.text(); } catch {}
        renderMsg({sender_type:'system', author:'System', body:niceErrorText(raw, 'Could not request a human right now.')});
        chatMode = 'bot';
        setStatus('You are chatting with our assistant. Tap â€œTalk to humanâ€ to connect.', 'bot');
      }
    }catch(e){
      chatMode = 'bot';
      setStatus('Network error. You can continue with the assistant and try again.', 'bot');
      renderMsg({sender_type:'system', author:'System', body:'Network error requesting human.'});
    }
  }

  function makeReady(){
    makeDraggable(launcher, launcher, "op_launcher_pos", togglePanel);
    makeDraggable(handle,   panel,    "op_panel_pos",  null);
    if (minBtn)  minBtn.addEventListener("click", (e)=>{ e.stopPropagation(); hidePanel(); });
    if (closeBtn) closeBtn.addEventListener("click",(e)=>{ e.stopPropagation(); hidePanel(); });
    if (formEl)   formEl.addEventListener("submit", send);
    if (humanBtn) humanBtn.addEventListener("click", requestHuman);
    document.addEventListener("pointerdown", (e)=>{ if (!open) return; if (panel.contains(e.target) || launcher.contains(e.target)) return; hidePanel(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && open) hidePanel(); });
    loadPositions();
    open ? showPanel() : hidePanel();
  }

  makeReady();
  resumeOrStart();

  window.opWidget = {
    open: showPanel,
    minimize: hidePanel,
    close: hidePanel,
    toggle: togglePanel,
    state: () => open ? 'open' : 'closed',
    sessionId: () => sessionId,
    mode: () => chatMode
  };
})();
</script>

<!--end of livesupport-->
{% endif %}

  {% endblock %}
</body>
</html>
