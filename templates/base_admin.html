{# templates/meta_search/base_admin.html #}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Admin Panel{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Fonts (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Admin layout styles -->
  <link rel="stylesheet" href="{% static 'meta_search/base_admin_layout.css' %}">
  {% block extra_head %}{% endblock %}
</head>
<body>
  <div class="app {% block app_classes %}{% endblock %}" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <a class="brand-button" href="{% url 'admin_dashboard' %}" title="Admin Dashboard">
          <img src="{% static 'meta_search/images/logo_emoji.png' %}" alt="Admin" style="width:20px; height:20px; vertical-align:middle;">
        </a>
        <div class="brand-name">Admin</div>
        <button class="sb-toggle sb-toggle-desktop" id="sbToggleDesktop" aria-label="Collapse menu" title="Collapse">¬´</button>
      </div>

      {% static 'meta_search/images/avatar-placeholder.png' as avatar_placeholder %}
      <div class="profile" title="{{ request.user.nickname|default:request.user.get_full_name|default:request.user.username }}">
        <div class="avatar">
          {% if request.user.avatar %}
            <img src="{{ request.user.avatar.url }}" alt="Admin avatar" width="48" height="48" loading="lazy" onerror="this.src='{{ avatar_placeholder }}'">
          {% elif request.user.avatar_url %}
            <img src="{{ request.user.avatar_url }}" alt="Admin avatar" width="48" height="48" loading="lazy" onerror="this.src='{{ avatar_placeholder }}'">
          {% else %}
            <img src="{{ avatar_placeholder }}" alt="Admin avatar" width="48" height="48" loading="lazy">
          {% endif %}
          <span class="status-dot"></span>
        </div>
        <div class="meta">
          <div class="id">Admin ID: {{ request.user.id }}</div>
          <div class="phone">Phone: {{ request.user.phone|default:'-' }}</div>
        </div>
      </div>

      <nav class="nav" aria-label="Sidebar">
        <a class="link {% if active_page == 'bo_dashboard' %}active{% endif %}" href="{% url 'admin_dashboard' %}" title="Dashboard">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9"/></svg>
          <span class="label">Dashboard</span>
        </a>

        <h6>Users</h6>
        <a class="link {% if active_page == 'bo_users' %}active{% endif %}" href="{% url 'bo_users' %}" title="Users">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <span class="label">Users</span>
        </a>

        <h6>Finance</h6>
        {# No global "wallets" index route; link to Users to access per-user wallets #}
        <a class="link {% if active_page == 'bo_users' %}active{% endif %}" href="{% url 'bo_users' %}" title="Wallets">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M2 10h20"/></svg>
          <span class="label">Wallets</span>
        </a>
        <a class="link {% if active_page == 'bo_withdrawals' %}active{% endif %}" href="{% url 'bo_withdrawals' %}" title="Withdrawals">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M7 10l5 5 5-5"/><rect x="3" y="17" width="18" height="4" rx="1"/></svg>
          <span class="label">Withdrawals</span>
        </a>
        <a class="link {% if active_page == 'bo_deposits' %}active{% endif %}" href="{% url 'bo_deposits' %}" title="Deposits">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21V9"/><path d="M17 14l-5-5-5 5"/><rect x="3" y="3" width="18" height="4" rx="1"/></svg>
          <span class="label">Deposits</span>
        </a>

        <h6>Tasks</h6>
        <a class="link {% if active_page == 'bo_tasks' %}active{% endif %}" href="{% url 'bo_tasks' %}" title="User Tasks">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 8h10M7 12h6"/></svg>
          <span class="label">User Tasks</span>
        </a>
        <a class="link {% if active_page == 'bo_templates' %}active{% endif %}" href="{% url 'bo_templates' %}" title="Task Templates">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H7l-4-4V5a2 2 0 0 1 2-2h7"/><path d="M16 3h5v5"/><path d="M10 13l2 2 5-5"/></svg>
          <span class="label">Task Templates</span>
        </a>
        <a class="link {% if active_page == 'bo_directives' %}active{% endif %}" href="{% url 'bo_directives' %}" title="Forced Tasks">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          <span class="label">Forced Tasks</span>
        </a>

        <h6>Content</h6>
        <a class="link {% if active_page == 'bo_announcements' %}active{% endif %}" href="{% url 'bo_announcements' %}" title="Announcements">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11v2a4 4 0 0 0 4 4h1l5 3v-6h3a4 4 0 0 0 4-4V7a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2z"/></svg>
          <span class="label">Announcements</span>
        </a>
        <a class="link {% if active_page == 'bo_info_pages' %}active{% endif %}" href="{% url 'bo_info_pages' %}" title="Info Pages">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          <span class="label">Info Pages</span>
        </a>

        <h6>System</h6>
        <a class="link {% if active_page == 'bo_settings' %}active{% endif %}" href="{% url 'bo_settings' %}" title="Settings">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15l-3 3 3 3"/><path d="M9 18h9a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3H8a3 3 0 0 0-3 3v9"/></svg>
          <span class="label">Settings</span>
        </a>

        <div class="bottom">
          <a class="link" href="{% url 'user_dashboard' %}" title="Back to App">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 3 12 15 21"/><line x1="3" y1="12" x2="21" y2="12"/></svg>
            <span class="label">Back to App</span>
          </a>
          <a class="link" href="{% url 'signout' %}" title="Logout">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            <span class="label">Logout</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main panel -->
    <main class="main">
      <!-- Topbar -->
      <div class="topbar">
        <div class="breadcrumb">
          <button class="sb-toggle sb-toggle-mobile" id="sbToggleMobile" aria-label="Menu" title="Menu">‚ò∞</button>
          <span class="crumb-home" aria-hidden="true">üõ†Ô∏è</span>
        </div>

        <div class="title-center" role="heading" aria-level="1">
          {% block page_title %}{{ block.super|default:"Admin" }}{% endblock %}
        </div>

        <div class="bell" title="Announcements">
          <a href="{% url 'bo_announcements' %}" aria-label="Announcements">üîî</a>
        </div>
      </div>

      {% block content %}{% endblock %}
    </main>
  </div>

  {% block extra_scripts %}
  <script>
    // ===== Sidebar collapse + mobile drawer (same behavior as user base) =====
    const appEl = document.getElementById('app');
    const sbToggleDesktop = document.getElementById('sbToggleDesktop');
    const sbToggleMobile  = document.getElementById('sbToggleMobile');

    function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }

    function setCollapsed(collapsed){
      appEl.classList.toggle('collapsed', !!collapsed);
      if (sbToggleDesktop){
        sbToggleDesktop.textContent = '‚ò∞';
        sbToggleDesktop.setAttribute('title', collapsed ? 'Expand' : 'Collapse');
      }
      try { localStorage.setItem('sb_collapsed_admin', collapsed ? '1' : '0'); } catch(e){}
    }

    try {
      const saved = localStorage.getItem('sb_collapsed_admin');
      if (saved === '1' && !isMobile()) setCollapsed(true);
    } catch(e){}

    sbToggleDesktop?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isMobile()) return;
      setCollapsed(!appEl.classList.contains('collapsed'));
    });

    sbToggleMobile?.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!isMobile()) return;
      appEl.classList.toggle('nav-open');
    });

    document.addEventListener('click', (e) => {
      if (!appEl.classList.contains('nav-open')) return;
      const sidebar = document.getElementById('sidebar');
      if ((sidebar && sidebar.contains(e.target)) || e.target.closest('#sbToggleMobile')) return;
      appEl.classList.remove('nav-open');
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') appEl.classList.remove('nav-open');
    });

    document.querySelectorAll('.nav .link').forEach(a=>{
      a.addEventListener('click', ()=>{
        if (isMobile()) appEl.classList.remove('nav-open');
      });
    });

    // sync collapse preference when resizing between mobile/desktop
    const mq = window.matchMedia('(max-width: 900px)');
    if (mq.addEventListener) {
      mq.addEventListener('change', () => {
        if (mq.matches) {
          appEl.classList.remove('collapsed');
        } else {
          appEl.classList.remove('nav-open');
          try { if (localStorage.getItem('sb_collapsed_admin') === '1') setCollapsed(true); } catch(e){}
        }
      });
    }
  </script>
  {% endblock %}
</body>
</html>
