{% extends "base_user.html" %}

{% block title %}Task Preview{% endblock %}
{% block page_title %} Task{% endblock %}
{% block breadcrumb %}Home / Task / Detail{% endblock %}

{% block extra_head %}
<style>
  :root{
    --primary:#0a66ff;
    --primary-600:#0a56d1;
    --text:#1a1a1a;
    --muted:#667085;
    --card:#ffffff;
    --soft:#f5f7fb;
    --ring:rgba(10,102,255,.28);
    --success:#22c55e;
    --success-600:#16a34a;
    --success-bg:#e9fbf2;
    --radius:16px;
  }
  .phone{width:min(520px, 100%); margin:0 auto; padding:16px}
  .back-btn{appearance:none; border:0; background:transparent; color:var(--primary); font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 4px; margin-bottom:12px}
  .task-card{background:var(--card); border-radius:var(--radius); box-shadow:0 8px 30px rgba(16,24,40,.08); overflow:hidden; border:1px solid #eef2f6}
  .task-img{width:100%; height:240px; object-fit:cover; display:block}

  .task-info{padding:18px}
  .task-info h2{margin:0 0 6px; font-size:28px; letter-spacing:.2px}
  .subtitle{margin:0 0 14px; color:var(--muted); font-size:15px}

  .rating{display:inline-flex; align-items:center; gap:8px; background:var(--success-bg); color:var(--success-600); padding:4px 10px; border-radius:10px; font-weight:600; margin:2px 0 18px}
  .rating .score{background:#fff; border:1px solid #d7f5e6; padding:2px 6px; border-radius:6px}

  .row{display:grid; grid-template-columns:1fr auto; gap:16px; padding:10px 0; border-top:1px dashed #eef1f5}
  .row:first-of-type{border-top:0}
  .row .label{color:#98a2b3; font-weight:600; letter-spacing:.2px; display:flex; align-items:center; gap:8px}
  .row .value{font-weight:600}

  .info-box{background:var(--soft); border:1px solid #e6ebf3; border-radius:12px; padding:12px; display:grid; gap:8px; margin:14px 0 10px}
  .info-item{display:flex; align-items:center; gap:10px; font-weight:600}
  .info-item .hint{color:#475467; font-weight:500}

  .commission{ text-align:center; font-weight:700; margin:6px 0 12px; letter-spacing:.3px }

  .submit-btn{width:100%; padding:14px 16px; border-radius:12px; border:0; color:#fff; background:var(--primary); font-weight:700; cursor:pointer; box-shadow:0 6px 16px var(--ring)}
  .submit-btn:hover{background:var(--primary-600)}
  .submit-btn[disabled]{opacity:.6; cursor:not-allowed}
  @media (max-width:390px){ .task-info h2{font-size:24px} .task-img{height:210px} }

  /* ===== Success Modal (only injected for ADMIN tasks) ===== */
  .modal-overlay{position:fixed; inset:0; display:grid; place-items:center; background:rgba(2,6,23,.46); backdrop-filter:saturate(140%) blur(2px); opacity:0; pointer-events:none; transition:opacity .18s ease; z-index:5000;}
  .modal-overlay.on{opacity:1; pointer-events:auto;}
  .modal-card{position:relative; width:min(520px,92vw); background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 24px 60px rgba(2,6,23,.28); text-align:center;}
  .modal-hero{height:180px; background:var(--success); display:grid; place-items:center;}
  .modal-hero svg{width:68px; height:68px; stroke:#fff; stroke-width:6; fill:none; stroke-linecap:round; stroke-linejoin:round;}
  .modal-body{padding:18px 18px 22px;}
  .modal-title{margin:.2em 0 .3em; font-size:24px; font-weight:800; color:#0f172a;}
  .modal-text{margin:0 0 14px; color:#64748b; line-height:1.6;}
  .modal-btn{display:block; width:88%; margin:0 auto 12px; padding:14px 16px; border-radius:12px; text-decoration:none; font-weight:700; color:#fff; background:var(--success);}
  .modal-btn:hover{filter:brightness(1.03);}
  .modal-x{position:absolute; top:10px; right:10px; width:30px; height:30px; border-radius:999px; border:0; background:#111827; color:#fff; display:grid; place-items:center; font-size:18px; cursor:pointer;}
</style>
{% endblock %}

{% block content %}
<div class="phone">
  <button class="back-btn" type="button" onclick="history.back()">&#x2039;</button>
<style>
.back-btn{
  font: 600 18px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 8px 12px;
  border: 1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  cursor:pointer;
}
.back-btn:hover{ background:#f9fafb }
.back-btn:active{ transform: translateY(1px) }
</style>

  <article class="task-card">
    {% comment %} Cover image with sensible fallbacks {% endcomment %}
    {% if task.template.cover_image %}
      <img class="task-img" src="{{ task.template.cover_image.url }}" alt="{{ task.template.hotel_name }}">
    {% elif task.template.cover_image_url %}
      <img class="task-img" src="{{ task.template.cover_image_url }}" alt="{{ task.template.hotel_name }}">
    {% else %}
      <img class="task-img" src="https://images.unsplash.com/photo-1522706604294-54b45f6b3924?q=80&w=1964&auto=format&fit=crop" alt="Task image">
    {% endif %}

    <div class="task-info">
      <h2>{{ task.template.hotel_name }}</h2>
      <p class="subtitle">
        {{ task.template.city }}, {{ task.template.country }}
      </p>

      {% if task.template.task_score or task.template.task_label %}
        <div class="rating">
          {% if task.template.task_score %}<span class="score">{{ task.template.task_score }}</span>{% endif %}
          <!-- rating star icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M11.2827 3.45332C11.5131 2.98638 11.6284 2.75291 11.7848 2.67831C11.9209 2.61341 12.0791 2.61341 12.2152 2.67831C12.3717 2.75291 12.4869 2.98638 12.7174 3.45332L14.9041 7.88328C14.9721 8.02113 15.0061 8.09006 15.0558 8.14358C15.0999 8.19096 15.1527 8.22935 15.2113 8.25662C15.2776 8.28742 15.3536 8.29854 15.5057 8.32077L20.397 9.03571C20.9121 9.11099 21.1696 9.14863 21.2888 9.27444C21.3925 9.38389 21.4412 9.5343 21.4215 9.68377C21.3988 9.85558 21.2124 10.0372 20.8395 10.4004L17.3014 13.8464C17.1912 13.9538 17.136 14.0076 17.1004 14.0715C17.0689 14.128 17.0487 14.1902 17.0409 14.2545C17.0321 14.3271 17.0451 14.403 17.0711 14.5547L17.906 19.4221C17.994 19.9355 18.038 20.1922 17.9553 20.3445C17.8833 20.477 17.7554 20.57 17.6071 20.5975C17.4366 20.6291 17.2061 20.5078 16.7451 20.2654L12.3724 17.9658C12.2361 17.8942 12.168 17.8584 12.0962 17.8443C12.0327 17.8318 11.9673 17.8318 11.9038 17.8443C11.832 17.8584 11.7639 17.8942 11.6277 17.9658L7.25492 20.2654C6.79392 20.5078 6.56341 20.6291 6.39297 20.5975C6.24468 20.57 6.11672 20.477 6.04474 20.3445C5.962 20.1922 6.00603 19.9355 6.09407 19.4221L6.92889 14.5547C6.95491 14.403 6.96793 14.3271 6.95912 14.2545C6.95132 14.1902 6.93111 14.128 6.89961 14.0715C6.86402 14.0076 6.80888 13.9538 6.69859 13.8464L3.16056 10.4004C2.78766 10.0372 2.60121 9.85558 2.57853 9.68377C2.55879 9.5343 2.60755 9.38389 2.71125 9.27444C2.83044 9.14863 3.08797 9.11099 3.60304 9.03571L8.49431 8.32077C8.64642 8.29854 8.72248 8.28742 8.78872 8.25662C8.84736 8.22935 8.90016 8.19096 8.94419 8.14358C8.99391 8.09006 9.02793 8.02113 9.09597 7.88328L11.2827 3.45332Z"/>
          </svg>
          <span>{{ task.template.get_task_label_display|default:"Rated" }}</span>
        </div>
      {% endif %}

      <div class="row">
        <div class="label">
          <!-- task icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z"/>
          </svg>
          Order ID
        </div>
        <div class="value">{{ task.template.task_id }}</div>
      </div>

      <div class="row">
        <div class="label">
          <!-- calendar icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 8H3M16 2V5M8 2V5M7.8 22H16.2C17.8802 22 18.7202 22 19.362 21.673C19.9265 21.3854 20.3854 20.9265 20.673 20.362C21 19.7202 21 18.8802 21 17.2V8.8C21 7.11984 21 6.27976 20.673 5.63803C20.3854 5.07354 19.9265 4.6146 19.362 4.32698C18.7202 4 17.8802 4 16.2 4H7.8C6.11984 4 5.27976 4 4.63803 4.32698C4.07354 4.6146 3.6146 5.07354 3.32698 5.63803C3 6.27976 3 7.11984 3 8.8V17.2C3 18.8802 3 19.7202 3.32698 20.362C3.6146 20.9265 4.07354 21.3854 4.63803 21.673C5.27976 22 6.11984 22 7.8 22ZM11.9973 12.3306C11.1975 11.4216 9.8639 11.1771 8.86188 12.0094C7.85986 12.8418 7.71879 14.2335 8.50568 15.2179C9.077 15.9327 10.6593 17.3397 11.4833 18.0569C11.662 18.2124 11.7513 18.2902 11.856 18.321C11.9466 18.3477 12.0479 18.3477 12.1386 18.321C12.2432 18.2902 12.3325 18.2124 12.5112 18.0569C13.3353 17.3397 14.9175 15.9327 15.4888 15.2179C16.2757 14.2335 16.1519 12.8331 15.1326 12.0094C14.1134 11.1858 12.797 11.4216 11.9973 12.3306Z"/>
          </svg>
          Date
        </div>
        <div class="value">{{ task.created_at|date:"d/m/Y" }}</div>
      </div>

      <div class="info-box">
        <!-- location icon -->
        <div class="info-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z"/>
            <path d="M12 22C16 18 20 14.4183 20 10C20 5.58172 16.4183 2 12 2C7.58172 2 4 5.58172 4 10C4 14.4183 8 18 12 22Z"/>
          </svg>
          <span class="hint">{{ task.template.country }}{% if task.template.city %}, {{ task.template.city }}{% endif %}</span>
        </div>

        <!-- wallet icon for price -->
        <div class="info-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M20 9.5V7.2C20 6.0799 20 5.51984 19.782 5.09202C19.5903 4.7157 19.2843 4.40974 18.908 4.21799C18.4802 4 17.9201 4 16.8 4H5.2C4.0799 4 3.51984 4 3.09202 4.21799C2.7157 4.40973 2.40973 4.71569 2.21799 5.09202C2 5.51984 2 6.0799 2 7.2V16.8C2 17.9201 2 18.4802 2.21799 18.908C2.40973 19.2843 2.71569 19.5903 3.09202 19.782C3.51984 20 4.07989 20 5.2 20L16.8 20C17.9201 20 18.4802 20 18.908 19.782C19.2843 19.5903 19.5903 19.2843 19.782 18.908C20 18.4802 20 17.9201 20 16.8V14.5M15 12C15 11.5353 15 11.303 15.0384 11.1098C15.1962 10.3164 15.8164 9.69624 16.6098 9.53843C16.803 9.5 17.0353 9.5 17.5 9.5H19.5C19.9647 9.5 20.197 9.5 20.3902 9.53843C21.1836 9.69624 21.8038 10.3164 21.9616 11.1098C22 11.303 22 11.5353 22 12C22 12.4647 22 12.697 21.9616 12.8902C21.8038 13.6836 21.1836 14.3038 20.3902 14.4616C20.197 14.5 19.9647 14.5 19.5 14.5H17.5C17.0353 14.5 16.803 14.5 16.6098 14.4616C15.8164 14.3038 15.1962 13.6836 15.0384 12.8902C15 12.697 15 12.4647 15 12Z"/>
          </svg>
          <span class="hint">€{{ task.price_used }}</span>
        </div>

        <!-- commission icon -->
        <div class="info-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 18.5H15M7 15H17M5 2H19C20.1046 2 21 2.99492 21 4.22222V19.7778C21 21.0051 20.1046 22 19 22H5C3.89543 22 3 21.0051 3 19.7778V4.22222C3 2.99492 3.89543 2 5 2ZM11.9976 6.21194C11.2978 5.4328 10.1309 5.22321 9.25414 5.93667C8.37738 6.65013 8.25394 7.84299 8.94247 8.6868C9.631 9.53061 11.9976 11.5 11.9976 11.5C11.9976 11.5 14.3642 9.53061 15.0527 8.6868C15.7413 7.84299 15.6329 6.64262 14.7411 5.93667C13.8492 5.23072 12.6974 5.4328 11.9976 6.21194Z" stroke="#1B63FF"/>
          </svg>
          <span class="hint">€{{ task.commission_used }}</span>
        </div>
      </div>

      <div class="commission">
        {% if task.task_kind == task.Kind.ADMIN %}
          Admin commission: €{{ task.commission_used }}
        {% else %}
          Commission: €{{ task.commission_used }}
        {% endif %}
      </div>

      <form method="post">
        {% csrf_token %}
        <button class="submit-btn"
                type="submit"
                name="submit_task"
                {% if task.status != task.Status.IN_PROGRESS %}disabled{% endif %}>
          {% if task.status == task.Status.IN_PROGRESS %}
            Submit
          {% elif task.status == task.Status.SUBMITTED %}
            Submitted (waiting)
          {% elif task.status == task.Status.APPROVED %}
            Completed
          {% else %}
            {{ task.get_status_display }}
          {% endif %}
        </button>
      </form>
    </div>
  </article>
</div>

{% comment %}
Success modal — only rendered for ADMIN tasks.
Shown automatically on first visit (per task) using localStorage.
{% endcomment %}
{% if task.task_kind == task.Kind.ADMIN %}
<div class="modal-overlay" id="adminCongrats" role="dialog" aria-modal="true" aria-labelledby="admTitle" aria-describedby="admBody" hidden>
  <div class="modal-card">
    <button class="modal-x" type="button" aria-label="Close">×</button>
    <div class="modal-hero">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="modal-body">
      <h3 id="admTitle" class="modal-title">Congratulations!</h3>
      <p id="admBody" class="modal-text">
        You have received a platinum package. For more info please contact customer service.
      </p>
      <a class="modal-btn" href="{% url 'info_index' %}#support">Customer care</a>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
{% if task.task_kind == task.Kind.ADMIN %}
<script>
(function(){
  const overlay = document.getElementById('adminCongrats');
  if (!overlay) return;

  const key = 'seen_admin_task_{{ task.pk }}';
  try { if (localStorage.getItem(key) === '1') return; } catch(e){}

  function openModal(){
    overlay.hidden = false;
    requestAnimationFrame(()=> overlay.classList.add('on'));
  }
  function closeModal(){
    overlay.classList.remove('on');
    setTimeout(()=> overlay.hidden = true, 160);
    try { localStorage.setItem(key,'1'); } catch(e){}
  }

  openModal();

  overlay.querySelector('.modal-x')?.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=> { if (e.target === overlay) closeModal(); });
  document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeModal(); }, { once: true });
  window.addEventListener('pageshow', e => { if (e.persisted) overlay.hidden = true; });
})();
</script>
{% endif %}
{% endblock %}
