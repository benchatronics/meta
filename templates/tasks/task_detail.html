{% extends "base_user.html" %}

{% block title %}Task Preview{% endblock %}
{% block page_title %} Task{% endblock %}
{% block breadcrumb %}Home / Task / Detail{% endblock %}

{% block extra_head %}
<style>
  :root{
    --primary:#0a66ff;
    --primary-600:#0a56d1;
    --text:#1a1a1a;
    --muted:#667085;
    --card:#ffffff;
    --soft:#f5f7fb;
    --ring:rgba(10,102,255,.28);
    --success:#22c55e;
    --success-600:#16a34a;
    --success-bg:#e9fbf2;
    --radius:16px;
  }
  .phone{width:min(520px, 100%); margin:0 auto; padding:16px}
  .back-btn{appearance:none; border:0; background:transparent; color:var(--primary); font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; padding:8px 4px; margin-bottom:12px}
  .task-card{background:var(--card); border-radius:var(--radius); box-shadow:0 8px 30px rgba(16,24,40,.08); overflow:hidden; border:1px solid #eef2f6}
  .task-img{width:100%; height:240px; object-fit:cover; display:block}

  .task-info{padding:18px}
  .task-info h2{margin:0 0 6px; font-size:28px; letter-spacing:.2px}
  .subtitle{margin:0 0 14px; color:var(--muted); font-size:15px}

  .rating{display:inline-flex; align-items:center; gap:8px; background:var(--success-bg); color:var(--success-600); padding:4px 10px; border-radius:10px; font-weight:600; margin:2px 0 18px}
  .rating .score{background:#fff; border:1px solid #d7f5e6; padding:2px 6px; border-radius:6px}

  .row{display:grid; grid-template-columns:1fr auto; gap:16px; padding:10px 0; border-top:1px dashed #eef1f5}
  .row:first-of-type{border-top:0}
  .row .label{color:#98a2b3; font-weight:600; letter-spacing:.2px; display:flex; align-items:center; gap:8px}
  .row .value{font-weight:600}

  .info-box{background:var(--soft); border:1px solid #e6ebf3; border-radius:12px; padding:12px; display:grid; gap:8px; margin:14px 0 10px}
  .info-item{display:flex; align-items:center; gap:10px; font-weight:600}
  .info-item .hint{color:#475467; font-weight:500}

  .commission{ text-align:center; font-weight:700; margin:6px 0 12px; letter-spacing:.3px }

  .submit-btn{width:100%; padding:14px 16px; border-radius:12px; border:0; color:#fff; background:var(--primary); font-weight:700; cursor:pointer; box-shadow:0 6px 16px var(--ring)}
  .submit-btn:hover{background:var(--primary-600)}
  .submit-btn[disabled]{opacity:.6; cursor:not-allowed}
  @media (max-width:390px){ .task-info h2{font-size:24px} .task-img{height:210px} }

  /* ===== Success Modal (only injected for ADMIN tasks) ===== */
  .modal-overlay{position:fixed; inset:0; display:grid; place-items:center; background:rgba(2,6,23,.46); backdrop-filter:saturate(140%) blur(2px); opacity:0; pointer-events:none; transition:opacity .18s ease; z-index:5000;}
  .modal-overlay.on{opacity:1; pointer-events:auto;}
  .modal-card{position:relative; width:min(520px,92vw); background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 24px 60px rgba(2,6,23,.28); text-align:center;}
  .modal-hero{height:180px; background:var(--success); display:grid; place-items:center;}
  .modal-hero svg{width:68px; height:68px; stroke:#fff; stroke-width:6; fill:none; stroke-linecap:round; stroke-linejoin:round;}
  .modal-body{padding:18px 18px 22px;}
  .modal-title{margin:.2em 0 .3em; font-size:24px; font-weight:800; color:#0f172a;}
  .modal-text{margin:0 0 14px; color:#64748b; line-height:1.6;}
  .modal-btn{display:block; width:88%; margin:0 auto 12px; padding:14px 16px; border-radius:12px; text-decoration:none; font-weight:700; color:#fff; background:var(--success);}
  .modal-btn:hover{filter:brightness(1.03);}
  .modal-x{position:absolute; top:10px; right:10px; width:30px; height:30px; border-radius:999px; border:0; background:#111827; color:#fff; display:grid; place-items:center; font-size:18px; cursor:pointer;}
</style>
{% endblock %}

{% block content %}
<div class="phone">
  <button class="back-btn" type="button" onclick="history.back()">&#x2039;</button>
<style>
.back-btn{
  font: 600 18px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 8px 12px;
  border: 1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  cursor:pointer;
}
.back-btn:hover{ background:#f9fafb }
.back-btn:active{ transform: translateY(1px) }
</style>

  <article class="task-card">
    {% comment %} Cover image with sensible fallbacks {% endcomment %}
    {% if task.template.cover_image %}
      <img class="task-img" src="{{ task.template.cover_image.url }}" alt="{{ task.template.hotel_name }}">
    {% elif task.template.cover_image_url %}
      <img class="task-img" src="{{ task.template.cover_image_url }}" alt="{{ task.template.hotel_name }}">
    {% else %}
      <img class="task-img" src="https://images.unsplash.com/photo-1522706604294-54b45f6b3924?q=80&w=1964&auto=format&fit=crop" alt="Task image">
    {% endif %}

    <div class="task-info">
      <h2>{{ task.template.hotel_name }}</h2>
      <p class="subtitle">
        {{ task.template.city }}, {{ task.template.country }}
      </p>

      {% if task.template.task_score or task.template.task_label %}
        <div class="rating">
          {% if task.template.task_score %}<span class="score">{{ task.template.task_score }}</span>{% endif %}
          <!-- rating star icon -->
          <span>{{ task.template.get_task_label_display|default:"Rated" }}</span>
        </div>
      {% endif %}

      <div class="row">
        <div class="label">
          <!-- task icon -->
          Order ID
        </div>
        <div class="value">{{ task.template.task_id }}</div>
      </div>

      <div class="row">
        <div class="label">
          <!-- calendar icon -->
          Date
        </div>
        <div class="value">{{ task.created_at|date:"d/m/Y" }}</div>
      </div>

      <div class="info-box">
        <!-- location icon -->
        <div class="info-item">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               xmlns="http://www.w3.org/2000/svg" stroke="#1B1B1B" stroke-width="1.4"
               stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z"/>
            <path d="M12 22C16 18 20 14.4183 20 10C20 5.58172 16.4183 2 12 2C7.58172 2 4 5.58172 4 10C4 14.4183 8 18 12 22Z"/>
          </svg>
          <span class="hint">{{ task.template.country }}{% if task.template.city %}, {{ task.template.city }}{% endif %}</span>
        </div>

        <!-- wallet icon for price -->
        <div class="info-item">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13 5C13 6.10457 10.5376 7 7.5 7C4.46243 7 2 6.10457 2 5M13 5C13 3.89543 10.5376 3 7.5 3C4.46243 3 2 3.89543 2 5M13 5V9.45715C11.7785 9.82398 11 10.3789 11 11M2 5V17C2 18.1046 4.46243 19 7.5 19C8.82963 19 10.0491 18.8284 11 18.5429V11M2 9C2 10.1046 4.46243 11 7.5 11C8.82963 11 10.0491 10.8284 11 10.5429M2 13C2 14.1046 4.46243 15 7.5 15C8.82963 15 10.0491 14.8284 11 14.5429M22 11C22 12.1046 19.5376 13 16.5 13C13.4624 13 11 12.1046 11 11M22 11C22 9.89543 19.5376 9 16.5 9C13.4624 9 11 9.89543 11 11M22 11V19C22 20.1046 19.5376 21 16.5 21C13.4624 21 11 20.1046 11 19V11M22 15C22 16.1046 19.5376 17 16.5 17C13.4624 17 11 16.1046 11 15" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>    <span class="hint">€{{ task.price_used }}X5</span>
        </div>

        <!-- commission icon -->
        <div class="info-item">
       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M13.5295 8.35186C12.9571 8.75995 12.2566 9 11.5 9C9.567 9 8 7.433 8 5.5C8 3.567 9.567 2 11.5 2C12.753 2 13.8522 2.65842 14.4705 3.64814M6 20.0872H8.61029C8.95063 20.0872 9.28888 20.1277 9.61881 20.2086L12.3769 20.8789C12.9753 21.0247 13.5988 21.0388 14.2035 20.9214L17.253 20.3281C18.0585 20.1712 18.7996 19.7854 19.3803 19.2205L21.5379 17.1217C22.154 16.5234 22.154 15.5524 21.5379 14.9531C20.9832 14.4134 20.1047 14.3527 19.4771 14.8103L16.9626 16.6449C16.6025 16.9081 16.1643 17.0498 15.7137 17.0498H13.2855L14.8311 17.0498C15.7022 17.0498 16.4079 16.3633 16.4079 15.5159V15.2091C16.4079 14.5055 15.9156 13.892 15.2141 13.7219L12.8286 13.1417C12.4404 13.0476 12.0428 13 11.6431 13C10.6783 13 8.93189 13.7988 8.93189 13.7988L6 15.0249M20 6.5C20 8.433 18.433 10 16.5 10C14.567 10 13 8.433 13 6.5C13 4.567 14.567 3 16.5 3C18.433 3 20 4.567 20 6.5ZM2 14.6L2 20.4C2 20.9601 2 21.2401 2.10899 21.454C2.20487 21.6422 2.35785 21.7951 2.54601 21.891C2.75992 22 3.03995 22 3.6 22H4.4C4.96005 22 5.24008 22 5.45399 21.891C5.64215 21.7951 5.79513 21.6422 5.89101 21.454C6 21.2401 6 20.9601 6 20.4V14.6C6 14.0399 6 13.7599 5.89101 13.546C5.79513 13.3578 5.64215 13.2049 5.45399 13.109C5.24008 13 4.96005 13 4.4 13L3.6 13C3.03995 13 2.75992 13 2.54601 13.109C2.35785 13.2049 2.20487 13.3578 2.10899 13.546C2 13.7599 2 14.0399 2 14.6Z" stroke="#1B1B1B" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>   <span class="hint">€{{ task.commission_used }}</span>
        </div>
      </div>

      <div class="commission">
        {% if task.task_kind == task.Kind.ADMIN %}
          1X commission: €{{ task.commission_used }}
        {% else %}
          Commission: €{{ task.commission_used }}
        {% endif %}
      </div>

      <form method="post">
        {% csrf_token %}
        <button class="submit-btn"
                type="submit"
                name="submit_task"
                {% if task.status != task.Status.IN_PROGRESS %}disabled{% endif %}>
          {% if task.status == task.Status.IN_PROGRESS %}
            Submit
          {% elif task.status == task.Status.SUBMITTED %}
            Submitted (waiting)
          {% elif task.status == task.Status.APPROVED %}
            Completed
          {% else %}
            {{ task.get_status_display }}
          {% endif %}
        </button>
      </form>
    </div>
  </article>
</div>

{% comment %}
Success modal — only rendered for ADMIN tasks.
Shown automatically on first visit (per task) using localStorage.
{% endcomment %}
{% if task.task_kind == task.Kind.ADMIN %}
<div class="modal-overlay" id="adminCongrats" role="dialog" aria-modal="true" aria-labelledby="admTitle" aria-describedby="admBody" hidden>
  <div class="modal-card">
    <button class="modal-x" type="button" aria-label="Close">×</button>
    <div class="modal-hero">
      <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="modal-body">
      <h3 id="admTitle" class="modal-title">Congratulations!</h3>
      <p id="admBody" class="modal-text">
        You have received a platinum package. For more info please contact customer service.
      </p>
      <a class="modal-btn" href="{% url 'info_index' %}#support">Customer care</a>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
{% if task.task_kind == task.Kind.ADMIN %}
<script>
(function(){
  const overlay = document.getElementById('adminCongrats');
  if (!overlay) return;

  const key = 'seen_admin_task_{{ task.pk }}';
  try { if (localStorage.getItem(key) === '1') return; } catch(e){}

  function openModal(){
    overlay.hidden = false;
    requestAnimationFrame(()=> overlay.classList.add('on'));
  }
  function closeModal(){
    overlay.classList.remove('on');
    setTimeout(()=> overlay.hidden = true, 160);
    try { localStorage.setItem(key,'1'); } catch(e){}
  }

  openModal();

  overlay.querySelector('.modal-x')?.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=> { if (e.target === overlay) closeModal(); });
  document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeModal(); }, { once: true });
  window.addEventListener('pageshow', e => { if (e.persisted) overlay.hidden = true; });
})();
</script>
{% endif %}
{% endblock %}
