{% extends "base_user.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Tasks Dashboard" %}{% endblock %}
{% block page_title %}{% trans "Tasks Dashboard" %}{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'meta_search/task_dashboard.css' %}">

<style>
/* ======================
   GLOBAL helpers (all screens)
   ====================== */
.desktop-only{ display:block; }
@media (max-width: 768px){ .desktop-only{ display:none; } }
@media (min-width: 769px){ .mobile-only{ display:none; } }

/* Overlays & modal — available on ALL screens so desktop doesn’t show raw text */
.loader-overlay{
  position:fixed; inset:0;
  display:grid; place-items:center;
  background:rgba(15,23,42,.35);
  backdrop-filter:saturate(140%) blur(1.5px);
  opacity:0; pointer-events:none;
  transition:opacity .18s ease;
  z-index:5000;
}
.loader-overlay.on{ opacity:1; pointer-events:auto; }
.loader-card{
  width:min(440px, 92vw);
  background:#fff; border-radius:16px;
  box-shadow:0 10px 30px rgba(2,6,23,.15);
  padding:22px 20px 18px; text-align:center;
}
.loader-dots{ display:flex; gap:16px; justify-content:center; margin:6px 0 12px; }
.loader-dot{ width:16px; height:16px; border-radius:999px; animation:pop 1.1s infinite ease-in-out; }
.loader-dot:nth-child(1){ background:#2563eb; animation-delay:0s; }
.loader-dot:nth-child(2){ background:#f59e0b; animation-delay:.12s; }
.loader-dot:nth-child(3){ background:#16a34a; animation-delay:.24s; }
.loader-dot:nth-child(4){ background:#ef4444; animation-delay:.36s; }
@keyframes pop{ 0%,80%,100%{ transform:scale(.6); opacity:.65; } 40%{ transform:scale(1); opacity:1; } }
.loader-text{ font-weight:800; font-size:18px; color:#0f172a; }
.loader-sub{ margin-top:2px; font-size:13px; color:#64748b; }

.limit-overlay{
  position:fixed; inset:0; z-index:6000;
  display:none; place-items:center;
  background:rgba(15,23,42,.45);
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}
.limit-overlay.on{ display:grid; }
.limit-card{
  width:min(460px,94vw);
  background:#fff; border-radius:16px; overflow:hidden;
  box-shadow:0 12px 34px rgba(2,6,23,.24);
}
.limit-top{
  background:#dc2626; height:160px; position:relative;
  display:grid; place-items:center;
}
.limit-x{
  width:86px; height:86px; border-radius:999px;
  border:3px solid #fff; display:grid; place-items:center; color:#fff; font-size:44px; line-height:1;
}
.limit-body{ padding:20px; text-align:center; }
.limit-title{ font-size:24px; font-weight:800; color:#0f172a; margin:6px 0 6px; }
.limit-text{ color:#6b7280; font-size:15px; line-height:1.45; }
.limit-btn{
  margin:16px auto 8px; display:inline-flex; align-items:center; justify-content:center;
  padding:14px 18px; border-radius:12px; border:none; cursor:pointer;
  background:#dc2626; color:#fff; font-weight:800; width:min(320px,76vw);
}
.limit-close{
  position:absolute; right:10px; top:10px; width:30px; height:30px;
  border-radius:999px; background:#111; color:#fff; border:none; cursor:pointer; font-size:16px;
  display:grid; place-items:center;
}

/* ===== MOBILE (UPDATED to fit full screen) ===== */
@media screen and (max-width: 768px){
  :root{
    --blue:#0a63ff; --blue2:#0052cc; --bg:#f5f7fa; --text:#0f172a;
    --muted:#6b7280; --card:#ffffff; --ring:rgba(10,99,255,.10);
    --green:#10b981; --shadow:0 6px 22px rgba(15,23,42,.06);
  }

  /* removed the 480px cap; use the full viewport width with comfy gutters */
  .wrap{
    max-width: none !important;
    width: 100% !important;
    margin: 0 auto;
    padding-left: clamp(12px, 4vw, 18px);
    padding-right: clamp(12px, 4vw, 18px);
  }

  .cards{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin:10px 0 18px;
  }

  .card{
    background:var(--card);
    border-radius:16px;
    padding:16px;
    box-shadow:var(--shadow);
  }
  .card .top{display:flex;align-items:center;justify-content:space-between}
  .card .label{font-size:14px;color:#8b95a5;font-weight:600}
  .badge{width:38px;height:38px;border-radius:999px;background:#f4f7ff;color:#3b82f6;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 10px var(--ring)}
  .badge svg{width:22px;height:22px}
  .value{
    margin-top:12px;
    font-weight:700;
    font-size: clamp(16px, 5.2vw, 22px);
    line-height:1.1;
    font-variant-numeric: tabular-nums;
    letter-spacing:0;
    white-space:nowrap;
  }

  .banner{
    background:linear-gradient(135deg,var(--blue2),var(--blue));
    border-radius:12px;
    color:#fff;
    text-align:center;
    padding:26px 16px 0;
    margin:6px 0 8px;
    position:relative;
    overflow:hidden;
  }
  .banner h2{margin:0 0 10px;font-weight:700}
  .hero-img{
    display:block;
    margin:12px auto -1px;
    width: min(90vw, 360px);
    height:auto;
    box-shadow:0 6px 18px var(--ring);
  }

  .today{
    margin:10px 0 12px;
    text-align:center;
    color:#6b7280;
    font-size:14px;
  }

  .btn{
    display:block; width:100%;
    text-align:center; background:#0a63ff; color:#fff; text-decoration:none;
    padding:14px 16px; border-radius:10px; font-weight:700;
    box-shadow:0 10px 20px var(--ring)
  }
  .btn[aria-disabled="true"]{opacity:.6;pointer-events:none}

  .tabs{
    display:flex; gap:20px; align-items:center;
    border-bottom:1px solid #e5e7eb;
    margin:22px 0 8px;
  }
  .tab{padding:12px 0;font-weight:600;color:#a3aab6;text-decoration:none}
  .tab.active{color:#2563eb;position:relative}
  .tab.active::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:3px;background:#2563eb;border-radius:999px}

  .task{
    background:var(--card);
    border-radius:16px; box-shadow:var(--shadow);
    padding:14px; margin-top:10px
  }
  .task .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .task .code{font-weight:800;letter-spacing:.4px}
  .view{background:#1e40af;color:#fff;border:none;border-radius:12px;padding:10px 18px;font-weight:700;cursor:pointer}
  .row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eef1f5;color:#6b7280}
  .row:last-child{border-bottom:none}
  .ok{color:#059669;font-weight:700}
  .comm{color:#2563eb;font-weight:800}

  .banner, .today, .tabs, .task{ margin-left:0; margin-right:0; }

  html, body { overflow-x: hidden; }
  img, svg{ max-width:100%; height:auto; }

  @media (max-width: 360px){
    .cards .card .badge{ width:36px; height:36px; }
    .cards .card .badge svg{ width:20px; height:20px; }
    .tabs{ gap:14px; }
  }

  @media (min-width:520px){
    .wrap{ padding-left: clamp(14px, 4vw, 22px); padding-right: clamp(14px, 4vw, 22px); }
  }
}

/* ======================
   LIGHT desktop helpers (non-destructive)
   ====================== */
@media (min-width: 769px){
  .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
  .table-head{display:flex;align-items:center;justify-content:space-between}
  .desk-filter select{min-width:180px}
  .thead, .drow{display:grid;grid-template-columns:2.2fr 1.2fr .9fr 1fr .8fr 1.1fr;gap:14px;align-items:center}
  .thead{font-weight:700}
  .drow .status-dot{margin-right:.35rem}
}
</style>
{% endblock %}

{% block breadcrumb %}{% trans "Home / Task" %}{% endblock %}

{% block content %}

<!-- inline sprite -->

  <!-- Gift icon (stroke = currentColor) -->
 <!-- Hidden SVG sprite -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="i-gift" viewBox="0 0 17 20">
    <path d="M1.19922 8.70111H15.5992V16.5011C15.5992 17.2968 15.2831 18.0598 14.7205 18.6224C14.1579 19.185 13.3949 19.5011 12.5992 19.5011H4.19922C3.40357 19.5011 2.64051 19.185 2.0779 18.6224C1.51529 18.0598 1.19922 17.2968 1.19922 16.5011V8.70111Z" fill="url(#gift_paint0)"/>
    <path d="M15.6 5.10107H1.2C0.537258 5.10107 0 5.63833 0 6.30107V8.70107C0 9.36382 0.537258 9.90107 1.2 9.90107H15.6C16.2627 9.90107 16.8 9.36382 16.8 8.70107V6.30107C16.8 5.63833 16.2627 5.10107 15.6 5.10107Z" fill="url(#gift_paint1)"/>
    <path d="M7.5 19.5011V9.90106H9.3V19.5011H7.5Z" fill="#212121"/>
    <path d="M7.5 19.5011V9.90106H9.3V19.5011H7.5Z" fill="url(#gift_paint2)"/>
    <path d="M9.3 4.80109V9.90109H7.5V4.80109H9.3Z" fill="#212121"/>
    <path d="M9.3 4.80109V9.90109H7.5V4.80109H9.3Z" fill="url(#gift_paint3)"/>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.40077 1.03669L8.46797 0.967092C8.85254 0.582733 9.32612 0.299351 9.84662 0.142141C10.3671 -0.0150685 10.9184 -0.0412355 11.4514 0.0659668C11.9845 0.173169 12.4828 0.410419 12.902 0.756624C13.3213 1.10283 13.6485 1.54726 13.8546 2.05041C14.0606 2.55356 14.1392 3.09983 14.0833 3.64066C14.0273 4.18149 13.8386 4.70012 13.534 5.15045C13.2293 5.60077 12.818 5.96884 12.3368 6.22191C11.8556 6.47499 11.3193 6.60525 10.7756 6.60109C10.284 6.59897 9.79237 6.59857 9.30077 6.59989V6.60349L8.40077 6.60109L7.50077 6.60349V6.59989H6.02597C5.47803 6.60433 4.93761 6.47226 4.45348 6.2156C3.96936 5.95893 3.55676 5.58575 3.25294 5.12974C2.94912 4.67373 2.76363 4.14924 2.71322 3.6036C2.6628 3.05797 2.74905 2.50837 2.96418 2.00441C3.17931 1.50045 3.51655 1.058 3.94545 0.716973C4.37436 0.37595 4.88143 0.147097 5.4209 0.0510696C5.96038 -0.0449581 6.51528 -0.00513795 7.03551 0.166936C7.55575 0.33901 8.02495 0.637921 8.40077 1.03669Z" fill="url(#gift_paint4)"/>

    <defs>
      <linearGradient id="gift_paint0" x1="7.48002" y1="23.7455" x2="7.48002" y2="4.49511" gradientUnits="userSpaceOnUse">
        <stop stop-color="#007BFF"/><stop offset="0.348" stop-color="#0062CC"/><stop offset="1" stop-color="#003773"/>
      </linearGradient>
      <linearGradient id="gift_paint1" x1="-13.2374" y1="3.30107" x2="30.0374" y2="3.30107" gradientUnits="userSpaceOnUse">
        <stop offset="0.196" stop-color="#003773"/><stop offset="0.763" stop-color="#0062CC"/><stop offset="1" stop-color="#007BFF"/>
      </linearGradient>
      <linearGradient id="gift_paint2" x1="7.5" y1="4.50106" x2="7.5" y2="17.8319" gradientUnits="userSpaceOnUse">
        <stop stop-color="#CCAD3E"/><stop offset="1" stop-color="#FFD84D"/>
      </linearGradient>
      <linearGradient id="gift_paint3" x1="7.5" y1="-17.0557" x2="7.5" y2="18.6443" gradientUnits="userSpaceOnUse">
        <stop stop-color="#CCAD3E"/><stop offset="1" stop-color="#FFD84D"/>
      </linearGradient>
      <linearGradient id="gift_paint4" x1="11.5676" y1="6.60229" x2="8.15357" y2="-6.96971" gradientUnits="userSpaceOnUse">
        <stop stop-color="#CCAD3E"/><stop offset="1" stop-color="#FFD84D"/>
      </linearGradient>
    </defs>
  </symbol>
</svg>


<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="i-asset-total" viewBox="0 0 24 24"><path d="M13 5C13 6.10457 10.5376 7 7.5 7C4.46243 7 2 6.10457 2 5M13 5C13 3.89543 10.5376 3 7.5 3C4.46243 3 2 3.89543 2 5M13 5V9.45715C11.7785 9.82398 11 10.3789 11 11M2 5V17C2 18.1046 4.46243 19 7.5 19C8.82963 19 10.0491 18.8284 11 18.5429V11M2 9C2 10.1046 4.46243 11 7.5 11C8.82963 11 10.0491 10.8284 11 10.5429M2 13C2 14.1046 4.46243 15 7.5 15C8.82963 15 10.0491 14.8284 11 14.5429M22 11C22 12.1046 19.5376 13 16.5 13C13.4624 13 11 12.1046 11 11M22 11C22 9.89543 19.5376 9 16.5 9C13.4624 9 11 9.89543 11 11M22 11V19C22 20.1046 19.5376 21 16.5 21C13.4624 21 11 20.1046 11 19V11M22 15C22 16.1046 19.5376 17 16.5 17C13.4624 17 11 16.1046 11 15" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-asset" viewBox="0 0 24 24"><path d="M6.5 15.5L12.0002 18L17.5 15.5M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM6.5 11.5L12.0002 14L17.5 11.5L12.0002 5L6.5 11.5Z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></symbol>
  <symbol id="i-dividend" viewBox="0 0 24 24"><path d="M13.5295 8.35186C12.9571 8.75995 12.2566 9 11.5 9C9.567 9 8 7.433 8 5.5C8 3.567 9.567 2 11.5 2C12.753 2 13.8522 2.65842 14.4705 3.64814M6 20.0872H8.61029C8.95063 20.0872 9.28888 20.1277 9.61881 20.2086L12.3769 20.8789C12.9753 21.0247 13.5988 21.0388 14.2035 20.9214L17.253 20.3281C18.0585 20.1712 18.7996 19.7854 19.3803 19.2205L21.5379 17.1217C22.154 16.5234 22.154 15.5524 21.5379 14.9531C20.9832 14.4134 20.1047 14.3527 19.4771 14.8103L16.9626 16.6449C16.6025 16.9081 16.1643 17.0498 15.7137 17.0498H13.2855L14.8311 17.0498C15.7022 17.0498 16.4079 16.3633 16.4079 15.5159V15.2091C16.4079 14.5055 15.9156 13.892 15.2141 13.7219L12.8286 13.1417C12.4404 13.0476 12.0428 13 11.6431 13C10.6783 13 8.93189 13.7988 8.93189 13.7988L6 15.0249M20 6.5C20 8.433 18.433 10 16.5 10C14.567 10 13 8.433 13 6.5C13 4.567 14.567 3 16.5 3C18.433 3 20 4.567 20 6.5ZM2 14.6L2 20.4C2 20.9601 2 21.2401 2.10899 21.454C2.20487 21.6422 2.35785 21.7951 2.54601 21.891C2.75992 22 3.03995 22 3.6 22H4.4C4.96005 22 5.24008 22 5.45399 21.891C5.64215 21.7951 5.79513 21.6422 5.89101 21.454C6 21.2401 6 20.9601 6 20.4V14.6C6 14.0399 6 13.7599 5.89101 13.546C5.79513 13.3578 5.64215 13.2049 5.45399 13.109C5.24008 13 4.96005 13 4.4 13L3.6 13C3.03995 13 2.75992 13 2.54601 13.109C2.35785 13.2049 2.20487 13.3578 2.10899 13.546C2 13.7599 2 14.0399 2 14.6Z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></symbol>
</svg>

<div class="wrap">
  <!-- Stats -->
  <div class="cards">
    <div class="card">
      <div class="top"><span class="label">{% trans "Total Asset" %}</span><span class="badge"><svg><use href="#i-asset-total"/></svg></span></div>
      <div class="value">{{ total_asset_eur }}</div>
    </div>
    <div class="card">
      <div class="top"><span class="label">{% trans "Asset" %}</span><span class="badge"><svg><use href="#i-asset"/></svg></span></div>
      <div class="value">{{ asset_eur }}</div>
    </div>
    <div class="card">
      <div class="top"><span class="label">{% trans "Dividends" %}</span><span class="badge"><svg><use href="#i-dividend"/></svg></span></div>
      <div class="value">{{ dividends_eur }}</div>
    </div>
    <div class="card">
      <div class="top"><span class="label">{% trans "Processing" %}</span><span class="badge"><svg><use href="#i-settings"/></svg></span></div>
      <div class="value">{{ processing_eur }}</div>
    </div>
  </div>

  <!-- Banner + CTA -->
  <div class="banner">
    <h2>{% trans "Complete Tasks and get" %}<br/>{% trans "rewarded" %}</h2>
    <img class="hero-img" src="{% static 'meta_search/logos/task_reward.png' %}" alt="{% trans 'Banner Image' %}" />
  </div>
  <div class="today">{% trans "Order received today:" %} <strong>{{ next_visible }}/{{ limit }}</strong></div>

  <a id="getTaskBtn" class="btn" href="{% url 'do_task' %}"
     data-loader="{% trans 'Fetching your task…' %}"
     {% if not can_get_task %}aria-disabled="true"{% endif %}>
    {% trans "Click to get your task" %}
  </a>

  <!-- DESKTOP table -->
  <div class="desktop-only">
    <div class="table-head">
      <h3 class="th-title">{% trans "Task History" %}</h3>
      <form class="desk-filter" method="get">
        <label class="sr-only" for="statusFilter">{% trans "Filter status" %}</label>
        <select id="statusFilter" name="tab">
          <option value="all" {% if tab == 'all' %}selected{% endif %}>{% trans "All" %}</option>
          <option value="completed" {% if tab == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
          <option value="processing" {% if tab == 'processing' %}selected{% endif %}>{% trans "Processing" %}</option>
        </select>
        <noscript><button type="submit">{% trans "Apply" %}</button></noscript>
      </form>
    </div>

    <div class="thead">
      <div>{% trans "Product Name" %}</div><div>{% trans "Order ID" %}</div><div>{% trans "Date" %}</div>
      <div>{% trans "Price" %}</div><div>{% trans "Comm" %}</div><div>{% trans "Status" %}</div>
    </div>

    {% for t in tasks %}
      <div class="task drow">
        <div><strong>{{ t.template.hotel_name }}</strong>{% if t.template.description %}<div class="muted">{{ t.template.description }}</div>{% endif %}</div>
        <div>{{ t.template.task_id }}</div>
        <div>{{ t.created_at|date:"d/m/Y" }}</div>
        <div>€{{ t.price_used }}{% if t.quantity %}×{{ t.quantity }}{% endif %}</div>
        <div>+€{{ t.commission_used }}</div>
        <div>
          <span class="status-dot">●</span>{{ t.get_status_display }}
          &nbsp;&nbsp;
          <form method="get" action="{% url 'task_detail' pk=t.pk %}" style="display:inline">
            <button class="view" type="submit">{% trans "View" %}</button>
          </form>
        </div>
      </div>
    {% empty %}
      <div class="task drow"><div>{% trans "No tasks yet." %}</div><div></div><div></div><div></div><div></div><div></div></div>
    {% endfor %}
  </div>

  <!-- MOBILE list (wrapped so it won’t appear on desktop) -->
  <div class="mobile-only">
    <div class="tabs">
      <a class="tab {% if tab == 'all' %}active{% endif %}" href="?tab=all">{% trans "All" %}</a>
      <a class="tab {% if tab == 'completed' %}active{% endif %}" href="?tab=completed">{% trans "Completed" %}</a>
      <a class="tab {% if tab == 'processing' %}active{% endif %}" href="?tab=processing">{% trans "Processing" %}</a>
    </div>

    {% for t in tasks %}
      <div class="task">
        <div class="head">
          <div class="code">{{ t.template.task_id }}</div>
          <form method="get" action="{% url 'task_detail' pk=t.pk %}">
            <button class="view" type="submit">
              {% if t.status == t.Status.APPROVED %}{% trans "Approved" %}
              {% elif t.status == t.Status.SUBMITTED %}{% trans "Submitted" %}
              {% else %}{% trans "View" %}{% endif %}
            </button>
          </form>
        </div>
        <div class="row"><span>{% trans "Product" %}</span><span>{{ t.template.hotel_name }}</span></div>
        <div class="row"><span>{% trans "Price" %}</span><span>€{{ t.price_used }}</span></div>
        <div class="row"><span>{% trans "Status" %}</span><span class="{% if t.status == t.Status.APPROVED %}ok{% endif %}">● {{ t.get_status_display }}</span></div>
        <div class="row"><span>{% trans "Comm" %}</span><span class="comm">+€{{ t.commission_used }}</span></div>
      </div>
    {% empty %}
      <p style="color:#6b7280;margin-top:10px;">{% trans "No tasks yet." %}</p>
    {% endfor %}
  </div>
</div>

<!-- Overlays -->
<div class="loader-overlay" id="appLoader" role="status" aria-live="polite" aria-hidden="true">
  <div class="loader-card" aria-busy="true">
    <div class="loader-dots" aria-hidden="true">
      <span class="loader-dot"></span><span class="loader-dot"></span>
      <span class="loader-dot"></span><span class="loader-dot"></span>
    </div>
    <div class="loader-text" id="loaderText">{% trans "Loading…" %}</div>
    <div class="loader-sub" id="loaderSub">{% trans "Please wait a moment" %}</div>
  </div>
</div>

<div id="blockData"
     data-next="{{ next_visible|default:0 }}"
     data-limit="{{ limit|default:0 }}"
     data-can="{% if can_get_task %}1{% else %}0{% endif %}"
     data-support-url="https://t.me/Internal_CSAgent"></div>

<div class="limit-overlay" id="limitModal" aria-hidden="true">
  <div class="limit-card" role="dialog" aria-modal="true" aria-labelledby="limitTitle" aria-describedby="limitText">
    <div class="limit-top">
      <div class="limit-x">×</div>
      <button class="limit-close" type="button" aria-label="{% trans 'Close' %}">✕</button>
    </div>
    <div class="limit-body">
      <div class="limit-title" id="limitTitle">{% trans "Oh No!" %}</div>
      <p class="limit-text" id="limitText">
        {% blocktrans %}You have completed <strong id="completedCount">0</strong> orders.<br>Please contact customer service for assistance.{% endblocktrans %}
      </p>
      <button class="limit-btn" type="button" id="supportBtn">{% trans "Customer care" %}</button>
    </div>
  </div>
</div>

{# ===== 5b fortune: server JSON (kept exactly as you had it) ===== #}
{% if fortune %}
<script id="fortune-data" type="application/json">
  {"grant_id": {{ fortune.grant_id }}, "mode": "{{ fortune.mode }}", "amount_cents": {{ fortune.amount_cents }}, "price_cents": {{ fortune.price_cents }} }
</script>
{% endif %}

{# ===== 5b fortune: CSS + HTML moved INSIDE content block so it renders ===== #}
<style>

#fortune-intro .box .gift{
  width:56px; height:56px; display:block;
  color:#000 !important;          /* force black */
  background:transparent !important;
}
#fortune-intro .box .gift *{
  fill:currentColor !important;   /* ensure it follows color */
  stroke:currentColor !important; /* safe for stroke icons too */
  background:transparent !important;
}

/* begining of background */
/* Make the gift icon outline-only (no fill) */
#fortune-intro .box .gift,
#fortune-intro .box .gift *{
  background: transparent !important;
  fill: none !important;               /* kill all fills (removes the “background”) */
  stroke: currentColor !important;      /* outline uses the text color */
  stroke-width: 1.6px !important;
  stroke-linecap: round !important;
  stroke-linejoin: round !important;
}

#fortune-intro .box {
  background: transparent !important;   /* kill white background */
  border: none;                         /* remove border if any */
  padding: 0;                           /* tighten spacing */
}

#fortune-intro .box .gift{
  width:56px; height:56px;
  background:transparent !important;
}



/* end of fix background */

#fortune-intro .box{ gap:10px; }

#fortune-intro,#fortune-result{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
#fortune-intro[hidden],#fortune-result[hidden]{display:none}
#fortune-intro .bg,#fortune-result .bg{position:absolute;inset:0;background:rgba(0,0,0,.45)}
#fortune-intro .card{position:relative;width:min(560px,94vw);background:#0f55a6;color:#fff;border-radius:18px;box-shadow:0 18px 60px rgba(2,6,23,.35);padding:22px 18px 28px;text-align:center;overflow:hidden}
#fortune-intro .title{margin-top:40px;font-size:26px;font-weight:800}
#fortune-intro .boxes{margin:22px auto 6px;display:grid;grid-template-columns:repeat(3,1fr);gap:26px;width:min(460px,92%)}
#fortune-intro .box{display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer}
#fortune-intro .q{font:900 26px/1 Poppins,system-ui;color:#fff}
#fortune-result .card{position:relative;width:min(560px,94vw);background:#fff;border-radius:18px;box-shadow:0 24px 60px rgba(2,6,23,.28);overflow:hidden;text-align:center}
#fortune-result .head{background:#16a34a;color:#fff;padding:22px 16px}
#fortune-result .head.golden{background:#0f55a6}
#fortune-result .title{margin:0;font-size:24px;font-weight:800}
#fortune-result .body{padding:22px 18px}
#fortune-result .note{color:#1b1b1b;margin:18px 0;font-size:20px;line-height:1.35}
#fortune-result .btn{display:block;width:86%;margin:0 auto 14px;padding:14px 16px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
#fortune-result .btn.primary{background:#16a34a;color:#fff}
#fortune-result .btn.secondary{background:#0f55a6;color:#fff}
.close-x{position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:999px;border:0;background:#111827;color:#fff;cursor:pointer}
</style>

<div id="fortune-intro" hidden>
  <div class="bg"></div>
  <div class="card" role="dialog" aria-modal="true">
    <button class="close-x" type="button">×</button>
    <h3 class="title">Extra Surprise</h3>
    <div class="boxes">
      <button class="box" data-box="1"><img src="{% static 'meta_search/images/gift.png' %}" alt="Gift" class="gift"/><span class="q">?</span></button>
      <button class="box" data-box="2"><img src="{% static 'meta_search/images/gift.png' %}" alt="Gift" class="gift"/><span class="q">?</span></button>
      <button class="box" data-box="3"><img src="{% static 'meta_search/images/gift.png' %}" alt="Gift" class="gift"/><span class="q">?</span></button>
      <!--<button class="box" data-box="3"><svg class="gift" aria-hidden="true"><use href="#i-gift"/></svg><span class="q">?</span></button>-->
    </div>
    <p class="sub">Pick a magic reward that belongs to you</p>
  </div>
</div>

<div id="fortune-result" hidden>
  <div class="bg"></div>
  <div class="card" role="dialog" aria-modal="true">
    <button class="close-x" type="button">×</button>
    <div class="head"><h3 class="title">Notice</h3></div>
    <div class="body">
      <p class="note">You have Obtained <span id="fr-amount">€0</span><br/>Reward</p>
      <button class="btn primary" id="fr-confirm">Receive</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}

<script>
document.getElementById('supportBtn')?.addEventListener('click',()=>window.open(document.getElementById('blockData')?.dataset.supportUrl,'_blank','noopener'));
</script>

<script>
  // Auto-submit desktop filter
  (function(){
    const f=document.querySelector('.desk-filter'); const s=f?.querySelector('select');
    s&&s.addEventListener('change',()=>f.submit());
  })();

  // Loader
  (function(){
    const overlay=document.getElementById('appLoader');
    const textEl=document.getElementById('loaderText');
    const subEl=document.getElementById('loaderSub');
    const btn=document.getElementById('getTaskBtn');
    function showLoader(msg,sub){
      if(!overlay) return;
      if(msg) textEl.textContent=msg;
      subEl.textContent=sub||'{% trans "Please wait a moment" %}';
      overlay.classList.add('on'); overlay.removeAttribute('aria-hidden');
    }
    function hideLoader(){ overlay?.classList.remove('on'); overlay?.setAttribute('aria-hidden','true'); }
    btn?.addEventListener('click',function(e){
      if(this.getAttribute('aria-disabled')==='true'){ e.preventDefault(); return; }
      showLoader(this.dataset.loader||'{% trans "Loading…" %}');
    });
    window.addEventListener('pageshow',e=>{ if(e.persisted) hideLoader(); });
  })();

  // Limit modal
  (function(){
    const dataEl=document.getElementById('blockData');
    const modal=document.getElementById('limitModal');
    const closeBtn=modal?.querySelector('.limit-close');
    const supportBtn=document.getElementById('supportBtn');
    const out=document.getElementById('completedCount');

    function open(c){ if(!modal) return; if(out) out.textContent=String(c); modal.classList.add('on'); modal.removeAttribute('aria-hidden'); }
    function close(){ modal?.classList.remove('on'); modal?.setAttribute('aria-hidden','true'); }
    closeBtn?.addEventListener('click',close);
    modal?.addEventListener('click',e=>{ if(e.target===modal) close(); });
    supportBtn?.addEventListener('click',()=>{ location.href=dataEl?.dataset.supportUrl||'#'; });

    const next=parseInt(dataEl?.dataset.next||'0',10);
    const limit=parseInt(dataEl?.dataset.limit||'0',10);
    const can=(dataEl?.dataset.can==='1');
    const completed=Math.max(0,next-1);

    try{
      const displayCompleted=(isFinite(limit)&&limit>0)?Math.min(completed,limit):completed;
      const todayCounter=document.querySelector('.today strong');
      if(todayCounter){ todayCounter.textContent=`${displayCompleted}/${limit}`; }
    }catch(e){}

    if(!can && limit>0 && completed>=limit){
      requestAnimationFrame(()=>open(completed));
    }
  })();
</script>

{# ===== 5b fortune: JS (unchanged, just placed inside extra_scripts) ===== #}

<!-- user_task_dashboard.html (replace ONLY the cash-branch onclick to handle errors & refresh) -->
<script>
(function(){
  let data = null;
  const blob = document.getElementById('fortune-data');
  if (blob) { try { data = JSON.parse(blob.textContent); } catch(e){} }

  if (!data) {
    const qs = new URLSearchParams(location.search);
    const force = qs.get('force_fortune');
    if (force) {
      const [kindRaw, amtRaw] = force.split(':');
      const kind = (kindRaw||'').toLowerCase();
      const amount = parseInt(amtRaw||'', 10);
      if (kind === 'cash')   data = { grant_id:0, mode:'cash',   amount_cents:(isFinite(amount)?amount:2)*100,   price_cents:0 };
      if (kind === 'golden') data = { grant_id:0, mode:'golden', amount_cents:0,                                 price_cents:(isFinite(amount)?amount:100)*100 };
    }
  }
  if (!data) return;

  const csrftoken = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1];
  const intro = document.getElementById('fortune-intro');
  const result = document.getElementById('fortune-result');
  const head = result.querySelector('.head');
  const title = result.querySelector('.title');
  const amountEl = document.getElementById('fr-amount');
  const btn = document.getElementById('fr-confirm');

  function fmtEUR(c){ return '€' + (c/100).toLocaleString(undefined,{minimumFractionDigits:0}); }
  function reloadSoon(){ setTimeout(()=>location.reload(), 300); }

  intro.hidden = false;

  intro.querySelector('.close-x').addEventListener('click', ()=> intro.hidden = true);
  intro.addEventListener('click', (e)=>{ if(e.target.classList.contains('bg')) intro.hidden = true; });

  intro.querySelectorAll('.box').forEach(el=>{
    el.addEventListener('click', ()=>{
      const picked = el.dataset.box;
      intro.hidden = true;

      if(data.mode === 'cash'){
        head.classList.remove('golden');
        title.textContent = 'Notice';
        amountEl.textContent = fmtEUR(data.amount_cents);
        btn.textContent = 'Receive';
        btn.onclick = async ()=>{
          if (data.grant_id === 0) { result.hidden = true; return; } // demo mode
          btn.disabled = true;
          try{
            const res = await fetch(`{% url 'fortune_receive' pk=0 %}`.replace('/0/','/'+data.grant_id+'/'), {
              method:'POST',
              headers:{'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
              body: new URLSearchParams({box: picked})
            });
            if(!res.ok){
              const t = await res.text();
              alert('Could not credit reward. Try again.\n' + t.slice(0,140));
            }else{
              reloadSoon();
            }
          }catch(err){
            alert('Network error. Please try again.');
          }finally{
            btn.disabled = false;
            result.hidden = true;
          }
        };
      } else {
        head.classList.add('golden');
        title.textContent = 'Golden Order Unlocked';
        result.querySelector('.body').innerHTML =
          `<p class="note">Congratulations you have received a golden reward click to claim</p>
           {% comment %}<p style="margin:8px 0 16px;color:#111;font-weight:700;">Task Value: ${fmtEUR(data.price_cents)}</p>{% endcomment %}
           <button class="btn secondary" id="fr-open">Receive</button>`;
        result.querySelector('#fr-open').onclick = async ()=>{
          if (data.grant_id === 0) { result.hidden = true; return; } // demo mode
          try{
            const res = await fetch(`{% url 'fortune_open' pk=0 %}`.replace('/0/','/'+data.grant_id+'/'), {
              method:'POST',
              headers:{'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded'},
              body: new URLSearchParams({box: picked})
            });
            if(res.ok){
              const json = await res.json();
              if(json.redirect) location.href = json.redirect; else reloadSoon();
            }else{
              const t = await res.text();
              alert('Could not open golden task.\n' + t.slice(0,140));
            }
          }catch(err){
            alert('Network error. Please try again.');
          }finally{
            result.hidden = true;
          }
        };
      }

      result.hidden = false;
    });
  });

  result.querySelector('.close-x').addEventListener('click', ()=> result.hidden = true);
  result.addEventListener('click', (e)=>{ if(e.target.classList.contains('bg')) result.hidden = true; });
})();
</script>

{% endblock %}
